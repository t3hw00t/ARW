<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agent Hub (ARW) Launcher</title>
  </head>
  <body>
    <link rel="stylesheet" href="common.css" />
    <link rel="stylesheet" href="index.css" />
    <script src="common.js" defer></script>
    <div class="wrap">
      <div class="card">
        <h2>Agent Hub (ARW) Launcher <span class="badge"><span class="dot" id="svc-dot"></span><span id="svc-text">unknown</span></span></h2>
        <p>Use the tray to start/stop the service or open the Debug UI.</p>
        <div class="row">
          <label>Port: <input id="port" type="number" min="1" max="65535" value="8090"/></label>
          <label><input id="autostart" type="checkbox"/> Autostart service</label>
          <label><input id="notif" type="checkbox" checked/> Notify on status change</label>
          <label><input id="loginstart" type="checkbox"/> Start launcher at login</label>
        </div>
        <div class="row">
          <button id="btn-save" class="ghost">Save</button>
          <button id="btn-start" class="primary">Start Service</button>
          <button id="btn-stop" class="ghost">Stop Service</button>
          <button id="btn-open" class="primary">Open Debug UI</button>
          <button id="btn-open-window" class="ghost">Open in Window</button>
          <button id="btn-events" class="ghost">Events Window</button>
          <button id="btn-logs" class="ghost">Logs</button>
          <button id="btn-models" class="ghost">Models</button>
          <button id="btn-connections">Connections</button>
          <button id="btn-health">Check Health</button>
          <span id="health"></span>
        </div>
        <div class="row">
          <button id="btn-updates">Check Updates</button>
        </div>
        <div class="row" id="dlmini"></div>
      </div>
    </div>
    <script src="index.js" defer></script>
      // The window.__TAURI__ API is available without bundlers in Tauri 1.
      const invoke = (cmd, args) => ARW.invoke(cmd, args)
      const getPort = () => ARW.getPortFromInput('port')
      async function loadPrefs() {
        try {
          const v = await ARW.getPrefs('launcher');
          if (v && typeof v === 'object') {
            if (v.port) document.getElementById('port').value = v.port;
            if (typeof v.autostart === 'boolean') document.getElementById('autostart').checked = v.autostart;
            if (typeof v.notifyOnStatus === 'boolean') document.getElementById('notif').checked = v.notifyOnStatus;
          }
        } catch {}
        try {
          const enabled = await invoke('launcher_autostart_status');
          document.getElementById('loginstart').checked = !!enabled;
        } catch {}
      }
      async function savePrefs() {
        const port = getPort();
        const autostart = document.getElementById('autostart').checked;
        const notifyOnStatus = document.getElementById('notif').checked;
        await ARW.setPrefs('launcher', { port, autostart, notifyOnStatus });
      }
      document.getElementById('btn-open').addEventListener('click', async () => {
        try { await invoke('open_debug_ui', { port: getPort() }); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-health').addEventListener('click', async () => {
        const el = document.getElementById('health');
        el.textContent = '…';
        try {
          const ok = await invoke('check_service_health', { port: getPort() });
          el.textContent = ok ? 'Service UP' : 'Service DOWN';
          el.className = ok ? 'ok' : 'bad';
        } catch (e) {
          el.textContent = 'Error';
          el.className = 'bad';
        }
      });
      async function pollHealth(){
        const dot = document.getElementById('svc-dot');
        const txt = document.getElementById('svc-text');
        const start = document.getElementById('btn-start');
        const stop = document.getElementById('btn-stop');
        try{
          const up = await invoke('check_service_health', { port: getPort() });
          txt.textContent = up ? 'online' : 'offline';
          dot.className = 'dot ' + (up?'ok':'bad');
          if (start) start.disabled = up; if (stop) stop.disabled = !up;
        }catch{
          txt.textContent = 'unknown'; dot.className = 'dot';
          if (start) start.disabled = false; if (stop) stop.disabled = true;
        }
      }
      setInterval(pollHealth, 3000);
      pollHealth();
      // Mini downloads widget (models.*)
      (function(){
        try{
          const box = document.getElementById('dlmini'); if(!box) return;
          const last = {};
          const es = new EventSource(ARW.base(getPort()) + '/events?prefix=models.');
          const mk = (id)=>{ let el = document.getElementById('dl_'+id); if(!el){ el = document.createElement('div'); el.id='dl_'+id; el.className='badge'; el.style.marginTop='6px'; box.appendChild(el); } return el; };
          es.addEventListener('models.download.progress', (ev)=>{
            try{
              const j = JSON.parse(ev.data||'{}'); const id = j.id||''; if(!id) return; const el = mk(id);
              if(j.status==='complete'){ el.className='badge'; el.innerHTML = '<span class="dot"></span> '+id+' complete'; setTimeout(()=>{ if(el&&el.parentNode) el.parentNode.removeChild(el); }, 1500); return; }
              if(j.error || j.code){ el.className='badge'; el.innerHTML = '<span class="dot bad"></span> '+id+' '+(j.code||'error'); return; }
              const pct = j.progress!=null? (j.progress+'%') : (j.status||'…');
              // speed estimate
              const now = Date.now(); let tail=''; const prev=last[id]; last[id] = { t: now, b: (j.downloaded||0) };
              if (prev && j.downloaded>=prev.b){ const dt=(now-prev.t)/1000; const db=j.downloaded-prev.b; const mbps = db/(1024*1024)/Math.max(0.001,dt); if(mbps>0.05) tail = ' · '+mbps.toFixed(2)+' MiB/s'; }
              el.className='badge'; el.innerHTML = '<span class="dot"></span> '+id+' '+pct+tail;
            }catch{}
          });
        }catch{}
      })();
      document.getElementById('btn-open-window').addEventListener('click', async () => {
        try { await invoke('open_debug_window', { port: getPort() }); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-events').addEventListener('click', async () => {
        try { await invoke('open_events_window'); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-logs').addEventListener('click', async () => {
        try { await invoke('open_logs_window'); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-models').addEventListener('click', async () => {
        try { await invoke('open_models_window'); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-connections').addEventListener('click', async () => {
        try { await invoke('open_connections_window'); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-start').addEventListener('click', async () => {
        try { await invoke('start_service', { port: getPort() }); ARW.toast('Service starting'); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-stop').addEventListener('click', async () => {
        try { await invoke('stop_service', { port: getPort() }); ARW.toast('Service stop requested'); } catch (e) { console.error(e); }
      });
      document.getElementById('btn-save').addEventListener('click', async () => {
        try {
          await savePrefs(); ARW.toast('Preferences saved');
          const loginstart = document.getElementById('loginstart').checked;
          await invoke('set_launcher_autostart', { enabled: loginstart });
        } catch (e) { console.error(e); }
      });
      document.getElementById('btn-updates').addEventListener('click', async () => {
        try {
          // Fallback to releases page; real updater config can be added later
          await invoke('open_url', { url: 'https://github.com/t3hw00t/ARW/releases' });
        } catch (e) { console.error(e); }
      });
    
  </body>
  </html>
