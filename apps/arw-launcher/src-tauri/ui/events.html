<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ARW Events</title>
    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }
      .toolbar { display: flex; gap: 8px; padding: 8px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: #fafafa; }
      #log { padding: 8px; overflow: auto; height: calc(100% - 44px); }
      .e { margin: 0 0 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      .dim { color: #666; }
    </style>
  </head>
  <body>
    <script src="common.js"></script>
    <div class="toolbar">
      <label>Port: <input id="port" type="number" min="1" max="65535" value="8090" style="width: 90px"></label>
      <label>Filter: <input id="filter" type="text" placeholder="e.g. Models.*"></label>
      <button id="btn-replay">Replay 50</button>
      <span id="stat" class="dim">SSE: off</span>
    </div>
    <div id="log"></div>
    <script>
      let es = null;
      const base = (port) => ARW.base(port)
      function add(type, payload) {
        const el = document.createElement('div');
        el.className = 'e';
        const ts = new Date().toISOString();
        el.innerHTML = `<div class="dim">${ts} <b>${type||'message'}</b></div><pre>${payload}</pre>`;
        const log = document.getElementById('log');
        log.prepend(el);
        while (log.childElementCount > 300) log.removeChild(log.lastChild);
      }
      function sse(replay) {
        const port = ARW.getPortFromInput('port') || 8090;
        let url = ARW.base(port) + '/events';
        const filter = document.getElementById('filter').value.trim();
        const params = new URLSearchParams();
        if (replay) params.set('replay', replay);
        if (filter) params.set('prefixes', filter);
        if ([...params.keys()].length) url += '?' + params.toString();
        if (es) { es.close(); es = null; }
        es = new EventSource(url);
        es.onopen = () => document.getElementById('stat').textContent = 'SSE: on';
        es.onerror = () => document.getElementById('stat').textContent = 'SSE: off';
        es.onmessage = ev => add(null, ev.data);
      }
      document.getElementById('btn-replay').addEventListener('click', ()=> sse(50));
      // load prefs if present
      (async () => { await ARW.applyPortFromPrefs('port'); sse(0) })();
    </script>
  </body>
  </html>
