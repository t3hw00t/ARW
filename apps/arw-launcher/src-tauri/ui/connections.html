<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ARW Connection Manager</title>
    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }
      .wrap { padding: 16px; display: grid; gap: 16px; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 6px 8px; text-align: left; }
      th { color: #555; font-weight: 600; }
      .dim { color: #666; }
      .ok { color: #0a0; }
      .bad { color: #a00; }
      input[type=text], input[type=url] { padding: 6px 8px; border: 1px solid #ccc; border-radius: 8px; }
      button { padding: 8px 12px; border: 1px solid #aaa; border-radius: 8px; background: #fafafa; cursor: pointer; }
      button:hover { background: #f0f0f0; }
    </style>
  </head>
  <body>
    <script src="common.js"></script>
    <div class="wrap">
      <div class="row">
        <input id="cname" type="text" placeholder="name" style="width: 180px">
        <input id="curl" type="url" placeholder="http://127.0.0.1:8090" style="width: 280px">
        <button id="btn-add">Add</button>
        <button id="btn-save">Save</button>
        <span id="stat" class="dim"></span>
      </div>
      <div>
        <table>
          <thead>
            <tr><th>Name</th><th>Base URL</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
    <script>
      const invoke = (cmd, args) => ARW.invoke(cmd, args)
      function load(){ return ARW.getPrefs('launcher').then(v => (v&&v.connections)||[]) }
      async function save(conns){ const v = await ARW.getPrefs('launcher')||{}; v.connections = conns; await ARW.setPrefs('launcher', v) }
      async function refresh(){
        const rows = document.getElementById('rows'); rows.innerHTML='';
        const conns = await load();
        conns.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${c.name||''}</td><td>${c.base||''}</td><td data-st class="dim">…</td><td>
            <button data-open>Open Debug</button>
            <button data-ping>Ping</button>
            <button data-del>Delete</button>
          </td>`;
          tr.querySelector('[data-open]').addEventListener('click', async ()=>{ try{ await invoke('open_url', { url: (c.base||'').replace(/\/$/,'') + '/debug' }); }catch(e){} });
          tr.querySelector('[data-ping]').addEventListener('click', async ()=>{ await pingRow(tr, c) });
          tr.querySelector('[data-del]').addEventListener('click', async ()=>{ const cc = (await load()).filter(x => x.name !== c.name); await save(cc); refresh(); });
          rows.appendChild(tr);
          // initial ping
          pingRow(tr, c);
        });
      }
      async function pingRow(tr, c){
        const st = tr.querySelector('[data-st]'); if (st) st.textContent = '…';
        try{
          const url = (c.base||'').replace(/\/$/,'') + '/healthz';
          const r = await fetch(url, { method: 'GET' });
          if (r.ok) { st.textContent = 'online'; st.className='ok'; }
          else { st.textContent = 'error'; st.className='bad'; }
        }catch(e){ if (st) { st.textContent = 'offline'; st.className='bad'; } }
      }
      document.getElementById('btn-add').addEventListener('click', async ()=>{
        const name = document.getElementById('cname').value.trim();
        const base = document.getElementById('curl').value.trim();
        if (!name || !base) return;
        const conns = await load();
        if (!conns.find(x => x.name === name)) conns.push({ name, base });
        await save(conns); document.getElementById('stat').textContent = 'Saved'; refresh();
      });
      document.getElementById('btn-save').addEventListener('click', async ()=>{
        const conns = await load(); await save(conns); document.getElementById('stat').textContent = 'Saved';
      });
      (async ()=>{ await refresh(); setInterval(refresh, 10000) })();
    </script>
  </body>
  </html>
