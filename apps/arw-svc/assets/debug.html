<!doctype html><html lang="en">
<head>
  <meta charset="utf-8">
  <title>ARW Debug</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      color-scheme:light dark;
      --bg:#fafaf9;           /* panel bg */
      --ink:#111827;          /* primary text */
      --muted:#6b7280;        /* secondary text */
      --line:#e5e7eb;         /* separators */
      --accent:#b87333;       /* subtle copper accent */
      --neon:#1bb3a3;         /* cyberdeck teal (muted) */
      --ok:#22c55e;           /* status ok */
      --warn:#f59e0b;         /* status warn */
      --bad:#ef4444;          /* status bad */
      --noise:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='table' tableValues='0 0.04'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      /* spacing rhythm */
      --sp2: 8px; --sp3: 12px; --sp4: 16px; --sp5: 24px;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:20px;line-height:1.45;color:var(--ink);background: radial-gradient(1000px 500px at 15% -10%, #ffffff, #f7f7f9 55%, #f1f5f9)}
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px;position:sticky;top:0;background:rgba(255,255,255,0.7);backdrop-filter:saturate(140%) blur(6px);padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.06)}
    code,pre{background:#0b0b0c10;padding:2px 4px;border-radius:4px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    button,input,select,textarea{font:inherit}
    button{padding:8px 12px;border:1px solid #cfd6de;background-image:linear-gradient(180deg,#ffffff,#f3f4f6), var(--noise);background-blend-mode:overlay,normal;border-radius:8px;cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,0.9) inset, 0 8px 18px rgba(0,0,0,0.06);transition:transform .06s ease, box-shadow .12s ease}
    button:hover{transform:translateY(-0.5px);box-shadow:0 1px 0 rgba(255,255,255,0.95) inset, 0 14px 28px rgba(0,0,0,0.08)}
    .iconbtn{padding:6px 8px;font-size:12px}
    .cols{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px}
    .box{border:1px solid var(--line);border-radius:12px;padding:12px;background:linear-gradient(180deg,#ffffff,#fafafa);box-shadow:0 12px 30px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.65);position:relative}
    .box>h3{margin:4px 0 8px 0; cursor:pointer; display:flex; align-items:center; gap:8px}
    .box>h3::after{ content:"▾"; font-size:12px; color:#6b7280 }
    .box[data-collapsed="1"]>h3::after{ content:"▸" }
    .box[data-collapsed="1"]>:not(h3){ display:none }
    .box::before{content:"";position:absolute;inset:0;pointer-events:none;background-image:var(--noise);opacity:.5;border-radius:12px}
    #log{max-height:40vh;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:linear-gradient(180deg,#ffffff,#fafafa);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
    .evt{padding:4px 6px;border-bottom:1px dashed #eee;font-family:ui-monospace,Menlo,Consolas,monospace}
    .key{color:var(--muted)}
    textarea{width:100%;min-height:100px}
    .pass{color:var(--ok)}.fail{color:var(--bad)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid var(--line);background-image:linear-gradient(180deg,#ffffff,#f6f7f9), var(--noise);background-blend-mode:overlay,normal}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
    .good{color:#166534;border-color:#bbf7d0;background:#ecfdf5}
    .good .dot{background:var(--ok)}
    .warn{color:#854d0e;border-color:#fde68a;background:#fefce8}
    .warn .dot{background:var(--warn)}
    .bad{color:#991b1b;border-color:#fecaca;background:#fef2f2}
    .bad .dot{background:var(--bad)}
    /* Iconography */
    .icons{ display:inline-flex; gap:6px; align-items:center; margin-right:6px }
    .ico{ width:14px; height:14px; display:inline-block; vertical-align:-2px; color:currentColor; opacity:.9 }
    .ico.ok{ color:#22c55e }
    .ico.warn{ color:#f59e0b }
    .ico.bad{ color:#ef4444 }
    .ico.info{ color:#6b7280 }
    .ico.accent{ color: var(--neon) }
    a.help{display:inline-block;margin-left:8px;width:18px;height:18px;border-radius:50%;border:1px solid #d1d5db;color:#6b7280;text-align:center;line-height:16px;text-decoration:none;font-weight:600;font-size:12px}
    a.help:hover{background:#f3f4f6;color:#374151}
    .tip{position:fixed;z-index:50;max-width:360px;background:#ffffff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 16px 40px rgba(0,0,0,0.14);padding:10px 12px}
    .tip .t-title{font-weight:600;margin-bottom:4px}
    .tip .t-more{color:#2563eb;text-decoration:none}
    .t-hidden{display:none}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:8px 12px;border-radius:10px;display:none;max-width:70vw;box-shadow:0 16px 40px rgba(0,0,0,0.14)}
    #insights{position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,0.12);padding:10px 12px;display:none;min-width:260px;max-width:50vw}
    #insights .kv{display:flex;justify-content:space-between;color:#374151}
    #insights h4{margin:4px 0 6px 0;font-size:14px}
    .palette{position:fixed;inset:0;background:rgba(0,0,0,0.2);display:none;align-items:flex-start;justify-content:center;padding-top:10vh}
    .pal-box{background:#fff;color:#111;width:min(680px,90vw);border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 20px 50px rgba(0,0,0,0.15);overflow:hidden}
    .pal-box input{width:100%;padding:10px 12px;border:none;outline:none;font:inherit}
    .pal-list{max-height:50vh;overflow:auto}
    .pal-item{padding:8px 12px;border-top:1px solid #f1f5f9;cursor:pointer;display:flex;justify-content:space-between}
    .pal-item.sel{background:#eef2ff}
    .pal-item .hint{color:#6b7280;font-size:12px}
    @media (max-width:900px){ .cols{grid-template-columns:1fr} }
    @media (pointer: coarse){ button{ padding:12px 16px } .iconbtn{ padding:10px 12px; font-size:14px } }
    button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{ outline:2px solid rgba(184,115,51,0.55); outline-offset:2px }
    @media (prefers-reduced-motion: reduce){ *{ transition:none !important; animation:none !important } }
    @media (prefers-color-scheme: dark){
      body{ background: radial-gradient(1000px 500px at 15% -10%, #0f1117, #0b0d12 55%, #090b10) }
      header{ background: rgba(16,18,24,0.7); border-color:#1f232a; box-shadow:0 10px 24px rgba(0,0,0,0.35) }
      .box{ background: linear-gradient(180deg,#12161f,#0f141a); border-color:#1f232a; box-shadow: 0 12px 30px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.06) }
      .box::before{ opacity: .25 }
      #log{ background: linear-gradient(180deg,#12161f,#0f141a); border-color:#1f232a; box-shadow: inset 0 1px 0 rgba(255,255,255,0.06) }
      .tip{ background:#0f141a; border-color:#1f232a; box-shadow:0 16px 40px rgba(0,0,0,0.6) }
      .toast{ background:#1f2937; color:#e5e7eb; border-color:#374151 }
      #insights{ background:#0f141a; border-color:#1f232a; box-shadow:0 18px 48px rgba(0,0,0,0.6) }
    }
    /* Compact density override */
    body.density-compact .row{ gap:6px; margin:6px 0 }
    body.density-compact header{ gap:10px; padding:6px 10px }
    body.density-compact .cols{ gap:12px }
    body.density-compact .box{ padding:10px; border-radius:10px }
    body.density-compact .iconbtn{ padding:6px 8px }
  </style>
</head>
<body>
  <header>
    <h1>ARW Debug</h1>
    <span class="key">port</span><code id="port"></code>
    <span id="adminBadge" class="badge warn" title="Administrative endpoints are locked"><span class="dot"></span> Admin: off</span>
    <span id="sseBadge" class="badge bad" title="SSE connection to /events"><span class="dot"></span> SSE: off</span>
    <span id="chatBadge" class="badge warn" title="Chat backend"><span class="dot"></span> Chat: synthetic</span>
    <span id="toolsBadge" class="badge warn" title="Tools activity"><span class="dot"></span> Tools: idle</span>
    <span id="eventsBadge" class="badge warn" title="Events activity"><span class="dot"></span> Events: 0</span>
    <span id="modelsBadge" class="badge warn" title="Models activity"><span class="dot"></span> Models: idle</span>
    <a id="metricsLink" class="help" href="#" title="Open /metrics" style="display:inline-block">M</a>
    <button class="iconbtn" id="btnExpandAll" title="Expand all">Expand</button>
    <button class="iconbtn" id="btnCollapseAll" title="Collapse all">Collapse</button>
    <button class="iconbtn" id="btnDensity" title="Toggle density">Density</button>
    <span id="memBadge" class="badge good" title="Memory usage"><span class="dot"></span> Mem: –</span>
    <span id="govBadge" class="badge good" title="Governor profile"><span class="dot"></span> Gov: –</span>
    <button id="chatTestBtn" class="iconbtn" title="Test chat backend">Test</button>
    <input id="adminToken" placeholder="token" style="width: 120px;" title="X-ARW-Admin header">
    <button id="useTok" class="iconbtn" title="Use admin token">Use</button>
    <label class="key" title="Remember token locally"><input type="checkbox" id="rememberTok"> remember</label>
    <button id="openPalette" class="iconbtn" title="Command palette (Ctrl/Cmd+K)">Palette</button>
    <label class="key">profile</label>
    <select id="hdrProfile" title="Governor profile">
      <option value="performance">performance</option>
      <option value="balanced" selected>balanced</option>
      <option value="power-saver">power-saver</option>
    </select>
    <button id="openShortcuts" class="iconbtn" title="Show shortcuts (Ctrl+/)">Shortcuts</button>
    <label class="key" title="Enable keyboard shortcuts"><input type="checkbox" id="shortcutsToggle" checked> shortcuts</label>
    <a id="docsLink" class="help" title="Open docs" href="#" target="_blank" style="margin-left:auto;display:none">?</a>
    <a id="secLink" class="help" data-doc="security" data-tip="Hardening guidance and recommended deployment settings." title="Security hardening" href="#" style="display:inline-block">!</a>
    <button id="toggleInsights" class="iconbtn" title="Insights" style="display:inline-block">Insights</button>
    <button id="copyStatsBtn" class="iconbtn" title="Copy stats JSON" style="display:inline-block">Copy stats</button>
    <button id="copyCurlBtn" class="iconbtn" style="display:none" title="Copy last request as curl">Copy curl</button>
  </header>

  <div class="row">
    <button onclick="hit('/version')">/version</button>
    <button onclick="hit('/about')">/about</button>
    <button onclick="hit('/introspect/tools')">/introspect/tools</button>
    <button onclick="hit('/probe')">/probe</button>
    <button onclick="hit('/models')">/models</button>
    <button onclick="post('/models/refresh')">POST /models/refresh</button>
  </div>

  <div class="cols">
    <div class="box">
      <h3>Chat <a href="#" class="help" data-doc="orchestrator" data-tip="Super simple debug chat; models are stubbed (echo/reverse/time)." title="Chat docs">?</a></h3>
      <div class="row">
        <select id="chatModel">
          <option value="echo">echo</option>
          <option value="reverse">reverse</option>
          <option value="time">time</option>
        </select>
        <input id="chatTemp" type="number" step="0.1" min="0" max="2" value="0.7" style="width: 80px;">
      </div>
      <textarea id="chatInput" placeholder="Say hello"></textarea>
      <div class="row"><button onclick="chatSend()">Send</button> <button onclick="chatClear()">Clear</button></div>
      <pre id="chatOut">[]</pre>
    </div>
    <div class="box">
      <h3>Orchestration <a href="#" class="help" data-doc="orchestrator" data-tip="Common actions to manage the local agent service." title="Orchestration docs">?</a></h3>
      <div class="row">
        <button onclick="orProbe()">Probe now</button>
        <button onclick="orEmitTest()">Emit test</button>
        <button onclick="orRefreshModels()">Refresh models</button>
        <button onclick="runSelfTests()">Self‑tests</button>
        <button onclick="orShutdown()">Shutdown</button>
      </div>
      <div class="row">
        <label class="key">profile</label>
        <select id="profileSel">
          <option value="performance">performance</option>
          <option value="balanced" selected>balanced</option>
          <option value="power-saver">power-saver</option>
        </select>
        <button onclick="orProfileApply()">Apply</button>
        <button onclick="orProfileGet()">Get</button>
      </div>
      <div class="row">
        <label class="key">hints</label>
        <input id="hintConc" type="number" min="1" placeholder="concurrency" style="width:120px;">
        <input id="hintBuf" type="number" min="1" placeholder="event buffer" style="width:140px;">
        <input id="hintTimeout" type="number" min="1" placeholder="http timeout s" style="width:140px;">
        <button onclick="orHintsApply()">Apply</button>
        <button onclick="orHintsGet()">Get</button>
      </div>
      <div class="row"><span class="key">time</span> <code id="rt-orch">–</code></div>
    </div>
    <div class="box">
      <h3>Memory <a href="#" class="help" data-doc="memory" data-tip="Understand memory kinds and how /memory endpoints work." title="Memory docs">?</a> <span id="memHdrBadge" class="badge good" style="margin-left:6px"><span class="dot"></span> Mem: –</span></h3>
      <div class="row">
        <button onclick="refreshMemory()">Refresh</button>
        <button onclick="saveMemory()">Save</button>
        <button onclick="loadMemory()">Load</button>
        <select id="memKind">
          <option value="ephemeral">ephemeral</option>
          <option value="episodic">episodic</option>
          <option value="semantic">semantic</option>
          <option value="procedural">procedural</option>
        </select>
        <button class="primary" onclick="quickApply()">Apply</button>
      </div>
      <div class="row"><span class="key">time</span> <code id="rt-mem">–</code></div>
      <div class="row">
        <button onclick="getLimit()">Get limit</button>
        <button onclick="setLimit()">Set limit</button>
        <input id="limitVal" type="number" min="1" value="200" style="width: 90px;">
      </div>
      <textarea id="memBody">{ "msg": "hello from debug UI", "t": Date.now() }</textarea>
      <div class="row"><button class="iconbtn" id="copyJsonMem" title="Copy JSON">Copy</button></div>
      <pre id="memOut">{}</pre>
    </div>

    <div class="box" data-collapsed="1">
      <h3>Events <a href="#" class="help" data-doc="events" data-tip="Live event stream from /events (SSE)." title="Events docs">?</a></h3>
      <div class="row">
        <label><input type="checkbox" id="fService" checked> Service</label>
        <label><input type="checkbox" id="fMemory" checked> Memory</label>
        <label><input type="checkbox" id="fModels" checked> Models</label>
        <button class="iconbtn" id="sseReplay50" title="Replay last 50">Replay 50</button>
        <button class="iconbtn" id="sseOnlyModels" title="Filter to Models.*">Models only</button>
      </div>
      <div id="log"></div>
    </div>
    <div class="box" data-collapsed="1">
      <h3>System <a href="#" class="help" data-doc="events" data-tip="Live metrics via SSE (Probe.Metrics)." title="System metrics">?</a></h3>
      <div class="row">
        <div><span class="key">CPU</span> <code id="sysCpu">–</code></div>
        <div><span class="key">Mem</span> <code id="sysMem">–</code></div>
        <div><span class="key">Disk</span> <code id="sysDisk">–</code></div>
      </div>
      <div class="row">
        <button class="iconbtn" onclick="refreshMetrics()">Refresh</button>
        <button class="iconbtn" onclick="refreshHW()">Refresh HW</button>
      </div>
      <pre id="sysOut">{}</pre>
    </div>
  </div>

  <div class="cols" style="margin-top:16px">
    <div class="box">
      <h3>Tools <a href="#" class="help" data-doc="tools" data-tip="Tools, schemas, and how to call them." title="Tools docs">?</a></h3>
      <div class="row">
        <select id="toolId">
          <option value="math.add">math.add</option>
          <option value="time.now">time.now</option>
        </select>
        <button class="primary" onclick="runTool()">Run tool</button>
      </div>
      <div class="row"><span class="key">time</span> <code id="rt-tool">–</code></div>
      <textarea id="toolBody">{ "a": 1.5, "b": 2.25 }</textarea>
      <div class="row"><button class="iconbtn" id="copyJsonTool" title="Copy JSON">Copy</button></div>
      <pre id="toolOut">{}</pre>
    </div>

    <div class="box">
      <h3>Self‑tests</h3>
      <div class="row">
        <button class="primary" onclick="runSelfTests()">Run self‑tests</button>
        <button onclick="clearTests()">Clear</button>
      </div>
      <pre id="tests">Ready.</pre>
    </div>
    <div class="box" data-collapsed="1">
      <h3>Episodes <a href="#" class="help" data-doc="events" data-tip="Stitched by corr_id from live events." title="Episodes docs">?</a></h3>
      <div class="row">
        <button onclick="episodesRefresh()">Refresh</button>
        <label><input type="checkbox" id="epLive"> live</label>
        <label><input type="checkbox" id="epErrOnly"> errors only</label>
        <input id="epFilter" placeholder="filter id/kind/substr" style="flex:1;min-width:200px">
      </div>
      <div id="epList" style="max-height:36vh;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px"></div>
    </div>
    <div class="box" data-collapsed="1">
      <h3>State Snapshots</h3>
      <div class="row">
        <button onclick="pullState('observations')">Observations</button>
        <button onclick="pullState('beliefs')">Beliefs</button>
        <button onclick="pullState('intents')">Intents</button>
        <button onclick="pullState('actions')">Actions</button>
        <button onclick="pullState('episodes')">Episodes</button>
      </div>
      <pre id="stateOut">{}</pre>
    </div>
  <div class="box" data-collapsed="1">
      <h3>Self‑Learning <a href="#" class="help" data-doc="orchestrator" data-tip="Signals → suggestions. Gently embedded feedback." title="Self‑Learning docs">?</a></h3>
      <div class="row">
        <select id="sigKind">
          <option value="latency">latency</option>
          <option value="errors">errors</option>
          <option value="memory">memory</option>
          <option value="cpu">cpu</option>
        </select>
        <input id="sigTarget" placeholder="target (/path or id)" style="width:220px;">
        <input id="sigConf" type="number" step="0.05" min="0" max="1" value="0.7" style="width:90px;">
        <input id="sigSev" type="number" step="1" min="1" max="5" value="2" style="width:70px;">
      </div>
      <div class="row">
        <input id="sigNote" placeholder="note (optional)" style="width:60%">
        <button class="ghost" onclick="fbSignal()">Signal</button>
        <button class="primary" onclick="fbAnalyze()">Analyze now</button>
        <label><input type="checkbox" id="autoApply"> auto‑apply safe</label>
        <button class="ghost" onclick="fbAuto()">Set</button>
      </div>
      <div class="row">
        <button onclick="fbState()">Refresh</button>
        <button class="ghost" onclick="fbReset()">Reset</button>
        <input id="fbApplyId" placeholder="suggestion id" style="width:160px;">
        <button class="primary" onclick="fbApply()">Apply</button>
      </div>
      <pre id="fbOut">{"signals":[],"suggestions":[]}</pre>
      <h4 style="margin-top:10px">Live Suggestions <a href="#" class="help" data-doc="feedback" data-tip="Near-live heuristic suggestions. Applies are policy-gated." title="Feedback docs">?</a> <span class="badge warn" id="fbVerBadge"><span class="dot"></span> v0</span> <span class="key" id="fbBounds"></span></h4>
      <div class="row">
        <button class="iconbtn" onclick="fbFetchSuggestions()">Refresh</button>
        <label><input type="checkbox" id="fbLive" checked> live</label>
      </div>
      <div id="fbList"></div>
      <pre id="fbLiveOut" style="display:none">{"version":0,"suggestions":[]}</pre>
    </div>
    <div class="box">
      <h3>Models <a href="#" class="help" data-doc="orchestrator" data-tip="Add/delete and set default model." title="Models docs">?</a> <span id="modelsHdrBadge" class="badge warn" style="margin-left:6px"><span class="dot"></span> 0</span></h3>
      <div class="row">
        <input id="mId" placeholder="model id" style="width:220px;">
        <input id="mProv" placeholder="provider (local)" style="width:160px;">
      </div>
      <div class="row">
        <button onclick="modelsList()">List</button>
        <button onclick="modelsAdd()">Add</button>
        <button onclick="modelsDelete()">Delete</button>
        <button onclick="modelsDefaultGet()">Get default</button>
        <button onclick="modelsDefaultSet()">Set default</button>
        <button onclick="modelsDownload()">Download</button>
      </div>
      <pre id="modelsOut">[]</pre>
    </div>
  </div>

  <h3>Response <span class="key">time</span> <code id="rt-main">–</code> <button class="iconbtn" id="copyJsonMain" title="Copy JSON">Copy</button></h3>
  <pre id="out">{}</pre>

  <script>
const base = location.origin;
document.getElementById('port').textContent = location.host;
let lastCurl = null;
let __adminOk = false;
let __adminHeader = '';
function mkcurl(method, url, body){
  const parts = ["curl -sS", "-X", method, `'${url}'`];
  if (body != null){ parts.push("-H", `'Content-Type: application/json'`); parts.push("-d", `'${JSON.stringify(body)}'`); }
  if (__adminHeader) { parts.push("-H", `'X-ARW-Admin: ${__adminHeader}'`); }
  return parts.join(' ');
}
function setLastCurl(s){
  lastCurl = s; const b = document.getElementById('copyCurlBtn'); if (s){ b.style.display='inline-block'; } else { b.style.display='none'; }
}
document.getElementById('copyCurlBtn').addEventListener('click', async ()=>{
  if(!lastCurl) return; try{ await navigator.clipboard.writeText(lastCurl); const b = document.getElementById('copyCurlBtn'); const old = b.textContent; b.textContent='Copied'; setTimeout(()=> b.textContent=old, 900);}catch{}
});
async function req(method, path, body, outId, rtId){
  const url = base + path; const init = { method, headers: {}, body: undefined };
  if (body != null){ init.headers['Content-Type'] = 'application/json'; init.body = JSON.stringify(body); }
  if (__adminHeader) { init.headers['X-ARW-Admin'] = __adminHeader; }
  setLastCurl(mkcurl(method, url, body));
  const t0 = performance.now();
  try{
    const resp = await fetch(url, init);
    const txt = await resp.text();
    const dt = Math.round(performance.now() - t0);
    if(rtId){ const el = document.getElementById(rtId); if (el) el.textContent = dt + ' ms'; }
    const out = document.getElementById(outId);
    try{ out.textContent = JSON.stringify(JSON.parse(txt), null, 2); }catch{ out.textContent = txt; }
    if(!resp.ok){
      if (resp.status === 403) { showToast('403 Forbidden — admin endpoints locked. Set ARW_DEBUG=1 or use X-ARW-Admin'); setAdmin(false); }
      else if (resp.status === 429) { showToast('429 Too Many Requests — admin rate limit'); }
      else { showToast('Request failed: ' + resp.status + ' ' + (resp.statusText||'')); }
    }
    return txt;
  }catch(e){
    if(rtId){ const el = document.getElementById(rtId); if (el) el.textContent = 'error'; }
    showToast('Network error');
    throw e;
  }
}
async function hit(path){ await req('GET', path, null, 'out', 'rt-main'); }
async function post(path, body){ await req('POST', path, body, 'out', 'rt-main'); }
async function refreshMemory(){
  const txt = await req('GET', '/memory', null, 'memOut', 'rt-mem'); return txt;
}
async function saveMemory(){ await post('/memory/save'); await refreshMemory(); }
async function loadMemory(){ await post('/memory/load'); await refreshMemory(); }
async function quickApply(){
  let kind = document.getElementById('memKind').value;
  let bodyTxt = document.getElementById('memBody').value;
  let value; try{ value = JSON.parse(bodyTxt); }catch(e){ alert('Invalid JSON'); return; }
  await req('POST', '/memory/apply', { kind, value }, 'out', 'rt-main');
  await refreshMemory();
}
async function getLimit(){ await req('GET', '/memory/limit', null, 'out', 'rt-main'); }
async function setLimit(){ const n = parseInt(document.getElementById('limitVal').value||'200',10); await req('POST', '/memory/limit', { limit: n }, 'out', 'rt-main'); await getLimit(); }

// Tools
async function runTool(){
  const id = document.getElementById('toolId').value;
  let bodyTxt = document.getElementById('toolBody').value;
  let input; try{ input = JSON.parse(bodyTxt); }catch(e){ alert('Invalid JSON'); return; }
  const tb=document.getElementById('toolsBadge'); if(tb){ tb.className='badge warn'; tb.innerHTML='<span class=\"dot\"></span> Tools: active'; }
  await req('POST', '/tools/run', { id, input }, 'toolOut', 'rt-tool');
  if(tb){ tb.className='badge good'; tb.innerHTML='<span class=\"dot\"></span> Tools: done'; setTimeout(()=>{ tb.className='badge warn'; tb.innerHTML='<span class=\"dot\"></span> Tools: idle'; }, 1200); }
}

// Orchestration actions
async function orProbe(){ await req('GET', '/probe', null, 'out', 'rt-orch'); }
async function orEmitTest(){ await req('GET', '/emit/test', null, 'out', 'rt-orch'); }
async function orRefreshModels(){ await req('POST', '/models/refresh', null, 'out', 'rt-orch'); }
async function orShutdown(){ await req('GET', '/shutdown', null, 'out', 'rt-orch'); }
async function orProfileApply(){ const name = document.getElementById('profileSel').value; await req('POST','/governor/profile',{name},'out','rt-orch'); }
async function orProfileGet(){ await req('GET','/governor/profile',null,'out','rt-orch'); }
async function orHintsApply(){ const h={}; const c=document.getElementById('hintConc').value; const b=document.getElementById('hintBuf').value; const t=document.getElementById('hintTimeout').value; if(c) h.max_concurrency=parseInt(c,10); if(b) h.event_buffer=parseInt(b,10); if(t) h.http_timeout_secs=parseInt(t,10); if(Object.keys(h).length===0) return; await req('POST','/governor/hints',h,'out','rt-orch'); }
async function orHintsGet(){ await req('GET','/governor/hints',null,'out','rt-orch'); }

// Models UI
async function modelsList(){ await req('GET','/models',null,'modelsOut','rt-orch'); }
async function modelsAdd(){ const id=document.getElementById('mId').value.trim(); if(!id) return; const provider=(document.getElementById('mProv').value||'local').trim(); await req('POST','/models/add',{id,provider},'modelsOut','rt-orch'); await modelsList(); }
async function modelsDelete(){ const id=document.getElementById('mId').value.trim(); if(!id) return; await req('POST','/models/delete',{id},'modelsOut','rt-orch'); await modelsList(); }
async function modelsDefaultGet(){ await req('GET','/models/default',null,'modelsOut','rt-orch'); }
async function modelsDefaultSet(){ const id=document.getElementById('mId').value.trim(); if(!id) return; await req('POST','/models/default',{id},'modelsOut','rt-orch'); }
async function modelsDownload(){ const id=document.getElementById('mId').value.trim(); if(!id) return; const provider=(document.getElementById('mProv').value||'local').trim(); await req('POST','/models/download',{id,provider},'modelsOut','rt-orch'); }
async function modelsCancel(){ const id=document.getElementById('mId').value.trim(); if(!id) return; await req('POST','/models/download/cancel',{id},'modelsOut','rt-orch'); }

// Global EventSource + logger
let es = null;
function startSSE(replay, prefixes){
  try{ es?.close(); }catch{}
  let url = base + '/events';
  const qp = [];
  if (replay && replay > 0) qp.push('replay=' + encodeURIComponent(String(replay)));
  if (Array.isArray(prefixes)) {
    prefixes.forEach(p=>{ if(p) qp.push('prefix=' + encodeURIComponent(p)); });
  }
  if (qp.length){ url += '?' + qp.join('&'); }
  es = new EventSource(url);
  es.onopen = ()=> setSSE(true);
  es.onerror = ()=> setSSE(false);
  bindSSEHandlers();
}
// default SSE
document.addEventListener('DOMContentLoaded', ()=> startSSE(0, []));
function allow(kind){
  const s=document.getElementById('fService').checked;
  const m=document.getElementById('fMemory').checked;
  const o=document.getElementById('fModels').checked;
  if(kind.startsWith('Service.')) return s;
  if(kind.startsWith('Memory.'))  return m;
  if(kind.startsWith('Models.'))  return o;
  return true;
}
function svgIcon(kind, tone){
  const cls = `ico ${tone||'info'}`;
  switch(kind){
    case 'download': return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0l4-4m-4 4L8 9M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'check':    return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6l-11 11-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'refresh':  return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 10-2.34 5.66M20 12V6m0 6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'timer':    return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8v5l3 3M9 3h6M12 21a8 8 0 100-16 8 8 0 000 16z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'warn':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9v4m0 4h.01M10.29 3.86l-8 14A2 2 0 004 21h16a2 2 0 001.71-3.14l-8-14a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'stop':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="6" width="12" height="12" rx="2" stroke="currentColor" stroke-width="2"/></svg>`;
    case 'hdd':      return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 11h.01M11 11h.01M15 11h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
    case 'cloud':    return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 19a4.5 4.5 0 100-9 5.5 5.5 0 10-10.8 1.5A3.5 3.5 0 007 19h10.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'hash':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 9h14M5 15h14M9 5L7 19M17 5l-2 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'lock':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="11" width="14" height="9" rx="2" stroke="currentColor" stroke-width="2"/><path d="M9 11V8a3 3 0 116 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
    default:         return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/></svg>`;
  }
}
function iconsFor(kind, obj){
  if (kind === 'Models.DownloadProgress'){
    const s = obj.status; const c = obj.code;
    if (s === 'complete') return svgIcon('check','ok');
    if (s === 'resumed' || s === 'resync') return svgIcon('refresh','accent');
    if (s === 'started' || s === 'downloading') return svgIcon('download','accent');
    if (s === 'degraded') return svgIcon('timer','warn');
    if (s === 'canceled') return svgIcon('stop','info');
    switch(String(c||'')){
      case 'admission_denied': return svgIcon('lock','bad') + svgIcon('timer','warn');
      case 'hard_exhausted':   return svgIcon('timer','bad');
      case 'size_limit':
      case 'size_limit_stream':return svgIcon('stop','bad');
      case 'disk_insufficient':
      case 'disk_insufficient_stream': return svgIcon('hdd','bad') + svgIcon('warn','warn');
      case 'checksum_mismatch':return svgIcon('hash','bad') + svgIcon('stop','bad');
      case 'request_failed':   return svgIcon('cloud','bad') + svgIcon('stop','bad');
      case 'resume_http_status':
      case 'downstream_http_status': return svgIcon('cloud','warn') + svgIcon('warn','warn');
      default: return '';
    }
  }
  return '';
}
function pushEvt(kind, data){
  if(!allow(kind)) return;
  try{ const eb=document.getElementById('eventsBadge'); if(eb){ const n=parseInt(eb.getAttribute('data-n')||'0',10)+1; eb.setAttribute('data-n', String(n)); eb.className='badge good'; eb.innerHTML='<span class="dot"></span> Events: '+n; } }catch{}
  const div = document.createElement('div');
  div.className='evt';
  if (kind === 'Models.DownloadProgress'){
    try{
      const obj = JSON.parse(data||'{}');
      const ico = iconsFor(kind, obj);
      const id = obj.id || '';
      const base = (obj.progress!=null && obj.total) ? `${obj.progress}%` : (obj.status || '');
      const code = obj.code ? ` <span class="key">(${obj.code})</span>` : '';
      div.innerHTML = `[${new Date().toLocaleTimeString()}] ${kind}: ` + (ico? `<span class="icons">${ico}</span>` : '') + `${id} ${base}` + code;
    }catch{ div.textContent = `[${new Date().toLocaleTimeString()}] ${kind}: ${data}`; }
  } else {
    div.textContent = `[${new Date().toLocaleTimeString()}] ${kind}: ${data}`;
  }
  const log = document.getElementById('log');
  log.prepend(div);
  while (log.childElementCount > 200) log.removeChild(log.lastChild);
}
// Track model download progress into a header badge
function bindSSEHandlers(){
es.addEventListener('Models.DownloadProgress', (e)=>{
  try{
    const obj = JSON.parse(e.data||'{}');
    const b = document.getElementById('modelsBadge'); if(!b) return;
    if (obj.error){ b.className='badge bad'; b.innerHTML = '<span class="dot"></span> Models: error'; return; }
    if (obj.status === 'canceled'){ b.className='badge warn'; b.innerHTML = '<span class="dot"></span> Models: canceled'; return; }
    if (obj.status === 'complete'){ b.className='badge good'; b.innerHTML = '<span class="dot"></span> Models: complete'; return; }
    const pct = (obj.progress!=null)? obj.progress : null;
    if (pct!=null){ b.className='badge good'; b.innerHTML = '<span class="dot"></span> Models: ' + pct + '%'; }
    else { b.className='badge warn'; b.innerHTML = '<span class="dot"></span> Models: active'; }
  }catch{}
});
es.onmessage = (e) => pushEvt('message', e.data);
['Service.Connected','Service.Health','Service.Test','Memory.Applied','Models.Refreshed','Tool.Ran','Bus.Gap','Beliefs.Updated','Intents.Proposed','Intents.Approved','Intents.Rejected','Actions.Applied','Actions.HintApplied','Chat.Message'].forEach(k => {
  es.addEventListener(k, (e)=>pushEvt(k, e.data));
});
// Feedback live updates
es.addEventListener('Feedback.Suggested', (e)=>{
  pushEvt('Feedback.Suggested', e.data);
  try{ const j=JSON.parse(e.data); document.getElementById('fbLiveOut').textContent = JSON.stringify(j,null,2); fbRenderList(j); }catch{}
});
// Show probe events
es.addEventListener('Chat.Probe', (e)=>{
  pushEvt('Chat.Probe', e.data);
});

// Insights aggregation overlay
const agg = { total:0, kinds:{} };
let routesCache = {};
function renderInsights(){
  const el = document.getElementById('insights'); if(!el) return;
  const lines = [ `<h4>Events</h4>`, `<div class='kv'><b>Total</b><span>${agg.total}</span></div>` ];
  Object.entries(agg.kinds).slice(0,6).forEach(([k,v])=>{ lines.push(`<div class='kv'><span>${k}</span><span>${v}</span></div>`); });
  const entries = Object.entries(routesCache || {}).map(([p,st])=>({p,st})).sort((a,b)=> (b.st.p95_ms||0)-(a.st.p95_ms||0)).slice(0,3);
  if(entries.length){
    lines.push('<h4>Routes</h4>');
    entries.forEach(({p,st})=>{ lines.push(`<div class='kv'><span>${p}</span><span>p95:${st.p95_ms||0} ms · ewma:${(st.ewma_ms||0).toFixed(0)} ms · e:${st.errors||0}</span></div>`); });
  }
  el.innerHTML = lines.join('');
}
  ['Service.Connected','Service.Health','Service.Test','Memory.Applied','Models.Refreshed','Tool.Ran','Chat.Message','Governor.Changed','Bus.Gap','Beliefs.Updated','Intents.Proposed','Intents.Approved','Intents.Rejected','Actions.Applied','Actions.HintApplied'].forEach(k => {
    es.addEventListener(k, (e)=>{ agg.total++; agg.kinds[k]=(agg.kinds[k]||0)+1; renderInsights(); });
  });
  // System metrics (low-frequency)
  es.addEventListener('Probe.Metrics', (e)=>{
    try{ const j=JSON.parse(e.data||'{}'); updateSystemFromMetrics(j); }catch{}
  });
}

// --- System/HW helpers ---
function bytesHuman(n){ if(!n && n!==0) return '–'; const kb=1024, mb=kb*1024, gb=mb*1024, tb=gb*1024; if(n>=tb) return (n/tb).toFixed(2)+' TiB'; if(n>=gb) return (n/gb).toFixed(2)+' GiB'; if(n>=mb) return (n/mb).toFixed(1)+' MiB'; if(n>=kb) return (n/kb).toFixed(1)+' KiB'; return n+' B'; }
function setMemBadge(used,total){ try{ const el=document.getElementById('memBadge'); if(!el) return; const pct = total>0? (100*used/total) : 0; const txt = `Mem: ${pct.toFixed(1)}% (${bytesHuman(used)}/${bytesHuman(total)})`; el.innerHTML = '<span class="dot"></span> '+txt; el.className = 'badge ' + (pct>=90? 'bad' : pct>=75 ? 'warn' : 'good'); }catch{} }
function updateSystemFromMetrics(m){ try{
  const cpuAvg = (m?.cpu ?? m?.cpu_avg ?? 0);
  const memUsed = m?.mem?.used ?? m?.mem_used; const memTotal = m?.mem?.total ?? 0;
  const disk = m?.disk || {}; const dAvail = disk.available, dTotal = disk.total;
  const sysCpu = document.getElementById('sysCpu'); if(sysCpu) sysCpu.textContent = (typeof cpuAvg==='number'? cpuAvg.toFixed(1) : String(cpuAvg)) + ' %';
  const sysMem = document.getElementById('sysMem'); if(sysMem) sysMem.textContent = `${bytesHuman(memUsed)} / ${bytesHuman(memTotal)}`;
  const sysDisk = document.getElementById('sysDisk'); if(sysDisk) sysDisk.textContent = `${bytesHuman(dAvail)} free / ${bytesHuman(dTotal)} total`;
  setMemBadge(memUsed||0, memTotal||0);
  const out = document.getElementById('sysOut'); if(out){ const merged = { cpu_avg: cpuAvg, mem: m.mem, disk: m.disk, gpus: m.gpus, npus: m.npus }; out.textContent = JSON.stringify(merged, null, 2); }
}catch{} }
async function refreshMetrics(){ try{ const r = await fetch(base + '/admin/probe/metrics', { headers: { 'X-ARW-Admin': __adminHeader || '' } }); const j = await r.json(); if(j && j.ok){ updateSystemFromMetrics(j.data); } }catch(e){} }
async function refreshHW(){ try{ const r = await fetch(base + '/admin/probe/hw', { headers: { 'X-ARW-Admin': __adminHeader || '' } }); const j = await r.json(); const out = document.getElementById('sysOut'); if(out){ out.textContent = JSON.stringify(j?.data || j, null, 2); } }catch(e){} }

// --- Self-tests (unchanged from last patch; reuses global SSE) ---
function clearTests(){ document.getElementById('tests').textContent = 'Ready.'; }
function logT(msg, cls){
  const el = document.getElementById('tests');
  if(el.textContent === 'Ready.') el.textContent = '';
  const line = document.createElement('div');
  line.textContent = msg; if(cls) line.className = cls;
  el.appendChild(line);
}
async function jget(path){ const r = await fetch(base+path); if(!r.ok) throw new Error(r.status); return r.json(); }
async function jpost(path, body){ const r = await fetch(base+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error(r.status); return r.json(); }
function extractTestId(obj){
  try{
    if (obj?.payload?.payload?.value?.test_id) return obj.payload.payload.value.test_id;
    if (obj?.payload?.value?.test_id) return obj.payload.value.test_id;
    if (obj?.value?.test_id) return obj.value.test_id;
    if (obj?.test_id) return obj.test_id;
  }catch{}
  return undefined;
}
function waitForMemoryApplied(target, timeoutMs){
  return new Promise(resolve => {
    let settled = false;
    const done = ok => { if(!settled){ settled=true; clearTimeout(timer); es.removeEventListener('Memory.Applied', onNamed); es.removeEventListener('message', onMsg); resolve(ok); } };
    function maybeResolve(dataText){
      try{
        const obj = JSON.parse(dataText || '{}');
        const kind = obj?.kind;
        if (kind && kind !== 'Memory.Applied') return;
        const tid = extractTestId(obj);
        if (tid && target && tid !== target) return;
        done(true);
      }catch{}
    }
    const onNamed = (e)=> maybeResolve(e.data);
    const onMsg   = (e)=> maybeResolve(e.data);
    es.addEventListener('Memory.Applied', onNamed);
    es.addEventListener('message',       onMsg);
    const timer = setTimeout(()=> done(false), timeoutMs || 3500);
  });
}
async function runSelfTests(){
  clearTests();
  const pass = m => logT('✔ ' + m, 'pass');
  const fail = (m,e) => logT('✘ ' + m + ' — ' + (e && e.message ? e.message : e), 'fail');

  try { const v = await jget('/version'); if(v.service && v.version){ pass('/version'); } else { fail('/version','missing keys'); } } catch(e){ fail('/version',e); }
  try { const a = await jget('/about'); if(Array.isArray(a.endpoints)){ pass('/about'); } else { fail('/about','missing endpoints'); } } catch(e){ fail('/about',e); }
  try { const t = await jget('/introspect/tools'); if(Array.isArray(t) && t.length>=2){ pass('/introspect/tools'); } else { fail('/introspect/tools','unexpected'); } } catch(e){ fail('/introspect/tools',e); }

  try { await jpost('/memory/apply',{kind:'ephemeral',value:{ from:'selftest', t: Date.now() }}); const m = await jget('/memory'); if(m && m.ephemeral){ pass('POST /memory/apply + GET /memory'); } else { fail('memory','unexpected'); } } catch(e){ fail('memory',e); }

  try {
    const target = 'ui_selftest_' + Date.now();
    const waiter = waitForMemoryApplied(target, 3500);
    await jpost('/memory/apply',{kind:'ephemeral',value:{ test:'selftest', test_id: target, t: Date.now() }});
    const ok = await waiter;
    if(ok){ pass('SSE Memory.Applied'); } else { fail('SSE Memory.Applied','timeout'); }
  } catch(e){ fail('SSE Memory.Applied',e); }

  logT('Done.');
}
// Self-learning fns
async function fbState(){ await req('GET','/feedback/state',null,'fbOut','rt-orch'); }
async function fbAnalyze(){ await req('POST','/feedback/analyze',{},'fbOut','rt-orch'); }
async function fbSignal(){
  const kind=document.getElementById('sigKind').value;
  const target=document.getElementById('sigTarget').value||'';
  const confidence=parseFloat(document.getElementById('sigConf').value||'0.7');
  const severity=parseInt(document.getElementById('sigSev').value||'2',10);
  const note=document.getElementById('sigNote').value||undefined;
  await req('POST','/feedback/signal',{kind,target,confidence,severity,note},'fbOut','rt-orch');
}
async function fbAuto(){ const enabled=document.getElementById('autoApply').checked; await req('POST','/feedback/auto',{enabled},'fbOut','rt-orch'); }
async function fbReset(){ await req('POST','/feedback/reset',{},'fbOut','rt-orch'); }
async function fbApply(){ const id=(document.getElementById('fbApplyId').value||'').trim(); if(!id){ showToast('Enter suggestion id'); return; } await req('POST','/feedback/apply',{id},'fbOut','rt-orch'); }
async function fbFetchSuggestions(){ const txt = await req('GET','/feedback/suggestions',null,'fbLiveOut','rt-orch'); try{ const j=JSON.parse(txt); fbRenderList(j); __fbVersion = (j && j.version) || 0; }catch{} }
async function fbFetchSuggestions(){ await req('GET','/feedback/suggestions',null,'fbLiveOut','rt-orch'); }
function fbRenderList(j){
  const el = document.getElementById('fbList'); if(!el) return;
  const list = (j && j.suggestions) || [];
  const vb = document.getElementById('fbVerBadge'); if(vb){ const v=(j&&j.version)||0; vb.className='badge ' + (v>0?'good':'warn'); vb.innerHTML='<span class="dot"></span> v'+v; }
  if(!Array.isArray(list) || list.length===0){ el.innerHTML = '<div class="key">no suggestions</div>'; return; }
  const cls = (c)=> c>=0.8? 'good' : (c>=0.5? 'warn' : 'bad');
  const rows = list.map(s => {
    const id = s.id || '(unknown)';
    const action = s.action || '?';
    const cnum = (typeof s.confidence==='number') ? s.confidence : 0.0;
    const conf = cnum.toFixed(2);
    const rationale = s.rationale || '';
    const params = JSON.stringify(s.params||{}, null, 0);
    return `<div style="display:flex; gap:8px; align-items:center; margin:4px 0">
      <code style="min-width:120px">${action}</code>
      <span class="key">id</span><code>${id}</code>
      <span class="badge ${cls(cnum)}" title="confidence">${conf}</span>
      <button class="iconbtn" onclick="fbApplyId('${id}')">Apply</button>
      <span class="key">params</span><code>${params}</code>
      ${rationale ? `<span class="key">why</span><code>${rationale}</code>` : ''}
    </div>`;
  });
  el.innerHTML = rows.join('');
}
async function fbApplyId(id){
  if(!id) return;
  try{
    const resp = await fetch(base + '/feedback/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id}) });
    const txt = await resp.text();
    try{
      const j = JSON.parse(txt);
      if(j && j.ok){ showToast('Applied'); }
      else { showToast('Apply failed: ' + (j && j.reason || 'unknown')); }
      document.getElementById('fbOut').textContent = JSON.stringify(j,null,2);
    }catch{
      showToast('Apply error');
    }
  }catch{ showToast('Network error'); }
}
async function fbFetchPolicy(){
  try{ const r = await fetch(base + '/feedback/policy'); const j = await r.json(); const el=document.getElementById('fbBounds'); if(el){ el.textContent = `caps: ${j.apply_per_hour||3}/h · http_timeout ${j.http_timeout_min||5}..${j.http_timeout_max||300}s · mem_limit ${j.mem_limit_min||50}..${j.mem_limit_max||2000}`; } }catch{}
}
let __fbVersion = 0;
let __fbTimer = null;
async function fbLiveTick(){
  try{
    const r = await fetch(base + '/feedback/updates?since=' + (__fbVersion||0));
    if(r.status === 200){ const j = await r.json(); __fbVersion = j.version || 0; fbRenderList(j); const out=document.getElementById('fbLiveOut'); if(out){ out.textContent = JSON.stringify(j,null,2);} }
  }catch{}
}
function fbLiveSet(on){ if(__fbTimer){ clearInterval(__fbTimer); __fbTimer = null; } if(on){ fbLiveTick(); __fbTimer = setInterval(fbLiveTick, 3000); } }
// Docs wiring
let docsBase = null;
function docPath(key){
  switch(key){
    case 'memory': return '/memory_and_training/';
    case 'events': return '/guide/quickstart/';
    case 'tools': return '/api_and_schema/';
    case 'orchestrator': return '/guide/quickstart/';
    case 'chat': return '/guide/chat_backends/';
    case 'models': return '/guide/models_download/';
    case 'security': return '/guide/security_hardening/';
    case 'deployment': return '/deployment/';
    default: return '/';
  }
}
function positionTip(anchor, el){
  const r = anchor.getBoundingClientRect();
  el.style.left = Math.round(r.left + window.scrollX + 22) + 'px';
  el.style.top  = Math.round(r.top  + window.scrollY - 6) + 'px';
}
function showTip(anchor, text, key){
  const tip = document.createElement('div');
  tip.className = 'tip';
  const more = docsBase ? `<a class="t-more" target="_blank" href="${docsBase}${docPath(key)}">Read more →</a>` : '';
  tip.innerHTML = `<div class="t-title">${key.charAt(0).toUpperCase()+key.slice(1)}</div><div>${text}</div><div style="margin-top:6px">${more}</div>`;
  document.body.appendChild(tip);
  positionTip(anchor, tip);
  const close = () => { tip.remove(); document.removeEventListener('click', onClickAway); window.removeEventListener('resize', onResize); };
  const onClickAway = (e) => { if(!tip.contains(e.target) && e.target !== anchor) close(); };
  const onResize = () => positionTip(anchor, tip);
  setTimeout(()=> document.addEventListener('click', onClickAway), 0);
  window.addEventListener('resize', onResize);
}
async function initDocs(){
  try{
    const r = await fetch(base + '/about');
    const a = await r.json();
    const port = location.port || '8090';
    document.getElementById('port').textContent = port;
    if (a && a.docs_url){
      docsBase = (a.docs_url || '').replace(/\/$/, '');
      const link = document.getElementById('docsLink');
      link.href = docsBase + '/';
      link.style.display = 'inline-block';
      link.title = 'Open docs';
    }
  }catch{}
  // Bind help icons
  document.querySelectorAll('a.help[data-doc]').forEach(a => {
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const key = a.getAttribute('data-doc');
      const tip = a.getAttribute('data-tip') || '';
      showTip(a, tip, key);
    });
  });
}
document.addEventListener('DOMContentLoaded', initDocs);
// Metrics link
document.addEventListener('DOMContentLoaded', ()=>{
  const a=document.getElementById('metricsLink'); if(!a) return; a.href = base + '/metrics'; a.target='_blank'; a.title='Open Prometheus metrics';
});
function setAdmin(on){ __adminOk = !!on; const b=document.getElementById('adminBadge'); if(!b) return; b.className = 'badge ' + (on ? 'good' : 'warn'); b.innerHTML = '<span class="dot"></span> Admin: ' + (on ? 'on' : 'off'); }
function setSSE(on){ const b=document.getElementById('sseBadge'); if(!b) return; b.className = 'badge ' + (on ? 'good' : 'bad'); b.innerHTML = '<span class="dot"></span> SSE: ' + (on ? 'live' : 'off'); }
function setChat(name, ok){ const b=document.getElementById('chatBadge'); if(!b) return; const cls = ok ? (name==='synthetic'?'warn':'good') : 'bad'; b.className = 'badge ' + cls; b.innerHTML = '<span class="dot"></span> Chat: ' + name; }
async function chatProbe(){ try{ const r=await fetch(base + '/chat/status?probe=1'); const j=await r.json(); setChat(j.backend||'synthetic', !!j.ok); showToast('Chat ' + (j.backend||'synthetic') + ': ' + (j.ok?'ok':'fail') + (j.latency_ms?(' · '+j.latency_ms+' ms') : '')); }catch{ setChat('synthetic', false); showToast('Chat probe failed'); } }
async function chatInit(){ try{ const r=await fetch(base + '/chat/status'); const j=await r.json(); setChat(j.backend||'synthetic', !!j.ok); }catch{ setChat('synthetic', false); } }
async function probeAdmin(){ try{ const r = await fetch(base + '/introspect/tools'); setAdmin(r.ok); }catch{ setAdmin(false); } }
document.addEventListener('DOMContentLoaded', probeAdmin);
document.addEventListener('DOMContentLoaded', ()=>{ var b=document.getElementById('chatTestBtn'); if(b){ b.addEventListener('click', chatProbe); } chatInit(); });
document.addEventListener('DOMContentLoaded', ()=>{ try{ initBadges(); }catch(e){} });
// Pull policy bounds for display
document.addEventListener('DOMContentLoaded', fbFetchPolicy);
// Start live suggestions if enabled
document.addEventListener('DOMContentLoaded', ()=>{ const cb=document.getElementById('fbLive'); if(cb){ fbLiveSet(cb.checked); cb.addEventListener('change', ()=> fbLiveSet(cb.checked)); } });
// SSE presets
document.addEventListener('DOMContentLoaded', ()=>{
  const b1=document.getElementById('sseReplay50'); if(b1){ b1.addEventListener('click', ()=>{ startSSE(50, []); showToast('Replaying last 50'); }); }
  const b2=document.getElementById('sseOnlyModels'); if(b2){ b2.addEventListener('click', ()=>{ startSSE(0, ['Models.']); showToast('Filtering to Models.*'); }); }
});

// --- Persist common inputs ---
function prefKey(k){ return 'arw.' + k; }
function savePref(k,v){ try{ localStorage.setItem(prefKey(k), JSON.stringify(v)); }catch{} }
function loadPref(k,def){ try{ const v = localStorage.getItem(prefKey(k)); return v ? JSON.parse(v) : def; }catch{ return def; } }
function bindPersist(id, key, isCheckbox){ const el=document.getElementById(id); if(!el) return; const val = loadPref(key, isCheckbox ? false : ''); if(val !== undefined && val !== null){ if(isCheckbox) el.checked = !!val; else if(val !== '') el.value = val; }
  el.addEventListener('change', ()=>{ const v = isCheckbox ? !!el.checked : el.value; savePref(key, v); }); }
document.addEventListener('DOMContentLoaded', ()=>{
  [['chatModel',false],['memKind',false],['profileSel',false],['hintConc',false],['hintBuf',false],['hintTimeout',false],['autoApply',true],['fbLive',true],['memBody',false],['toolBody',false],['mId',false],['mProv',false]].forEach(([id,isCb])=> bindPersist(id, id, isCb));
  const remember = loadPref('admin.remember', false); const tok = loadPref('admin.token', '');
  const cb=document.getElementById('rememberTok'); const t=document.getElementById('adminToken'); if(cb) cb.checked = !!remember; if(t && remember && tok){ t.value = tok; __adminHeader = tok; setAdmin(true); }
});
document.addEventListener('DOMContentLoaded', ()=>{
  const btn=document.getElementById('useTok'); if(!btn) return; btn.addEventListener('click', ()=>{
    const t=document.getElementById('adminToken').value.trim(); __adminHeader = t; setAdmin(!!t);
    const remember = document.getElementById('rememberTok').checked; savePref('admin.remember', !!remember); if(remember){ savePref('admin.token', t); } else { try{ localStorage.removeItem(prefKey('admin.token')); }catch{} }
  });
});
document.addEventListener('DOMContentLoaded', ()=>{
  const sel=document.getElementById('hdrProfile'); if(sel){ sel.addEventListener('change', async ()=>{ try{ await fetch(base+'/governor/profile',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({name: sel.value})}); const b=document.getElementById('govBadge'); if(b){ b.className='badge good'; b.innerHTML='<span class=\"dot\"></span> Gov: '+sel.value; } showToast('Profile set to '+sel.value); }catch{ showToast('Profile change failed'); } }); }
});

// --- Command palette ---
function ensurePalette(){
  if(document.getElementById('pal')) return;
  const wrap=document.createElement('div'); wrap.className='palette'; wrap.id='pal';
  wrap.innerHTML = `<div class="pal-box"><input id="palQuery" placeholder="Type a command... (Esc to close)"><div id="palList" class="pal-list"></div></div>`;
  document.body.appendChild(wrap);
}
const palette = {
  open(){ ensurePalette(); const el=document.getElementById('pal'); el.style.display='flex'; this.render(''); const inp=document.getElementById('palQuery'); inp.value=''; inp.focus(); this.sel=0; },
  close(){ const el=document.getElementById('pal'); if(el) el.style.display='none'; },
  list:[
    {t:'Open /version', h:'GET', f:()=>hit('/version')},
    {t:'Open /about', h:'GET', f:()=>hit('/about')},
    {t:'List tools', h:'GET', f:()=>hit('/introspect/tools')},
    {t:'Probe now', h:'Action', f:()=>orProbe()},
    {t:'Refresh models', h:'Action', f:()=>orRefreshModels()},
    {t:'Run self-tests', h:'Action', f:()=>runSelfTests()},
    {t:'Toggle insights', h:'UI', f:()=>document.getElementById('toggleInsights').click()},
    {t:'Copy stats JSON', h:'UI', f:()=>copyStatsNow()},
    {t:'Open docs', h:'UI', f:()=>{ const l=document.getElementById('docsLink'); if(l && l.href) window.open(l.href,'_blank'); }},
    {t:'Shutdown service', h:'Danger', f:()=>orShutdown()},
  ],
  items:[], sel:0,
  render(q){ const list=document.getElementById('palList'); const qq=(q||'').toLowerCase(); this.items = this.list.filter(x=> x.t.toLowerCase().includes(qq)); if(this.items.length===0){ list.innerHTML = '<div class="pal-item"><span>No matches</span></div>'; return; }
    list.innerHTML = this.items.map((x,i)=> `<div class="pal-item ${i===0?'sel':''}" data-idx="${i}"><span>${x.t}</span><span class="hint">${x.h}</span></div>`).join(''); this.sel=0; },
  move(d){ if(!this.items.length) return; const list=document.getElementById('palList'); const max=this.items.length; const prev=this.sel; this.sel = (this.sel + d + max) % max; const rows=list.querySelectorAll('.pal-item'); if(rows[prev]) rows[prev].classList.remove('sel'); if(rows[this.sel]) rows[this.sel].classList.add('sel'); rows[this.sel]?.scrollIntoView({block:'nearest'}); },
  run(){ if(!this.items.length) return; const x=this.items[this.sel]; this.close(); try{ x.f(); }catch(e){ showToast('Command error'); } }
};
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('openPalette')?.addEventListener('click', ()=> palette.open());
  document.addEventListener('input', (e)=>{ if(e.target && e.target.id==='palQuery'){ palette.render(e.target.value||''); }});
  document.addEventListener('click', (e)=>{ const pal=document.getElementById('pal'); if(!pal || pal.style.display==='none') return; if(!pal.contains(e.target)){ /* click outside */ } });
});

// --- Shortcuts manager (centralized bindings + global toggle) ---
const Shortcuts = {
  enabled: true,
  binds: [],
  normalize(e){
    const parts = [];
    if (e.ctrlKey || e.metaKey) parts.push('Ctrl');
    if (e.altKey) parts.push('Alt');
    if (e.shiftKey && !['?',':'].includes(e.key)) parts.push('Shift');
    let k = e.key;
    if (k.length === 1) { k = k.toUpperCase(); }
    return parts.concat([k]).join('+');
  },
  inEditable(e){
    const t = e.target;
    if (!t) return false;
    const el = t.closest ? t.closest('input,textarea,select,[contenteditable="true"]') : null;
    return !!el;
  },
  register(seq, desc, fn, opts){ this.binds.push({ seq, desc, fn, when: (opts && opts.when) || (()=>true), inInputs: !!(opts && opts.captureInInputs) }); },
  setEnabled(on){ this.enabled = !!on; savePref('shortcuts.enabled', this.enabled); const cb=document.getElementById('shortcutsToggle'); if(cb) cb.checked = this.enabled; },
  list(){ return this.binds.map(b => ({ seq: b.seq, desc: b.desc })).filter((v,i,a)=> a.findIndex(x=> x.seq===v.seq && x.desc===v.desc)===i); },
  ensureHelp(){ if(document.getElementById('scut')) return; const wrap=document.createElement('div'); wrap.className='palette'; wrap.id='scut';
    wrap.innerHTML = `<div class="pal-box"><div style="padding:10px 12px;display:flex;align-items:center;gap:8px"><b>Shortcuts</b><span class="key" style="margin-left:auto">enable</span><input type="checkbox" id="shortcutsToggle2"></div><div id="scutList" class="pal-list"></div></div>`; document.body.appendChild(wrap);
    document.getElementById('shortcutsToggle2').addEventListener('change', (e)=> this.setEnabled(e.target.checked));
  },
  showHelp(){ this.ensureHelp(); const el=document.getElementById('scut'); const list=document.getElementById('scutList'); const rows=this.list().map(x=> `<div class="pal-item"><span>${x.desc}</span><span class="hint">${x.seq}</span></div>`).join(''); list.innerHTML = rows || '<div class="pal-item"><span>No shortcuts</span></div>'; el.style.display='flex'; document.getElementById('shortcutsToggle2').checked = this.enabled; },
  hideHelp(){ const el=document.getElementById('scut'); if(el) el.style.display='none'; },
  hookOnce(){ if (this._hooked) return; this._hooked=true; document.addEventListener('keydown', (e)=>{
      if(!this.enabled) return;
      const seq = this.normalize(e);
      const inEdit = this.inEditable(e);
      for(const b of this.binds){ if (b.seq === seq && b.when() && (b.inInputs || !inEdit)) { e.preventDefault(); try{ b.fn(e); }catch{} return; } }
      // Special case: Esc closes overlays
      if (e.key === 'Escape'){ const pal=document.getElementById('pal'); const sc=document.getElementById('scut'); if(pal && pal.style.display!=='none'){ palette.close(); e.preventDefault(); return; } if(sc && sc.style.display!=='none'){ this.hideHelp(); e.preventDefault(); return; } }
    }); }
};
document.addEventListener('DOMContentLoaded', ()=>{
  Shortcuts.setEnabled(loadPref('shortcuts.enabled', true));
  Shortcuts.hookOnce();
  const cb=document.getElementById('shortcutsToggle'); if(cb){ cb.checked = Shortcuts.enabled; cb.addEventListener('change', ()=> Shortcuts.setEnabled(cb.checked)); }
  document.getElementById('openShortcuts')?.addEventListener('click', ()=> Shortcuts.showHelp());
});

// Register default shortcuts
function paletteOpen(){ palette.open(); }
function insightsToggle(){ const el = document.getElementById('insights'); const on = (el.style.display==='none' || !el.style.display); el.style.display = on ? 'block' : 'none'; if(on){ if(window.__insightsTimer) clearInterval(window.__insightsTimer); const pull=async()=>{ try{ const r=await fetch(base+'/introspect/stats'); const j=await r.json(); routesCache = (j && j.routes && j.routes.by_path) || {}; renderInsights(); }catch{} }; pull(); window.__insightsTimer=setInterval(pull,3000); } else { if(window.__insightsTimer) clearInterval(window.__insightsTimer); } }
function paletteVisible(){ const el=document.getElementById('pal'); return !!el && el.style.display!=='none'; }
Shortcuts.register('Ctrl+K', 'Open palette', paletteOpen, { when: ()=> true });
Shortcuts.register('Ctrl+/', 'Show shortcuts', ()=> Shortcuts.showHelp(), { when: ()=> true });
Shortcuts.register('Ctrl+I', 'Toggle insights', insightsToggle, { when: ()=> true });
Shortcuts.register('ArrowDown', 'Palette: next', ()=> palette.move(1), { when: paletteVisible, captureInInputs: true });
Shortcuts.register('ArrowUp', 'Palette: prev', ()=> palette.move(-1), { when: paletteVisible, captureInInputs: true });
Shortcuts.register('Enter', 'Palette: run', ()=> palette.run(), { when: paletteVisible, captureInInputs: true });

// helper to copy stats
async function copyStatsNow(){ try{ const r=await fetch(base + '/introspect/stats'); const t=await r.text(); await navigator.clipboard.writeText(t); showToast('Stats copied'); }catch{ showToast('Stats copy failed'); } }
</script>
<div id="toast" class="toast"></div>
<script>
function showToast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=>{ t.style.display='none'; }, 2500); }
async function pullState(kind){ try{ const r=await fetch(base + '/state/' + kind); const j=await r.json(); document.getElementById('stateOut').textContent = JSON.stringify(j,null,2); }catch(e){ showToast('state fetch failed'); } }
// Episodes UI
let __epTimer = null;
function episodesRender(j){ try{
  const el = document.getElementById('epList'); if(!el) return;
  const items = (j && j.items) || [];
  const errOnly = !!document.getElementById('epErrOnly')?.checked;
  const filt = (document.getElementById('epFilter')?.value||'').toLowerCase();
  const matches = (ep)=>{
    if (errOnly && !(ep.errors>0)) return false;
    if (!filt) return true;
    const id = (ep.id||'').toLowerCase();
    if (id.includes(filt)) return true;
    const arr = ep.items||[];
    for (let i=0;i<arr.length;i++){ const k = (arr[i].kind||'').toLowerCase(); if(k.includes(filt)) return true; try{ const p = JSON.stringify(arr[i].payload||{}).toLowerCase(); if(p.includes(filt)) return true; }catch{} }
    return false;
  };
  const list = items.filter(matches);
  if(list.length === 0){ el.innerHTML = '<div class="evt">(no episodes)</div>'; return; }
  const html = list.slice().reverse().map((ep,idx)=>{
    const count = (ep.items||[]).length;
    const last = ep.last || '';
    const dur = ep.duration_ms!=null ? ` · ${ep.duration_ms} ms` : '';
    const errs = ep.errors||0;
    const badge = errs>0 ? `<span class="badge bad" style="margin-left:6px"><span class="dot"></span> ${errs} err</span>` : `<span class="badge good" style="margin-left:6px"><span class="dot"></span> OK</span>`;
    const eid = `epd-${(ep.id||String(idx)).replace(/[^a-zA-Z0-9_-]/g,'_')}`;
    const head = `<div style="font-weight:600;display:flex;justify-content:space-between;align-items:center"><span>${ep.id} <span style="color:var(--muted);font-weight:400"> · ${count} events${dur} · ${last}</span>${badge}</span><button class="iconbtn" onclick="const d=document.getElementById('${eid}'); d.style.display = (d.style.display==='none'||!d.style.display)?'block':'none';">Details</button></div>`;
    const bodyAll = (ep.items||[]).map(ev=>{
      const k = ev.kind || '';
      const t = ev.time || '';
      const p = ev.payload ? JSON.stringify(ev.payload) : '{}';
      // Inline apply button when suggestion id present
      let applyBtn = '';
      try{ const sid = ev?.payload?.suggestion?.id; if (sid){ applyBtn = ` <button class="iconbtn" onclick="epApply('${sid}')">Apply</button>`; } }catch{}
      return `<div class="evt">[${t}] ${k}: ${p}${applyBtn}</div>`;
    }).join('');
    return `<div class="box" style="border:1px dashed #e5e7eb;margin:6px 0;padding:6px">${head}<div id="${eid}" style="display:none">${bodyAll}</div></div>`;
  }).join('');
  el.innerHTML = html;
}catch{}}
async function episodesRefresh(){ try{ const r=await fetch(base + '/state/episodes'); const j=await r.json(); episodesRender(j); }catch(e){ showToast('episodes fetch failed'); } }
document.addEventListener('DOMContentLoaded', ()=>{
  const cb = document.getElementById('epLive'); if(!cb) return;
  const tick = async ()=>{ await episodesRefresh(); };
  cb.addEventListener('change', ()=>{
    if(cb.checked){ tick(); __epTimer = setInterval(tick, 3000); }
    else { if(__epTimer) { clearInterval(__epTimer); __epTimer=null; } }
  });
});
async function epApply(id){ try{ const r=await fetch(base + '/feedback/apply', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})}); if(r.ok){ showToast('Applied '+id); } else { showToast('Apply failed ('+r.status+')'); } }catch{ showToast('Apply failed'); } }
// Bind copy buttons and insights toggle after DOM ready
document.addEventListener('DOMContentLoaded', ()=>{
  const copyMain=document.getElementById('copyJsonMain'); if(copyMain){ copyMain.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(document.getElementById('out').textContent||''); }catch{} }); }
  const copyMem=document.getElementById('copyJsonMem'); if(copyMem){ copyMem.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(document.getElementById('memOut').textContent||''); }catch{} }); }
  const copyTool=document.getElementById('copyJsonTool'); if(copyTool){ copyTool.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(document.getElementById('toolOut').textContent||''); }catch{} }); }
  const tgl=document.getElementById('toggleInsights'); if (tgl){ tgl.addEventListener('click', insightsToggle); }
  const copyStats=document.getElementById('copyStatsBtn'); if(copyStats){ copyStats.addEventListener('click', async ()=>{ try{ const r=await fetch(base + '/introspect/stats'); const t=await r.text(); await navigator.clipboard.writeText(t); showToast('Stats copied'); }catch{ showToast('Stats copy failed'); } }); }
});
</script>
  <div id="insights" style="display:none"></div>
  <script>
    // Collapsible sections persisted by heading
    (function(){
      try{
        document.querySelectorAll('.box>h3').forEach(h => {
          const key = 'dbg_collapse_' + (h.textContent||'').trim().toLowerCase().replace(/\s+/g,'_');
          const box = h.parentElement;
          const saved = localStorage.getItem(key);
          if (saved === '1') box.setAttribute('data-collapsed','1');
          else if (saved === '0') box.removeAttribute('data-collapsed');
          h.addEventListener('click', () => {
            const collapsed = box.getAttribute('data-collapsed') === '1';
            if (collapsed) { box.removeAttribute('data-collapsed'); localStorage.setItem(key,'0'); }
            else { box.setAttribute('data-collapsed','1'); localStorage.setItem(key,'1'); }
          });
        });
        // Expand / Collapse all
        const exp = document.getElementById('btnExpandAll');
        const col = document.getElementById('btnCollapseAll');
        if (exp) exp.addEventListener('click', ()=>{
          document.querySelectorAll('.box').forEach(b => {
            b.removeAttribute('data-collapsed');
            const h = b.querySelector('h3');
            if (h) localStorage.setItem('dbg_collapse_' + (h.textContent||'').trim().toLowerCase().replace(/\s+/g,'_'), '0');
          });
        });
        if (col) col.addEventListener('click', ()=>{
          document.querySelectorAll('.box').forEach(b => {
            b.setAttribute('data-collapsed','1');
            const h = b.querySelector('h3');
            if (h) localStorage.setItem('dbg_collapse_' + (h.textContent||'').trim().toLowerCase().replace(/\s+/g,'_'), '1');
          });
        });
        // Density toggle
        const dens = document.getElementById('btnDensity');
        const setDensity = mode => { document.body.classList.toggle('density-compact', mode==='compact'); localStorage.setItem('dbg_density', mode); };
        const savedD = localStorage.getItem('dbg_density');
        if (savedD === 'compact') document.body.classList.add('density-compact');
        if (dens) dens.addEventListener('click', ()=>{ const compact = document.body.classList.contains('density-compact'); setDensity(compact? 'comfortable' : 'compact'); });
      }catch{}
    })();
  </script>
</body>
</html>
