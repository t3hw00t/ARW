<!doctype html><html lang="en">
<head>
  <meta charset="utf-8">
  <title>ARW Debug</title>
  <link rel="stylesheet" href="/admin/ui/assets/tokens.css"/>
  <link rel="stylesheet" href="/admin/ui/assets/ui-kit.css"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      color-scheme:light dark;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:20px;line-height:1.45;color:var(--ink);background: var(--surface)}
    /* manual theme override */
    [data-theme="dark"]{ --bg:#0b0b0f; --ink:#e5e7eb; --line:#1f232a; --muted:#889 }
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px;position:sticky;top:0;background:rgba(255,255,255,0.7);backdrop-filter:saturate(140%) blur(6px);padding:8px 12px;border:1px solid var(--line);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.06)}
    code,pre{background:#0b0b0c10;padding:2px 4px;border-radius:4px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    button,input,select,textarea{font:inherit}
    button{padding:8px 12px;border:1px solid #cfd6de;background-image:linear-gradient(180deg,#ffffff,#f3f4f6), var(--noise);background-blend-mode:overlay,normal;border-radius:8px;cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,0.9) inset, 0 8px 18px rgba(0,0,0,0.06);transition:transform .06s ease, box-shadow .12s ease}
    button:hover{transform:translateY(-0.5px);box-shadow:0 1px 0 rgba(255,255,255,0.95) inset, 0 14px 28px rgba(0,0,0,0.08)}
    .iconbtn{padding:6px 8px;font-size:12px}
    .cols{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px}
    .card>h3{margin:4px 0 8px 0; cursor:pointer; display:flex; align-items:center; gap:8px}
    .card>h3::after{ content:"▾"; font-size:12px; color:var(--color-muted) }
    .card[data-collapsed="1"]>h3::after{ content:"▸" }
    .card[data-collapsed="1"]>:not(h3){ display:none }
    #log{max-height:40vh;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:linear-gradient(180deg,#ffffff,#fafafa);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
    .evt{padding:4px 6px;border-bottom:1px dashed #eee;font-family:ui-monospace,Menlo,Consolas,monospace}
    .key{color:var(--muted)}
    textarea{width:100%;min-height:100px}
    .pass{color:var(--status-ok)}.fail{color:var(--status-bad)}
    /* badges/dots/tones provided by shared UI kit */
    /* Iconography */
    .icons{ display:inline-flex; gap:6px; align-items:center; margin-right:6px }
    .ico{ width:14px; height:14px; display:inline-block; vertical-align:-2px; color:currentColor; opacity:.9 }
    .ico.ok{ color:var(--status-ok) }
    .ico.warn{ color:var(--status-warn) }
    .ico.bad{ color:var(--status-bad) }
    .ico.info{ color:var(--color-muted) }
    .ico.accent{ color: var(--color-accent-teal) }
    /* Subtle hint block */
    .hint{ font-size:12px; color:#374151; background:#f8fafc; border:1px solid var(--line); border-left:3px solid var(--color-accent-teal); padding:8px 10px; border-radius:8px; margin:6px 0 }
    .hint .dismiss{ float:right; text-decoration:none; color:var(--color-muted); font-weight:600 }
    /* Downloads list */
    .dlrow{ display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px dashed #eee }
    /* Models compact table */
    .mtable{ font-size:12px; margin-top:6px }
    .mrow{ display:flex; align-items:center; gap:10px; padding:4px 0; border-bottom:1px dashed #eee }
    .mcell{ min-width:80px }
    .mcell.id{ font-family:ui-monospace,Menlo,Consolas,monospace; font-weight:600; min-width:180px }
    .mcell.sha{ font-family:ui-monospace,Menlo,Consolas,monospace; color:var(--muted); min-width:110px }
    .mhead{ font-weight:700; color:#555 }
    .badge.small{ font-size:10px; padding:2px 6px }
    .mcell.actions{ margin-left:auto; display:flex; align-items:center; gap:6px }
    .mini{ font-size:12px; padding:2px 6px; width:180px }
    .dlid{ font-family:ui-monospace,Menlo,Consolas,monospace; font-weight:600; min-width:140px }
    .dlstat{ font-size:12px; color:var(--muted); min-width:90px }
    .dlmeta{ font-size:12px; color:var(--muted) }
    .pbar{ width:180px; height:8px; background:var(--line); border-radius:999px; overflow:hidden; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6) }
    .pfill{ height:100%; background:linear-gradient(90deg, var(--color-accent-teal), #22c55e); width:0% }
    .ghost{ padding:6px 10px; border:1px dashed #cfd6de; background:#fff; border-radius:6px; cursor:pointer }
    a.help{display:inline-block;margin-left:8px;width:18px;height:18px;border-radius:50%;border:1px solid #d1d5db;color:var(--color-muted);text-align:center;line-height:16px;text-decoration:none;font-weight:600;font-size:12px}
    a.help:hover{background:#f3f4f6;color:#374151}
    .tip{position:fixed;z-index:50;max-width:360px;background:#ffffff;border:1px solid var(--line);border-radius:10px;box-shadow:0 16px 40px rgba(0,0,0,0.14);padding:10px 12px}
    .tip .t-title{font-weight:600;margin-bottom:4px}
    .tip .t-more{color:var(--color-accent-teal);text-decoration:none}
    .t-hidden{display:none}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:8px 12px;border-radius:10px;display:none;max-width:70vw;box-shadow:0 16px 40px rgba(0,0,0,0.14)}
    #insights{position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,0.12);padding:10px 12px;display:none;min-width:260px;max-width:50vw}
    #insights .kv{display:flex;justify-content:space-between;color:#374151}
    #insights h4{margin:4px 0 6px 0;font-size:14px}
    .palette{position:fixed;inset:0;background:rgba(0,0,0,0.2);display:none;align-items:flex-start;justify-content:center;padding-top:10vh}
    .pal-box{background:#fff;color:#111;width:min(680px,90vw);border:1px solid var(--line);border-radius:10px;box-shadow:0 20px 50px rgba(0,0,0,0.15);overflow:hidden}
    .pal-box input{width:100%;padding:10px 12px;border:none;outline:none;font:inherit}
    .pal-list{max-height:50vh;overflow:auto}
    .pal-item{padding:8px 12px;border-top:1px solid #f1f5f9;cursor:pointer;display:flex;justify-content:space-between}
    .pal-item.sel{background:var(--surface-muted)}
    .pal-item .hint{color:var(--color-muted);font-size:12px}
    @media (max-width:900px){ .cols{grid-template-columns:1fr} }
    @media (pointer: coarse){ button{ padding:12px 16px } .iconbtn{ padding:10px 12px; font-size:14px } }
    button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{ outline:2px solid rgba(184,115,51,0.55); outline-offset:2px }
    @media (prefers-reduced-motion: reduce){ *{ transition:none !important; animation:none !important } }
    @media (prefers-color-scheme: dark){
      body{ background: var(--surface) }
      header{ background: rgba(16,18,24,0.7); border-color:#1f232a; box-shadow:0 10px 24px rgba(0,0,0,0.35) }
      #log{ background: linear-gradient(180deg,#12161f,#0f141a); border-color:#1f232a; box-shadow: inset 0 1px 0 rgba(255,255,255,0.06) }
      .tip{ background:#0f141a; border-color:#1f232a; box-shadow:0 16px 40px rgba(0,0,0,0.6) }
      .toast{ background:#1f2937; color:#e5e7eb; border-color:#374151 }
      #insights{ background:#0f141a; border-color:#1f232a; box-shadow:0 18px 48px rgba(0,0,0,0.6) }
    }
    /* Compact density override */
    body.density-compact .row{ gap:6px; margin:6px 0 }
    body.density-compact header{ gap:10px; padding:6px 10px }
    body.density-compact .cols{ gap:12px }
    body.density-compact .card{ padding:10px; border-radius:10px }
    body.density-compact .iconbtn{ padding:6px 8px }
  </style>
</head>
<body>
  <header>
    <h1>ARW Debug</h1>
    <span class="key">port</span><code id="port"></code>
    <span id="adminBadge" class="badge warn" title="Administrative endpoints are locked"><span class="dot"></span> Admin: off</span>
    <span id="sseBadge" class="badge bad" title="SSE connection to /events"><span class="dot"></span> SSE: off</span>
    <span id="chatBadge" class="badge warn" title="Chat backend"><span class="dot"></span> Chat: synthetic</span>
    <span id="toolsBadge" class="badge warn" title="Tools activity"><span class="dot"></span> Tools: idle</span>
    <span id="eventsBadge" class="badge warn" title="Events activity"><span class="dot"></span> Events: 0</span>
    <span id="modelsBadge" class="badge warn" title="Models activity"><span class="dot"></span> Models: idle</span>
    <a id="metricsLink" class="help" href="#" title="Open /metrics" style="display:inline-block">M</a>
    <button id="copyMetrics" class="iconbtn" title="Copy /metrics to clipboard">Copy metrics</button>
    <a id="catalogLink" class="help" href="#" title="Open Interface Catalog (/catalog/index)" style="display:inline-block">C</a>
    <span id="catalogBadge" class="badge warn" title="Interface Catalog status"><span class="dot"></span> Catalog: …</span>
    <button class="iconbtn" id="btnExpandAll" title="Expand all">Expand</button>
    <button class="iconbtn" id="btnCollapseAll" title="Collapse all">Collapse</button>
    <button class="iconbtn" id="btnDensity" title="Toggle density">Density</button>
    <button class="iconbtn" id="btnBack" title="Back">Back</button>
    <a class="iconbtn" href="/" title="Home">Home</a>
    <button class="iconbtn" id="themeToggle" title="Toggle theme">Theme</button>
    <span id="memBadge" class="badge ok" title="Memory usage"><span class="dot"></span> Mem: –</span>
    <span id="cpuBadge" class="badge ok" title="CPU usage"><span class="dot"></span> CPU: –</span>
    <span id="gpuBadge" class="badge ok" title="GPU memory usage (sum across adapters)"><span class="dot"></span> GPU: –</span>
    <span id="govBadge" class="badge ok" title="Governor profile"><span class="dot"></span> Gov: –</span>
    <span id="modeBadge" class="badge ok" title="Run mode"><span class="dot"></span> Mode: balanced</span>
    <span id="sloBadge" class="badge warn" title="Interactive SLO (P95)"><span class="dot"></span> SLO: 1500 ms</span>
    <span id="egressBadge" class="badge warn" title="Pre‑offload preview"><span class="dot"></span> Egress: idle</span>
    <button id="chatTestBtn" class="iconbtn" title="Test chat backend">Test</button>
    <input id="adminToken" placeholder="token" style="width: 120px;" title="X-ARW-Admin header">
    <button id="useTok" class="iconbtn" title="Use admin token">Use</button>
    <label class="key" title="Remember token locally"><input type="checkbox" id="rememberTok"> remember</label>
    <button id="openPalette" class="iconbtn" title="Command palette (Ctrl/Cmd+K)">Palette</button>
    <label class="key">profile</label>
    <select id="hdrProfile" title="Governor profile">
      <option value="performance">performance</option>
      <option value="balanced" selected>balanced</option>
      <option value="power-saver">power-saver</option>
    </select>
    <label class="key" title="Run mode">mode</label>
    <select id="hdrMode" title="Run mode (Quick/Balanced/Deep/Verified)">
      <option value="quick">quick</option>
      <option value="balanced" selected>balanced</option>
      <option value="deep">deep</option>
      <option value="verified">verified</option>
    </select>
    <a href="#" class="help" data-doc="playbook" data-tip="Modes: Quick/Balanced/Deep/Verified; SLO‑aware scheduling and previews." title="Performance & Reasoning">?</a>
    <label class="key" title="Interactive latency target (P95)">SLO ms</label>
    <input id="hdrSlo" type="number" min="100" step="50" value="1500" style="width: 90px;" title="Interactive SLO (P95) in ms">
    <button id="applyModeSlo" class="iconbtn" title="Apply mode/SLO">Apply</button>
    <button id="openShortcuts" class="iconbtn" title="Show shortcuts (Ctrl+/)">Shortcuts</button>
    <label class="key" title="Enable keyboard shortcuts"><input type="checkbox" id="shortcutsToggle" checked> shortcuts</label>
    <a id="docsLink" class="help" title="Open docs" href="#" target="_blank" style="margin-left:auto;display:none">?</a>
    <a id="secLink" class="help" data-doc="security" data-tip="Hardening guidance and recommended deployment settings." title="Security hardening" href="#" style="display:inline-block">!</a>
    <button id="toggleInsights" class="iconbtn" title="Insights" style="display:inline-block">Insights</button>
    <button id="copyStatsBtn" class="iconbtn" title="Copy stats JSON" style="display:inline-block">Copy stats</button>
    <button id="copyCurlBtn" class="iconbtn" style="display:none" title="Copy last request as curl">Copy curl</button>
  </header>
  <script>
    (function(){
      try{
        const KEY = 'arw-theme';
        const apply = t => { const r=document.documentElement; if(t==='dark'){ r.setAttribute('data-theme','dark'); } else { r.removeAttribute('data-theme'); } };
        const cur = () => localStorage.getItem(KEY)||'';
        apply(cur());
        const btn = document.getElementById('themeToggle');
        if(btn) btn.addEventListener('click', ()=>{ const t = cur()==='dark'?'light':'dark'; localStorage.setItem(KEY,t); apply(t); });
        const back = document.getElementById('btnBack');
        if(back) back.addEventListener('click', ()=>{ try{ if(document.referrer){ history.back(); } else { location.assign('/admin'); } } catch(e){ location.assign('/admin'); } });
      }catch{}
    })();
  </script>

  <div class="row">
    <button onclick="hit('/version')">/version</button>
    <button onclick="hit('/about')">/about</button>
    <button onclick="hit('/admin/introspect/tools')">/admin/introspect/tools</button>
    <button onclick="hit('/admin/probe')">/admin/probe</button>
    <button onclick="hit('/admin/models')">/admin/models</button>
    <button onclick="post('/admin/models/refresh')">POST /admin/models/refresh</button>
  </div>

  <div class="cols">
    <div class="card">
      <h3>Chat <a href="#" class="help" data-doc="orchestrator" data-tip="Super simple debug chat; models are stubbed (echo/reverse/time)." title="Chat docs">?</a></h3>
      <div class="row" role="toolbar" aria-label="Chat settings">
        <select id="chatModel">
          <option value="echo">echo</option>
          <option value="reverse">reverse</option>
          <option value="time">time</option>
        </select>
        <input id="chatTemp" type="number" step="0.1" min="0" max="2" value="0.7" style="width: 80px;">
      </div>
      <textarea id="chatInput" placeholder="Say hello"></textarea>
      <div class="row" role="toolbar" aria-label="Chat actions"><button onclick="chatSend()">Send</button> <button onclick="chatClear()">Clear</button></div>
      <pre id="chatOut">[]</pre>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Staging Queue <a href="#" class="help" data-doc="human_in_loop" data-tip="Approve or deny human-in-the-loop actions awaiting review." title="Staging docs">?</a></h3>
      <div class="row" role="toolbar" aria-label="Staging actions">
        <button onclick="stagingFetch()">Refresh</button>
      </div>
      <div id="stagingList" class="mtable" style="max-height:32vh;overflow:auto"></div>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Research Watcher <a href="#" class="help" data-doc="research_watcher" data-tip="Approve or archive suggested logic units and research items." title="Research watcher">?</a></h3>
      <div class="row" role="toolbar" aria-label="Research watcher actions">
        <button onclick="rwFetch()">Refresh</button>
      </div>
      <div id="rwPending" style="display:flex;flex-direction:column;gap:8px;max-height:32vh;overflow:auto"></div>
      <details style="margin-top:8px">
        <summary class="key">Recent decisions</summary>
        <div id="rwRecent" style="font-size:12px;color:var(--muted);margin-top:6px"></div>
      </details>
    </div>
    <div class="card">
      <h3>Orchestration <a href="#" class="help" data-doc="orchestrator" data-tip="Common actions to manage the local agent service." title="Orchestration docs">?</a></h3>
      <div class="row" role="toolbar" aria-label="Orchestration actions">
        <button onclick="orProbe()">Probe now</button>
        <button onclick="orEmitTest()">Emit test</button>
        <button onclick="orRefreshModels()">Refresh models</button>
        <button onclick="runSelfTests()">Self‑tests</button>
        <button onclick="orShutdown()">Shutdown</button>
      </div>
      <div class="row" role="toolbar" aria-label="Profile">
        <label class="key">profile</label>
        <select id="profileSel">
          <option value="performance">performance</option>
          <option value="balanced" selected>balanced</option>
          <option value="power-saver">power-saver</option>
        </select>
        <button onclick="orProfileApply()">Apply</button>
        <button onclick="orProfileGet()">Get</button>
      </div>
      <div class="row" role="toolbar" aria-label="Hints">
        <label class="key">hints</label>
        <input id="hintConc" type="number" min="1" placeholder="concurrency" style="width:120px;">
        <input id="hintBuf" type="number" min="1" placeholder="event buffer" style="width:140px;">
        <input id="hintTimeout" type="number" min="1" placeholder="http timeout s" style="width:140px;">
        <input id="hintRetrK" type="number" min="1" placeholder="retrieval k" style="width:120px;">
        <input id="hintDiv" type="number" step="0.05" min="0" max="1" placeholder="diversity/λ" style="width:120px;">
        <input id="hintLambda" type="number" step="0.05" min="0" max="1" placeholder="mmr λ" style="width:120px;">
        <input id="hintCompr" type="number" step="0.1" min="0" max="1" placeholder="compression" style="width:120px;">
        <input id="hintVoteK" type="number" min="0" max="9" placeholder="vote-k" style="width:100px;">
        <input id="hintCtxBudget" type="number" min="0" placeholder="ctx tokens" style="width:110px;">
        <input id="hintCtxPer" type="number" min="0" placeholder="per-item tokens" style="width:140px;">
        <select id="hintCtxFmt" title="context format" style="width:120px;">
          <option value="">format</option>
          <option value="bullets">bullets</option>
          <option value="jsonl">jsonl</option>
          <option value="inline">inline</option>
          <option value="custom">custom</option>
        </select>
        <label class="key"><input type="checkbox" id="hintProv"> provenance</label>
        <button onclick="orHintsApply()">Apply</button>
        <button onclick="orHintsGet()">Get</button>
      </div>
      <div class="row">
        <input id="hintCtxHeader" placeholder="header" style="flex:1;min-width:180px">
        <input id="hintCtxFooter" placeholder="footer" style="flex:1;min-width:180px">
      </div>
      <div class="row">
        <input id="hintCtxTpl" placeholder="custom item template (for format=custom)" style="flex:1;min-width:280px">
        <input id="hintJoiner" placeholder="joiner (e.g., \n)" style="width:140px">
      </div>
      <div class="row"><span class="key">time</span> <code id="rt-orch">–</code></div>
    </div>
    <div class="card">
      <h3>Memory <a href="#" class="help" data-doc="memory" data-tip="Understand memory kinds and how /memory endpoints work." title="Memory docs">?</a> <span id="memHdrBadge" class="badge ok" style="margin-left:6px"><span class="dot"></span> Mem: –</span></h3>
      <div class="row">
        <button onclick="refreshMemory()">Refresh</button>
        <select id="memKind">
          <option value="ephemeral">ephemeral</option>
          <option value="episodic">episodic</option>
          <option value="semantic">semantic</option>
          <option value="procedural">procedural</option>
        </select>
        <button class="primary" onclick="quickApply()">Apply</button>
      </div>
      <div class="row"><span class="key">time</span> <code id="rt-mem">–</code></div>
      <textarea id="memBody">{ "msg": "hello from debug UI", "t": Date.now() }</textarea>
      <div class="row"><button class="iconbtn" id="copyJsonMem" title="Copy JSON">Copy</button></div>
      <pre id="memOut">{}</pre>
    </div>

    <div class="card" data-collapsed="1">
      <h3>Events <a href="#" class="help" data-doc="events" data-tip="Live event stream from /events (SSE)." title="Events docs">?</a></h3>
      <div class="row">
        <label><input type="checkbox" id="fService" checked> Service</label>
        <label><input type="checkbox" id="fMemory" checked> Memory</label>
        <label><input type="checkbox" id="fModels" checked> Models</label>
        <button class="iconbtn" id="sseReplay50" title="Replay last 50">Replay 50</button>
        <button class="iconbtn" id="sseOnlyModels" title="Filter to models.*">Models only</button>
        <button class="iconbtn" id="sseOnlyRpu" title="Filter to rpu.*">RPU only</button>
      </div>
      <div id="log"></div>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Egress Preview <a href="#" class="help" data-doc="deployment" data-tip="Pre‑offload preview: where data would go and why." title="Egress preview">?</a></h3>
      <div class="row">
        <button class="iconbtn" id="egClear">Clear</button>
      </div>
      <div id="egOut" style="max-height:28vh;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px"></div>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Training Telemetry <a href="#" class="help" data-doc="training_park" data-tip="Live metrics feeding the Training Park." title="Training telemetry">?</a></h3>
      <div class="row" role="toolbar" aria-label="Training telemetry actions">
        <button class="iconbtn" onclick="trainingFetch()">Refresh</button>
      </div>
      <pre id="trainingOut">{}</pre>
    </div>
    <div class="card" data-collapsed="1">
      <h3>System <a href="#" class="help" data-doc="events" data-tip="Live metrics via SSE (probe.metrics)." title="System metrics">?</a></h3>
      <div class="row">
        <div><span class="key">CPU</span> <code id="sysCpu">–</code></div>
        <div><span class="key">Mem</span> <code id="sysMem">–</code></div>
        <div><span class="key">Disk</span> <code id="sysDisk">–</code></div>
        <div><span class="key">GPU</span> <code id="sysGpu">–</code></div>
        <div><span class="key">NPU</span> <code id="sysNpu">–</code></div>
      </div>
      <div class="row">
        <button class="iconbtn" onclick="refreshMetrics()">Refresh</button>
        <button class="iconbtn" onclick="refreshHW()">Refresh HW</button>
        <button class="iconbtn" id="gpuToggle">GPU adapters</button>
      </div>
      <div id="gpuList" style="display:none; padding:8px; border:1px dashed var(--line); border-radius:8px; background:#fff"></div>
      <pre id="sysOut">{}</pre>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Trust (RPU) <a href="#" class="help" data-doc="trust_boundaries" data-tip="Regulatory Provenance Unit — trust store and signatures." title="RPU Trust">?</a></h3>
      <div class="row">
        <div class="kv"><b>issuers</b> <span id="rpuCount">–</span></div>
        <div class="kv"><b>last reload</b> <span id="rpuLast">–</span></div>
      </div>
      <div class="row">
        <button class="iconbtn" id="rpuRefreshBtn">Refresh</button>
        <button class="iconbtn" id="rpuReloadBtn">Reload</button>
        <a class="iconbtn" id="rpuEventsBtn" target="_blank">Open RPU events</a>
      </div>
      <pre id="rpuOut">{}</pre>
    </div>
  </div>

  <div class="cols" style="margin-top:16px">
    <div class="card" data-collapsed="1">
      <h3>Experiments (Live) <a href="#" class="help" data-doc="testing" data-tip="Recent experiment activity and quick scoreboard." title="Experiments">?</a></h3>
      <div class="row">
        <button class="iconbtn" onclick="expDefs()">Refresh defs</button>
        <label><input type="checkbox" id="expLive" checked> live</label>
        <button class="iconbtn" onclick="expClear()">Clear board</button>
        <button class="iconbtn" onclick="expExportCSV()">Export CSV</button>
        <button class="iconbtn" onclick="expCopyJSON()">Copy JSON</button>
      </div>
      <div id="expDefs" style="max-height:20vh;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px"></div>
      <div id="expBoard" style="max-height:28vh;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px;margin-top:8px"></div>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Models Metrics <a href="#" class="help" data-doc="events" data-tip="Live counters and EWMA for model downloads." title="Models metrics">?</a></h3>
      <div class="row">
        <button class="iconbtn" onclick="modelsMetricsRefresh()">Refresh</button>
        <label><input type="checkbox" id="mmLive"> live</label>
      </div>
      <div class="row">
        <div class="kv"><b>started</b> <span id="mmStarted">0</span></div>
        <div class="kv"><b>queued</b> <span id="mmQueued">0</span></div>
        <div class="kv"><b>admitted</b> <span id="mmAdmitted">0</span></div>
        <div class="kv"><b>resumed</b> <span id="mmResumed">0</span></div>
        <div class="kv"><b>canceled</b> <span id="mmCanceled">0</span></div>
      </div>
      <div class="row">
        <div class="kv"><b>completed</b> <span id="mmCompleted">0</span></div>
        <div class="kv"><b>completed_cached</b> <span id="mmCompletedCached">0</span></div>
        <div class="kv"><b>errors</b> <span id="mmErrors">0</span></div>
        <div class="kv"><b>bytes_total</b> <span id="mmBytes">0</span></div>
        <div class="kv"><b>ewma_mbps</b> <span id="mmEwma">0</span></div>
      </div>
    </div>
    <div class="card">
      <h3>Tools <a href="#" class="help" data-doc="tools" data-tip="Tools, schemas, and how to call them." title="Tools docs">?</a></h3>
      <div class="row">
        <select id="toolId">
          <option value="math.add">math.add</option>
          <option value="time.now">time.now</option>
        </select>
        <button class="primary" onclick="runTool()">Run tool</button>
      </div>
      <div class="row"><span class="key">time</span> <code id="rt-tool">–</code></div>
      <textarea id="toolBody">{ "a": 1.5, "b": 2.25 }</textarea>
      <div class="row"><button class="iconbtn" id="copyJsonTool" title="Copy JSON">Copy</button></div>
      <pre id="toolOut">{}</pre>
    </div>

    <div class="card">
      <h3>Goldens / Experiments <a href="#" class="help" data-doc="testing" data-tip="Run goldens and A/B variants offline; activate a live variant by applying hints." title="Goldens/Experiments">?</a></h3>
      <div class="row">
        <input id="goldProj" placeholder="project" value="default" style="width: 160px;">
        <button class="iconbtn" onclick="goldList()">List</button>
        <button class="iconbtn" onclick="goldRun()">Run</button>
        <label class="key">vote‑k</label>
        <input id="goldVoteK" type="number" min="1" max="9" value="3" style="width: 60px;">
      </div>
      <div class="row">
        <input id="expId" placeholder="exp id" style="width: 180px;">
        <input id="expVar" placeholder="variants (A,B)" value="A,B" style="width: 160px;">
        <button class="iconbtn" onclick="expDefine()">Define</button>
        <button class="iconbtn" onclick="expRun()">Run A/B</button>
        <button class="iconbtn" onclick="expActivate()" title="Apply selected variant hints">Activate</button>
      </div>
      <div class="row" id="expKpis" style="display:none"></div>
      <div class="row"><span class="key">solve rate</span> <code id="goldSolve">–</code> <span class="key">avg ms</span> <code id="goldLat">–</code></div>
      <pre id="goldOut">{}</pre>
    </div>

    <div class="card">
      <h3>Self‑tests</h3>
      <div class="row">
        <button class="primary" onclick="runSelfTests()">Run self‑tests</button>
        <button onclick="clearTests()">Clear</button>
      </div>
      <pre id="tests">Ready.</pre>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Episodes <a href="#" class="help" data-doc="events" data-tip="Stitched by corr_id from live events." title="Episodes docs">?</a></h3>
      <div class="row">
        <button onclick="episodesRefresh()">Refresh</button>
        <label><input type="checkbox" id="epLive"> live</label>
        <label><input type="checkbox" id="epErrOnly"> errors only</label>
        <input id="epFilter" placeholder="filter id/kind/substr" style="flex:1;min-width:200px">
      </div>
      <div id="epList" style="max-height:36vh;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px"></div>
    </div>
    <div class="card" data-collapsed="1">
      <h3>State Snapshots</h3>
      <div class="row">
        <button onclick="pullState('observations')">Observations</button>
        <button onclick="pullState('beliefs')">Beliefs</button>
        <button onclick="pullState('world')">World</button>
        <button onclick="pullState('intents')">Intents</button>
        <button onclick="pullState('actions')">Actions</button>
        <button onclick="pullState('episodes')">Episodes</button>
      </div>
      <div class="row">
        <input id="worldQ" placeholder="world: query" style="flex:1;min-width:200px">
        <input id="worldK" type="number" min="1" max="50" step="1" value="8" style="width:70px">
        <button class="ghost" onclick="worldSelect()">Select</button>
        <label class="key"><input type="checkbox" id="asmOverride"> overrides</label>
        <button class="primary" onclick="contextAssemble()">Assemble</button>
      </div>
      <div class="row" id="plannerMeta" style="display:none"></div>
      <div class="row" id="ctxKpis" style="display:none"></div>
      <div class="row"><span class="key">context preview</span></div>
      <pre id="ctxPreview" style="white-space:pre-wrap">(assemble to render)</pre>
      <pre id="stateOut">{}</pre>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Project Map</h3>
      <div class="row">
        <button class="ghost" onclick="worldMapRefresh()">Refresh</button>
        <label><input type="checkbox" id="wmLive"> live</label>
      </div>
      <div id="worldMap" style="max-height:28vh;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px"></div>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Routes <a href="#" class="help" data-doc="events" data-tip="Live HTTP route stats (p95/ewma/hits/errors)." title="Routes stats">?</a></h3>
      <div class="row">
        <button class="iconbtn" onclick="routesPanelRefresh()">Refresh</button>
        <label><input type="checkbox" id="routesLive"> live</label>
        <select id="routesSort" title="sort by">
          <option value="p95">p95</option>
          <option value="ewma">ewma</option>
          <option value="hits">hits</option>
          <option value="errors">errors</option>
        </select>
        <input id="routesTopN" type="number" min="1" value="10" style="width:80px" title="Top N">
      </div>
      <div id="routesTable" style="max-height:36vh;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px"></div>
    </div>
  <div class="card" data-collapsed="1">
      <h3>Self‑Learning <a href="#" class="help" data-doc="orchestrator" data-tip="Signals → suggestions. Gently embedded feedback." title="Self‑Learning docs">?</a></h3>
      <div class="row">
        <select id="sigKind">
          <option value="latency">latency</option>
          <option value="errors">errors</option>
          <option value="memory">memory</option>
          <option value="cpu">cpu</option>
        </select>
        <input id="sigTarget" placeholder="target (/path or id)" style="width:220px;">
        <input id="sigConf" type="number" step="0.05" min="0" max="1" value="0.7" style="width:90px;">
        <input id="sigSev" type="number" step="1" min="1" max="5" value="2" style="width:70px;">
      </div>
      <div class="row">
        <input id="sigNote" placeholder="note (optional)" style="width:60%">
        <button class="ghost" onclick="fbSignal()">Signal</button>
        <button class="primary" onclick="fbAnalyze()">Analyze now</button>
        <label><input type="checkbox" id="autoApply"> auto‑apply safe</label>
        <button class="ghost" onclick="fbAuto()">Set</button>
      </div>
      <div class="row">
        <button onclick="fbState()">Refresh</button>
        <button class="ghost" onclick="fbReset()">Reset</button>
        <input id="fbApplyId" placeholder="suggestion id" style="width:160px;">
        <button class="primary" onclick="fbApply()">Apply</button>
      </div>
      <pre id="fbOut">{"signals":[],"suggestions":[]}</pre>
      <h4 style="margin-top:10px">Live Suggestions <a href="#" class="help" data-doc="feedback" data-tip="Near-live heuristic suggestions. Applies are policy-gated." title="Feedback docs">?</a> <span class="badge warn" id="fbVerBadge"><span class="dot"></span> v0</span> <span class="key" id="fbBounds"></span></h4>
      <div class="row">
        <button class="iconbtn" onclick="fbFetchSuggestions()">Refresh</button>
        <label><input type="checkbox" id="fbLive" checked> live</label>
      </div>
      <div id="fbList"></div>
      <pre id="fbLiveOut" style="display:none">{"version":0,"suggestions":[]}</pre>
    </div>
    <div class="card">
      <h3>Models <a href="#" class="help" data-doc="orchestrator" data-tip="Add/delete and set default model." title="Models docs">?</a> <span id="modelsHdrBadge" class="badge warn" style="margin-left:6px"><span class="dot"></span> 0</span></h3>
      <div id="modelsHint" class="hint" style="display:none">
        <a href="#" class="dismiss" title="dismiss" onclick="modelsHintDismiss(); return false;">×</a>
        <b>Get started:</b>
        <span class="key">1)</span> Add a model id
        <span class="key">2)</span> Paste file URL + SHA256
        <span class="key">3)</span> Click Download
        <a href="#" onclick="modelsPrefillSample(); return false;" style="margin-left:10px; color:#2563eb; text-decoration:underline">prefill sample</a>
      </div>
      <div class="row">
        <input id="mId" placeholder="model id" style="width:220px;">
        <input id="mProv" placeholder="provider (local)" style="width:160px;">
      </div>
      <div class="row">
        <input id="mUrl" placeholder="download url (https://...)" style="flex:1; min-width:320px;">
        <input id="mSha" placeholder="sha256 (64 hex)" style="width:360px;">
      </div>
      <div class="row">
        <button onclick="modelsList()">List</button>
        <button onclick="modelsAdd()">Add</button>
        <button onclick="modelsDelete()">Delete</button>
        <button onclick="modelsDefaultGet()">Get default</button>
        <button onclick="modelsDefaultSet()">Set default</button>
        <button onclick="modelsDownload()">Download</button>
        <button onclick="modelsCancel()">Cancel</button>
        <input id="gcTtl" type="number" min="1" value="7" style="width:80px" title="ttl days">
        <button onclick="modelsGc()" title="GC CAS blobs older than ttl">GC</button>
      </div>
      <pre id="modelsOut" style="display:none">[]</pre>
      <div id="modelsTable" class="mtable"></div>
    </div>
    <div class="card" id="dlBox">
      <h3>Downloads</h3>
      <div class="row" role="toolbar" aria-label="Downloads actions">
        <span id="dlCount" class="badge warn"><span class="dot"></span> 0</span>
        <button class="iconbtn" onclick="dlClearFinished()">Clear finished</button>
        <button class="iconbtn" id="copyDownloadsBtn" title="Copy JSON">Copy</button>
      </div>
      <div id="dlRows"></div>
    </div>
    <div class="card" data-collapsed="1">
      <h3>Agent Card <a href="#" class="help" data-doc="events" data-tip="Self‑model: capabilities, competence, calibration, costs, failure modes." title="Self‑Model docs">?</a> <span id="selfHdrBadge" class="badge warn" style="margin-left:6px"><span class="dot"></span> 0</span></h3>
      <div class="row" role="toolbar" aria-label="Agent Card actions">
        <button class="iconbtn" onclick="selfRefreshList()">Refresh</button>
        <select id="selfAgentSel" style="min-width:180px"></select>
        <input id="selfAgentId" placeholder="or type agent id" style="width:200px">
        <button class="primary" onclick="selfView()">View</button>
        <label><input type="checkbox" id="selfLive"> live</label>
      </div>
      <div id="selfSummary" class="row" style="flex-direction:column;gap:6px"></div>
      <div class="row"><button class="iconbtn" id="copyJsonSelf" title="Copy JSON">Copy</button></div>
      <pre id="selfOut">{}</pre>
      <h4 style="margin-top:10px">Propose update <span class="key">(admin)</span></h4>
      <div class="row">
        <input id="selfWhy" placeholder="rationale" style="flex:1;min-width:200px">
        <button class="ghost" onclick="selfPropose()">Propose</button>
        <input id="selfApplyId" placeholder="proposal id" style="width:200px">
        <button class="ghost" onclick="selfApply()">Apply</button>
      </div>
      <textarea id="selfPatch">{}</textarea>
      <pre id="selfAdminOut">{}</pre>
    </div>
  </div>

  <h3>Response <span class="key">time</span> <code id="rt-main">–</code> <button class="iconbtn" id="copyJsonMain" title="Copy JSON">Copy</button></h3>
  <pre id="out">{}</pre>

  <script>
const base = location.origin;
document.getElementById('port').textContent = location.host;
let lastCurl = null;
let __adminOk = false;
let __adminHeader = '';
function mkcurl(method, url, body){
  const parts = ["curl -sS", "-X", method, `'${url}'`];
  if (body != null){ parts.push("-H", `'Content-Type: application/json'`); parts.push("-d", `'${JSON.stringify(body)}'`); }
  if (__adminHeader) { parts.push("-H", `'X-ARW-Admin: ${__adminHeader}'`); }
  return parts.join(' ');
}
function setLastCurl(s){
  lastCurl = s; const b = document.getElementById('copyCurlBtn'); if (s){ b.style.display='inline-block'; } else { b.style.display='none'; }
}
document.getElementById('copyCurlBtn').addEventListener('click', async ()=>{
  if(!lastCurl) return; try{ await navigator.clipboard.writeText(lastCurl); const b = document.getElementById('copyCurlBtn'); const old = b.textContent; b.textContent='Copied'; setTimeout(()=> b.textContent=old, 900);}catch{}
});
async function req(method, path, body, outId, rtId){
  let p = path;
  // Auto-prefix admin for sensitive paths unless explicitly public
  if (!(p.startsWith('/admin') || p.startsWith('/metrics') || p.startsWith('/version') || p.startsWith('/about') || p.startsWith('/spec') || p.startsWith('/state') || p.startsWith('/events'))) {
    p = '/admin' + p;
  }
  const url = base + p; const init = { method, headers: {}, body: undefined };
  if (body != null){ init.headers['Content-Type'] = 'application/json'; init.body = JSON.stringify(body); }
  if (__adminHeader) { init.headers['X-ARW-Admin'] = __adminHeader; }
  setLastCurl(mkcurl(method, url, body));
  const t0 = performance.now();
  try{
    const resp = await fetch(url, init);
    const txt = await resp.text();
    const dt = Math.round(performance.now() - t0);
    if(rtId){ const el = document.getElementById(rtId); if (el) el.textContent = dt + ' ms'; }
    const out = document.getElementById(outId);
    try{ out.textContent = JSON.stringify(JSON.parse(txt), null, 2); }catch{ out.textContent = txt; }
    if(!resp.ok){
      if (resp.status === 403) { showToast('403 Forbidden — admin endpoints locked. Set ARW_DEBUG=1 or use X-ARW-Admin'); setAdmin(false); }
      else if (resp.status === 429) { showToast('429 Too Many Requests — admin rate limit'); }
      else { showToast('Request failed: ' + resp.status + ' ' + (resp.statusText||'')); }
    }
    return txt;
  }catch(e){
    if(rtId){ const el = document.getElementById(rtId); if (el) el.textContent = 'error'; }
    showToast('Network error');
    throw e;
  }
}
async function hit(path){ await req('GET', path, null, 'out', 'rt-main'); }
async function post(path, body){ await req('POST', path, body, 'out', 'rt-main'); }
async function refreshMemory(){
  const txt = await req('GET', '/state/memory/recent?limit=200', null, 'memOut', 'rt-mem'); return txt;
}
async function quickApply(){
  let kind = document.getElementById('memKind').value;
  let bodyTxt = document.getElementById('memBody').value;
  let value; try{ value = JSON.parse(bodyTxt); }catch(e){ alert('Invalid JSON'); return; }
  await req('POST', '/admin/memory/apply', { lane: kind, value }, 'out', 'rt-main');
  await refreshMemory();
}

// Tools
async function runTool(){
  const id = document.getElementById('toolId').value;
  let bodyTxt = document.getElementById('toolBody').value;
  let input; try{ input = JSON.parse(bodyTxt); }catch(e){ alert('Invalid JSON'); return; }
  const tb=document.getElementById('toolsBadge'); if(tb){ tb.className='badge warn'; tb.innerHTML='<span class=\"dot\"></span> Tools: active'; }
  await req('POST', '/tools/run', { id, input }, 'toolOut', 'rt-tool');
  if(tb){ tb.className='badge ok'; tb.innerHTML='<span class=\"dot\"></span> Tools: done'; setTimeout(()=>{ tb.className='badge warn'; tb.innerHTML='<span class=\"dot\"></span> Tools: idle'; }, 1200); }
}

// Orchestration actions
async function orProbe(){ await req('GET', '/probe', null, 'out', 'rt-orch'); }
async function orEmitTest(){ await req('GET', '/emit/test', null, 'out', 'rt-orch'); }
async function orRefreshModels(){ await req('POST', '/models/refresh', null, 'out', 'rt-orch'); }
async function orShutdown(){ await req('GET', '/shutdown', null, 'out', 'rt-orch'); }
async function orProfileApply(){ const name = document.getElementById('profileSel').value; await req('POST','/governor/profile',{name},'out','rt-orch'); }
async function orProfileGet(){ await req('GET','/governor/profile',null,'out','rt-orch'); }
async function orHintsApply(){ const h={};
  const c=document.getElementById('hintConc').value; const b=document.getElementById('hintBuf').value; const t=document.getElementById('hintTimeout').value;
  const rk=document.getElementById('hintRetrK').value; const dv=document.getElementById('hintDiv').value; const lam=document.getElementById('hintLambda').value; const cg=document.getElementById('hintCompr').value; const vk=document.getElementById('hintVoteK').value;
  const cb=document.getElementById('hintCtxBudget').value; const pi=document.getElementById('hintCtxPer').value; const fmt=document.getElementById('hintCtxFmt').value; const prov=document.getElementById('hintProv').checked;
  const hdr=document.getElementById('hintCtxHeader').value; const ftr=document.getElementById('hintCtxFooter').value; const tpl=document.getElementById('hintCtxTpl').value; const jn=document.getElementById('hintJoiner').value;
  if(c) h.max_concurrency=parseInt(c,10); if(b) h.event_buffer=parseInt(b,10); if(t) h.http_timeout_secs=parseInt(t,10);
  if(rk) h.retrieval_k=parseInt(rk,10); if(dv) h.retrieval_div=parseFloat(dv); if(lam) h.mmr_lambda=parseFloat(lam); if(cg) h.compression_aggr=parseFloat(cg); if(vk) h.vote_k=parseInt(vk,10);
  if(cb) h.context_budget_tokens=parseInt(cb,10); if(pi) h.context_item_budget_tokens=parseInt(pi,10);
  if(fmt) h.context_format=fmt; if(prov) h.include_provenance=!!prov; if(hdr) h.context_header=hdr; if(ftr) h.context_footer=ftr; if(tpl) h.context_item_template=tpl; if(jn) h.joiner=jn;
  if(Object.keys(h).length===0) return; await req('POST','/governor/hints',h,'out','rt-orch'); }
async function orHintsGet(){ await req('GET','/governor/hints',null,'out','rt-orch'); }

// Models UI
async function modelsList(){ try{
  const r = await fetch(base + '/admin/models', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
  if(!r.ok) return;
  const list = await r.json();
  window.__modelsRM = window.__modelsRM || { items: [], default: null };
  window.__modelsRM.items = Array.isArray(list) ? list : (Array.isArray(list?.data)? list.data : []);
  modelsRender();
}catch{} }
async function modelsAdd(){ const id=document.getElementById('mId').value.trim(); if(!id) return; const provider=(document.getElementById('mProv').value||'local').trim(); await req('POST','/models/add',{id,provider},'modelsOut','rt-orch'); await modelsList(); }
async function modelsDelete(){ const id=document.getElementById('mId').value.trim(); if(!id) return; await req('POST','/models/delete',{id},'modelsOut','rt-orch'); await modelsList(); }
async function modelsDefaultGet(){ try{ const r=await fetch(base + '/admin/models/default', { headers: { 'X-ARW-Admin': __adminHeader || '' } }); const j=await r.json(); const d = (j?.data?.default) || j?.default || null; window.__modelsRM = window.__modelsRM || { items: [], default: null }; window.__modelsRM.default = d; modelsRender(); }catch{} }
async function modelsDefaultSet(){ try{ const id=document.getElementById('mId').value.trim(); if(!id) return; await fetch(base + '/admin/models/default', { method:'POST', headers: { 'Content-Type':'application/json','X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify({id}) }); window.__modelsRM = window.__modelsRM || { items: [], default: null }; window.__modelsRM.default = id; modelsRender(); }catch{} }
async function modelsDownload(){
  const id=(document.getElementById('mId')?.value||'').trim();
  const provider=(document.getElementById('mProv')?.value||'local').trim();
  const url=(document.getElementById('mUrl')?.value||'').trim();
  const sha256=(document.getElementById('mSha')?.value||'').trim();
  if(!id){ showToast('model id required'); return; }
  if(!url){ showToast('url required'); return; }
  if(!/^https?:\/\//i.test(url)){ showToast('invalid url (http/https)'); return; }
  if(!(sha256 && /^[0-9a-fA-F]{64}$/.test(sha256))){ showToast('sha256 (64 hex) required'); return; }
  await req('POST','/models/download',{ id, url, provider, sha256 },'modelsOut','rt-orch');
}
async function modelsCancel(){ const id=document.getElementById('mId').value.trim(); if(!id) return; await req('POST','/models/download/cancel',{id},'modelsOut','rt-orch'); }
async function modelsCancelId(id){ if(!id) return; await req('POST','/models/download/cancel',{id},'out','rt-orch'); }

function modelsPrefillSample(){
  const id = 'example-model';
  const provider = 'local';
  const url = 'https://example.com/models/example-model.bin';
  const sha = '0000000000000000000000000000000000000000000000000000000000000000';
  const set = (elId, val)=>{ const el=document.getElementById(elId); if(el){ el.value = val; try{ savePref(elId, val); }catch{} } };
  set('mId', id);
  set('mProv', provider);
  set('mUrl', url);
  set('mSha', sha);
  showToast('Sample values filled');
}

// --- Download Manager ---
const downloads = Object.create(null); // id -> entry
function nowMs(){ return (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now(); }
function msHuman(ms){ if(!ms && ms!==0) return '–'; const s=Math.max(0, Math.round(ms/1000)); const m=Math.floor(s/60); const ss=(s%60).toString().padStart(2,'0'); return (m>0? m+':':'0:')+ss; }
function codeExplain(code, extra){
  switch(String(code||'')){
    case 'cached': return 'using cached file';
    case 'already-in-progress':
    case 'already-in-progress-hash': return 'duplicate request';
    case 'admission-denied': return 'insufficient time budget';
    case 'hard-exhausted': return 'time budget exhausted';
    case 'size-limit':
    case 'size-limit-stream': return 'size exceeds limit';
    case 'disk-insufficient':
    case 'disk-insufficient-stream': {
      const need = extra?.need || extra?.downloaded || 0, av = extra?.available || 0, res = extra?.reserve || 0;
      return `disk low; need ${bytesHuman(need)}, free ${bytesHuman(av)} (reserve ${bytesHuman(res)})`;
    }
    case 'resume-http-status':
    case 'downstream-http-status': return 'server http status';
    case 'checksum-mismatch': return 'checksum mismatch';
    case 'request-failed': return 'request failed';
    default: return code ? String(code) : '';
  }
}
function updateDlEntry(obj){
  const id = obj.id; if(!id) return;
  const e = downloads[id] || { id, first_ts: nowMs(), last_ts: 0, last_bytes: 0, finished: false };
  // Merge fields
  if(obj.status) e.status = obj.status;
  if(obj.code != null) e.code = obj.code;
  if(obj.progress != null) e.progress = obj.progress;
  if(obj.downloaded != null) e.downloaded = obj.downloaded;
  if(obj.total != null) e.total = obj.total;
  if(obj.disk != null) e.disk = obj.disk;
  if(obj.budget != null) e.budget = obj.budget;
  if(obj.error != null) e.error = obj.error;
  // Speed calc
  const t = nowMs();
  if(typeof e.downloaded === 'number'){
    if(e.last_ts){ const dt = (t - e.last_ts) / 1000.0; const db = Math.max(0, e.downloaded - (e.last_bytes||0)); e.speed_bps = dt>0 ? db/dt : e.speed_bps; }
    e.last_bytes = e.downloaded;
  }
  e.last_ts = t;
  // Finished?
  if(e.status === 'complete' || e.status === 'canceled' || e.error){ e.finished = true; }
  downloads[id] = e;
  renderDownloads();
}
function renderDownloads(){
  const el = document.getElementById('dlRows'); if(!el) return;
  const ids = Object.keys(downloads);
  // Update count badge
  const b = document.getElementById('dlCount');
  if(b){ b.className = 'badge ' + (ids.length? 'ok':'warn'); b.innerHTML = '<span class="dot"></span> ' + ids.length; }
  const lines = [];
  ids.sort();
  ids.forEach(id => {
    const d = downloads[id] || {};
    const pct = (typeof d.progress === 'number') ? Math.max(0, Math.min(100, d.progress)) : null;
    const downloaded = d.downloaded || 0; const total = d.total || 0;
    const spd = d.speed_bps ? (d.speed_bps / (1024*1024)) : null;
    const etaMs = (pct!=null && pct>0 && pct<100 && spd>0 && total>0) ? Math.round(((total - downloaded) / (spd*1024*1024)) * 1000) : null;
    const status = d.error ? 'error' : (d.status || '');
    const code = d.code; const note = d.error || codeExplain(code, d);
    const disk = d.disk; const diskTxt = (disk && typeof disk.available==='number') ? ` · disk ${bytesHuman(disk.available)} free` : '';
    const cancelBtn = (!d.finished) ? `<button class="ghost" onclick="modelsCancelId('${id.replace(/'/g,"%27")}')">Cancel</button>` : '';
    const pbar = (pct!=null) ? `<div class="pbar"><div class="pfill" style="width:${pct}%"></div></div>` : `<div class="pbar"><div class="pfill" style="width:0%"></div></div>`;
    const metaL = (total>0) ? `${bytesHuman(downloaded)} / ${bytesHuman(total)}` : `${bytesHuman(downloaded)} / ?`;
    const metaR = `${(spd!=null? spd.toFixed(2)+' MB/s' : '–')} · ETA ${etaMs!=null? msHuman(etaMs): '–'}`;
    lines.push(`<div class="dlrow">
      <div class="dlid" title="model id">${id}</div>
      <div class="dlstat">${status}${code? ' ('+code+')':''}</div>
      ${pbar}
      <div class="dlmeta" title="bytes/speed/eta">${metaL} · ${metaR}${diskTxt}</div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center">${cancelBtn}</div>
    </div>
    ${note? `<div class="dlmeta" style="margin:-4px 0 4px 150px">${note}</div>`:''}`);
  });
  el.innerHTML = lines.join('');
}

function dlClearFinished(){
  try{
    const ids = Object.keys(downloads||{});
    ids.forEach(id => { const d = downloads[id]; if (d && d.finished) delete downloads[id]; });
    renderDownloads();
  }catch{}
}

// --- Subtle Models hint ---
function modelsHintDismiss(){ try{ localStorage.setItem('arw.models.hint.dismissed','1'); const el=document.getElementById('modelsHint'); if(el) el.style.display='none'; }catch{} }
async function modelsMaybeShowHint(force){
  try{
    const dismissed = localStorage.getItem('arw.models.hint.dismissed') === '1';
    if(dismissed && !force) return;
    const r = await fetch(base + '/admin/models', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
    if(!r.ok) return;
    const list = await r.json();
    const count = Array.isArray(list) ? list.length : (Array.isArray(list?.data) ? list.data.length : 0);
    const activeDl = Object.keys(downloads||{}).length;
    const show = (count === 0) && (activeDl === 0);
    const el = document.getElementById('modelsHint'); if(!el) return;
    el.style.display = show ? 'block' : 'none';
  }catch{}
}

// Global EventSource + logger
let es = null;
function startSSE(replay, prefixes){
  try{ es?.close(); }catch{}
  let url = base + '/events';
  const qp = [];
  if (replay && replay > 0) qp.push('replay=' + encodeURIComponent(String(replay)));
  if (Array.isArray(prefixes)) {
    prefixes.forEach(p=>{ if(p) qp.push('prefix=' + encodeURIComponent(p)); });
  }
  if (qp.length){ url += '?' + qp.join('&'); }
  es = new EventSource(url);
  es.onopen = ()=> setSSE(true);
  es.onerror = ()=> setSSE(false);
  bindSSEHandlers();
}
// default SSE
document.addEventListener('DOMContentLoaded', ()=> startSSE(0, []));
function allow(kind){
  const s=document.getElementById('fService').checked;
  const m=document.getElementById('fMemory').checked;
  const o=document.getElementById('fModels').checked;
  if(kind.startsWith('service.')) return s;
  if(kind.startsWith('memory.'))  return m;
  if(kind.startsWith('models.'))  return o;
  return true;
}
function svgIcon(kind, tone){
  const cls = `ico ${tone||'info'}`;
  switch(kind){
    case 'download': return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0l4-4m-4 4L8 9M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'check':    return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6l-11 11-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'refresh':  return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 10-2.34 5.66M20 12V6m0 6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'timer':    return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8v5l3 3M9 3h6M12 21a8 8 0 100-16 8 8 0 000 16z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'warn':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9v4m0 4h.01M10.29 3.86l-8 14A2 2 0 004 21h16a2 2 0 001.71-3.14l-8-14a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'stop':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="6" width="12" height="12" rx="2" stroke="currentColor" stroke-width="2"/></svg>`;
    case 'hdd':      return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 11h.01M11 11h.01M15 11h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
    case 'cloud':    return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 19a4.5 4.5 0 100-9 5.5 5.5 0 10-10.8 1.5A3.5 3.5 0 007 19h10.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'hash':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 9h14M5 15h14M9 5L7 19M17 5l-2 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    case 'lock':     return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="11" width="14" height="9" rx="2" stroke="currentColor" stroke-width="2"/><path d="M9 11V8a3 3 0 116 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
    default:         return `<svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/></svg>`;
  }
}
function iconsFor(kind, obj){
  if (kind === 'models.download.progress'){
    const s = obj.status; const c = obj.code;
    if (s === 'complete') return svgIcon('check','ok');
    if (s === 'queued') return svgIcon('timer','info');
    if (s === 'admitted') return svgIcon('download','accent');
    if (s === 'resumed' || s === 'resync') return svgIcon('refresh','accent');
    if (s === 'started' || s === 'downloading') return svgIcon('download','accent');
    if (s === 'degraded') return svgIcon('timer','warn');
    if (s === 'canceled') return svgIcon('stop','info');
    switch(String(c||'')){
      case 'cached': return svgIcon('check','ok') + svgIcon('hash','info');
      case 'already-in-progress':
      case 'already-in-progress-hash': return svgIcon('download','warn');
      case 'admission-denied': return svgIcon('lock','bad') + svgIcon('timer','warn');
      case 'hard-exhausted':   return svgIcon('timer','bad');
      case 'size-limit':
      case 'size-limit-stream':return svgIcon('stop','bad');
      case 'disk-insufficient':
      case 'disk-insufficient-stream': return svgIcon('hdd','bad') + svgIcon('warn','warn');
      case 'checksum-mismatch':return svgIcon('hash','bad') + svgIcon('stop','bad');
      case 'request-failed':   return svgIcon('cloud','bad') + svgIcon('stop','bad');
      case 'resume-http-status':
      case 'downstream-http-status': return svgIcon('cloud','warn') + svgIcon('warn','warn');
      default: return '';
    }
  }
  return '';
}
function pushEvt(kind, data){
  if(!allow(kind)) return;
  try{ const eb=document.getElementById('eventsBadge'); if(eb){ const n=parseInt(eb.getAttribute('data-n')||'0',10)+1; eb.setAttribute('data-n', String(n)); eb.className='badge ok'; eb.innerHTML='<span class="dot"></span> Events: '+n; } }catch{}
  const div = document.createElement('div');
  div.className='evt';
  if (kind === 'models.download.progress'){
    try{
      const obj = JSON.parse(data||'{}');
      const ico = iconsFor(kind, obj);
      const id = obj.id || '';
      const base = (obj.progress!=null && obj.total) ? `${obj.progress}%` : (obj.status || '');
      const code = obj.code ? ` <span class="key">(${obj.code})</span>` : '';
      div.innerHTML = `[${new Date().toLocaleTimeString()}] ${kind}: ` + (ico? `<span class="icons">${ico}</span>` : '') + `${id} ${base}` + code;
    }catch{ div.textContent = `[${new Date().toLocaleTimeString()}] ${kind}: ${data}`; }
  } else {
    div.textContent = `[${new Date().toLocaleTimeString()}] ${kind}: ${data}`;
  }
  const log = document.getElementById('log');
  log.prepend(div);
  while (log.childElementCount > 200) log.removeChild(log.lastChild);
}
// Update Models header count via /admin/models
async function updateModelsCount(){
  try{
    const r = await fetch(base + '/admin/models', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
    if(!r.ok) return;
    const j = await r.json();
    const n = Array.isArray(j) ? j.length : (Array.isArray(j?.data) ? j.data.length : 0);
    const b = document.getElementById('modelsHdrBadge');
    if(b){ b.className = 'badge ' + (n>0 ? 'ok' : 'warn'); b.innerHTML = '<span class="dot"></span> ' + n; }
  }catch{}
}
// Track model download progress into a header badge
function bindSSEHandlers(){
es.addEventListener('models.download.progress', (e)=>{
  try{
    const obj = JSON.parse(e.data||'{}');
    // Update Download Manager
    try{ updateDlEntry(obj); }catch{}
    // Toast on start
    if (obj && obj.status === 'started' && obj.id) { try{ showToast('Downloading '+ obj.id +'…'); }catch{} }
    const b = document.getElementById('modelsBadge'); if(!b) return;
    if (obj.error){ b.className='badge bad'; b.innerHTML = '<span class="dot"></span> Models: error'; return; }
    if (obj.status === 'canceled'){ b.className='badge warn'; b.innerHTML = '<span class="dot"></span> Models: canceled'; return; }
    if (obj.status === 'complete'){ b.className='badge ok'; b.innerHTML = '<span class="dot"></span> Models: complete'; return; }
    if ((obj.code||'') === 'cached'){ b.className='badge ok'; b.innerHTML = '<span class="dot"></span> Models: cached'; return; }
    if (obj.status === 'queued'){ b.className='badge warn'; b.innerHTML = '<span class="dot"></span> Models: queued'; return; }
    if (obj.status === 'admitted'){ b.className='badge ok'; b.innerHTML = '<span class="dot"></span> Models: admitted'; return; }
    if (obj.status === 'degraded'){ b.className='badge warn'; b.innerHTML = '<span class="dot"></span> Models: degraded'; return; }
    if (obj.status === 'already-in-progress'){ b.className='badge warn'; b.innerHTML = '<span class="dot"></span> Models: duplicate'; return; }
    const pct = (obj.progress!=null)? obj.progress : null;
    if (pct!=null){ b.className='badge ok'; b.innerHTML = '<span class="dot"></span> Models: ' + pct + '%'; }
    else { b.className='badge warn'; b.innerHTML = '<span class="dot"></span> Models: active'; }
  }catch{}
});
// Live patches for models metrics (RFC 6902)
// Live patches for models metrics (RFC 6902)
// Dedicated metrics patch topic removed in favor of unified ReadModel
// Generic read-model patch stream: handle models_metrics id
es.addEventListener('state.read.model.patch', (e)=>{
  try{
    const env = JSON.parse(e.data||'{}');
    const pl = env?.payload || env;
    const p = pl?.payload || pl;
    if (p?.id === 'models_metrics' && document.getElementById('mmLive')?.checked){
      const patch = Array.isArray(p?.patch) ? p.patch : [];
      modelsMetricsApplyPatch(patch);
      modelsMetricsRender();
    }
    // Live models list/default
    if (p?.id === 'models'){
      const patch = Array.isArray(p?.patch) ? p.patch : [];
      window.__modelsRM = window.__modelsRM || { items: [], default: null };
      applyPatchObj(window.__modelsRM, patch);
      modelsRender();
    }
  }catch{}
});
// Start event + model changes
// Start event removed; rely on DownloadProgress with status='started'
es.addEventListener('models.changed', (e)=>{ pushEvt('models.changed', e.data); try{ updateModelsCount(); const j=JSON.parse(e.data||'{}'); if(j && j.op==='downloaded' && j.id){ updateDlEntry({ id:j.id, status:'complete'}); } modelsMaybeShowHint(true); }catch{} });
// Pre‑offload preview (egress)
es.addEventListener('egress.preview', (e)=>{
  pushEvt('egress.preview', e.data);
  try{
    const j = JSON.parse(e.data||'{}');
    const host = (j && j.dest && j.dest.host) || '';
    const port = (j && j.dest && j.dest.port) || '';
    const proto = (j && j.dest && j.dest.protocol) || '';
    const b = document.getElementById('egressBadge');
    if (b){ b.className='badge ok'; b.innerHTML = '<span class="dot"></span> Egress: ' + (proto||'http') + '://' + host + (port?(':'+port):''); setTimeout(()=>{ b.className='badge warn'; b.innerHTML='<span class="dot"></span> Egress: idle'; }, 4000); }
    const out = document.getElementById('egOut');
    if(out){ const row=document.createElement('div'); row.className='evt'; const url = (j && j.url) || ''; row.textContent = `${proto||'http'}://${host}${port?':'+port:''} ← ${url}`; out.prepend(row); while(out.childElementCount>100) out.removeChild(out.lastChild); }
  }catch{}
});
// Trust (RPU) change
es.addEventListener('rpu.trust.changed', (e)=>{ pushEvt('rpu.trust.changed', e.data); try{
  const j = JSON.parse(e.data||'{}');
  const newCount = Number(j?.count||0);
  const prev = Number(window.__rpuCount||0);
  const delta = newCount - prev;
  if (!Number.isNaN(delta) && delta !== 0) { showToast('RPU trust changed (' + (delta>0?('+'+delta):String(delta)) + ')'); }
  rpuRefresh();
}catch{} });
es.onmessage = (e) => pushEvt('message', e.data);
['service.connected','service.health','service.test','memory.applied','models.refreshed','tool.ran','bus.gap','beliefs.updated','intents.proposed','intents.approved','intents.rejected','actions.applied','actions.hint.applied','chat.message','world.updated','egress.preview','task.completed','experiment.activated','feedback.updated','catalog.updated'].forEach(k => {
  es.addEventListener(k, (e)=>pushEvt(k, e.data));
});
// Goldens + Experiments KPIs
es.addEventListener('goldens.evaluated', (e)=>{
  pushEvt('goldens.evaluated', e.data);
  try{
    const j = JSON.parse(e.data||'{}');
    const total = Number(j.total||0), passed = Number(j.passed||0);
    const rate = total>0 ? ((passed*100/total).toFixed(1)+'%') : '–';
    const lat = Number(j.avg_latency_ms||0).toFixed(0)+' ms';
    const sr = document.getElementById('goldSolve'); if(sr) sr.textContent = rate;
    const la = document.getElementById('goldLat'); if(la) la.textContent = lat;
  }catch{}
});
// Experiments KPIs (per-variant)
window.__expResults = window.__expResults || {}; // key: exp_id:variant -> {passed,total,avg_ms,winner}
function expKey(exp_id, variant){ return (exp_id||'') + ':' + (variant||''); }
function renderExpKpis(){
  const el = document.getElementById('expKpis'); if(!el) return;
  const entries = Object.entries(window.__expResults||{});
  if(entries.length===0){ el.style.display='none'; el.innerHTML=''; return; }
  // Group by exp_id -> variants
  const byExp = {};
  entries.forEach(([k,v])=>{ const [id,variant] = k.split(':'); if(!byExp[id]) byExp[id] = []; byExp[id].push({variant, ...v}); });
  const blocks = Object.entries(byExp).map(([id, arr])=>{
    arr.sort((a,b)=> (b.passed||0)-(a.passed||0));
    const chips = arr.map(it=>{
      const rate = (it.total>0)? ((it.passed*100/it.total).toFixed(1)+'%') : '–';
      const cls = it.winner? 'badge ok' : 'badge';
      return `<span class="${cls}" title="${id}/${it.variant}"><span class="dot"></span> ${it.variant}: ${rate} · ${it.avg_ms||0} ms</span>`;
    }).join(' ');
    return `<div class="kv"><b>${id}</b><span>${chips}</span></div>`;
  });
  el.innerHTML = blocks.join('');
  el.style.display = 'flex';
}
function expDefs(){ (async()=>{ try{
  const r = await fetch(base + '/admin/experiments/list', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
  const j = await r.json();
  const items = (j && (j.data?.items || j.items)) || [];
  const el = document.getElementById('expDefs'); if(!el) return;
  const rows = items.map(it=>{
    const vkeys = Object.keys(it.variants||{});
    const vs = vkeys.join(', ');
    const varsCsv = vkeys.join(',');
    const safeId = String(it.id||'').replace(/'/g, "%27");
    const safeVars = String(varsCsv).replace(/'/g, "%27");
    const btnRun = vkeys.length ? `<button class="ghost" onclick="expRunFromDef('${safeId}','${safeVars}')">Run A/B</button>` : '';
    const btnAct = vkeys.length ? `<button class="ghost" onclick="expActivateWinner('${safeId}')">Activate Winner</button>` : '';
    return `<div class="dlrow"><code>${it.id||''}</code> <span class="key">name</span><code>${it.name||''}</code> <span class="key">variants</span><code>${vs||'<em>none</em>'}</code> <span style="margin-left:auto">${btnRun} ${btnAct}</span></div>`;
  });
  el.innerHTML = rows.join('') || '<div class="key">no defs</div>';
}catch{ showToast('defs fetch failed'); } })(); }
function expClear(){ try{ window.__expResults = {}; const el=document.getElementById('expBoard'); if(el) el.innerHTML=''; renderExpKpis(); }catch{} }
function renderExpBoard(){
  const board = document.getElementById('expBoard'); if(!board) return;
  const entries = Object.entries(window.__expResults||{});
  if(entries.length===0){ board.innerHTML='<div class="key">no results</div>'; return; }
  // Group by exp id
  const byExp = {};
  entries.forEach(([k,v])=>{ const [id,variant]=k.split(':'); (byExp[id]=byExp[id]||[]).push({variant,...v}); });
  const blocks = Object.entries(byExp).map(([id, arr])=>{
    arr.sort((a,b)=> (b.passed||0)-(a.passed||0));
    const lines = arr.map(it=>{
      const rate = (it.total>0)? ((it.passed*100/it.total).toFixed(1)+'%') : '–';
      const star = it.winner? '★' : '';
      return `<div class="kv"><span>${it.variant}</span><span>${rate} · ${(it.avg_ms||0)} ms ${star}</span></div>`;
    }).join('');
    return `<div class="card"><div class="row"><b>${id}</b></div>${lines}</div>`;
  });
  board.innerHTML = blocks.join('');
}

async function expRunFromDef(id, varsCsv){
  try{
    const proj = document.getElementById('goldProj')?.value?.trim() || 'default';
    const vars = (varsCsv||'').split(',').map(s=>s.trim()).filter(Boolean);
    if(!id){ showToast('missing exp id'); return; }
    if(vars.length===0){ showToast('no variants'); return; }
    const body = { id, proj, variants: vars };
    const r = await fetch(base + '/admin/experiments/run', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) });
    if(!r.ok){ showToast('run failed ('+r.status+')'); return; }
    const j = await r.json();
    const data = j?.data || j;
    const el = document.getElementById('goldOut'); if(el){ el.textContent = JSON.stringify(data, null, 2); }
    showToast('A/B started for '+id+' ('+vars.join(', ')+')');
  }catch{ showToast('run failed'); }
}

async function expActivateWinner(id){
  try{
    // Try persisted winners first
    let chosen = null;
    try{
      const r = await fetch(base + '/admin/experiments/winners', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
      const j = await r.json();
      const items = (j && (j.data?.items || j.items)) || [];
      const win = items.find(w=> (w.exp_id||'')===id);
      if(win && win.variant){ chosen = { variant: win.variant, passed: win.passed, total: win.total, avg_ms: win.avg_latency_ms, winner: true }; }
    }catch{}
    const entries = Object.entries(window.__expResults||{}).filter(([k,_])=> k.startsWith(id+':'));
    if(entries.length===0 && !chosen){ showToast('no results for '+id); return; }
    for(const [k,v] of entries){ if(v && v.winner){ chosen = { variant: k.split(':')[1], ...v }; break; } }
    if(!chosen){
      for(const [k,v] of entries){
        const varName = k.split(':')[1];
        if(!chosen || (v.passed||0) > (chosen.passed||0) || ((v.passed||0)===(chosen.passed||0) && (v.avg_ms||1e18) < (chosen.avg_ms||1e18))){
          chosen = { variant: varName, ...v };
        }
      }
    }
    if(!chosen || !chosen.variant){ showToast('no winner found for '+id); return; }
    const body = { id, variant: chosen.variant };
    const r = await fetch(base + '/admin/experiments/activate', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) });
    if(!r.ok){ showToast('activate failed ('+r.status+')'); return; }
    showToast('Activated '+id+'/'+chosen.variant);
  }catch{ showToast('activate failed'); }
}

async function expFetchBoardAndWinners(){
  const sb = await (await fetch(base + '/admin/experiments/scoreboard', { headers: { 'X-ARW-Admin': __adminHeader || '' } })).json();
  const board = (sb && (sb.data?.items || sb.items)) || [];
  const wins = await (await fetch(base + '/admin/experiments/winners', { headers: { 'X-ARW-Admin': __adminHeader || '' } })).json();
  const winners = (wins && (wins.data?.items || wins.items)) || [];
  return { board, winners };
}

async function expCopyJSON(){ try{
  const { board, winners } = await expFetchBoardAndWinners();
  const payload = { scoreboard: board, winners };
  await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
  showToast('Scoreboard JSON copied');
}catch{ showToast('copy failed'); } }

async function expExportCSV(){ try{
  const { board, winners } = await expFetchBoardAndWinners();
  const winMap = Object.create(null);
  winners.forEach(w=>{ winMap[(w.exp_id||'')+':' + (w.variant||'')] = true; });
  const rows = [ ['exp_id','proj','variant','passed','total','failed','avg_latency_ms','avg_ctx_tokens','avg_ctx_items','time','winner'] ];
  board.forEach(r=>{
    const k = (r.exp_id||'')+':' + (r.variant||'');
    const sc = r.score || {};
    rows.push([ r.exp_id||'', r.proj||'', r.variant||'', sc.passed||0, sc.total||0, sc.failed||0, sc.avg_latency_ms||0, sc.avg_ctx_tokens||0, sc.avg_ctx_items||0, sc.time||'', winMap[k] ? '1':'0' ]);
  });
  const csv = rows.map(row=> row.map(v=>{
    const s = String(v);
    return (s.includes(',')||s.includes('"')||s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s;
  }).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'experiments_scoreboard.csv';
  document.body.appendChild(a); a.click(); a.remove();
  showToast('Scoreboard exported');
}catch{ showToast('export failed'); } }
es.addEventListener('experiment.result', (e)=>{ pushEvt('experiment.result', e.data); try{
  const j = JSON.parse(e.data||'{}');
  const id = j.exp_id || (document.getElementById('expId')?.value||'');
  const key = expKey(id, j.variant||'');
  window.__expResults[key] = { passed: j.passed||0, total: j.total||0, avg_ms: j.avg_latency_ms||0, avg_ctx_tokens: j.avg_ctx_tokens||0, avg_ctx_items: j.avg_ctx_items||0, winner: false };
  renderExpKpis();
  try{ if(document.getElementById('expLive')?.checked){ renderExpBoard(); } }catch{}
}catch{} });
es.addEventListener('experiment.winner', (e)=>{ pushEvt('experiment.winner', e.data); try{
  const j = JSON.parse(e.data||'{}');
  const id = j.exp_id || (document.getElementById('expId')?.value||'');
  const w = j.winner || '';
  // reset winners for this exp
  Object.keys(window.__expResults||{}).forEach(k=>{ if(k.startsWith(id+':')) window.__expResults[k].winner = false; });
  const key = expKey(id, w);
  if(window.__expResults[key]) window.__expResults[key].winner = true;
  renderExpKpis();
  try{ if(document.getElementById('expLive')?.checked){ renderExpBoard(); } }catch{}
}catch{} });
// Planner hint
es.addEventListener('chat.planner', (e)=>{
  pushEvt('chat.planner', e.data);
});
// Feedback live updates
  es.addEventListener('feedback.suggested', (e)=>{
    pushEvt('feedback.suggested', e.data);
    try{ const j=JSON.parse(e.data); document.getElementById('fbLiveOut').textContent = JSON.stringify(j,null,2); fbRenderList(j); }catch{}
  });
  // Auto-refresh Project Map on World updates
  es.addEventListener('world.updated', async (e)=>{
    pushEvt('world.updated', e.data);
    const live = document.getElementById('wmLive');
    if (live && live.checked){ try{ await worldMapRefresh(); }catch{} }
  });
// Show probe events
es.addEventListener('chat.probe', (e)=>{
  pushEvt('chat.probe', e.data);
});

// Insights aggregation overlay
const agg = { total:0, kinds:{} };
let routesCache = {};
function renderInsights(){
  const el = document.getElementById('insights'); if(!el) return;
  const lines = [ `<h4>Events</h4>`, `<div class='kv'><b>Total</b><span>${agg.total}</span></div>` ];
  Object.entries(agg.kinds).slice(0,6).forEach(([k,v])=>{ lines.push(`<div class='kv'><span>${k}</span><span>${v}</span></div>`); });
  const entries = Object.entries(routesCache || {}).map(([p,st])=>({p,st})).sort((a,b)=> (b.st.p95_ms||0)-(a.st.p95_ms||0)).slice(0,3);
  if(entries.length){
    lines.push('<h4>Routes</h4>');
    entries.forEach(({p,st})=>{ lines.push(`<div class='kv'><span>${p}</span><span>p95:${st.p95_ms||0} ms · ewma:${(st.ewma_ms||0).toFixed(0)} ms · e:${st.errors||0}</span></div>`); });
  }
  el.innerHTML = lines.join('');
}
// Apply JSON Patch to a nested object (add/replace/remove for simple paths)
function applyPatchObj(target, patch){ try{
  const unesc = (s)=> s.replace(/~1/g,'/').replace(/~0/g,'~');
  const getSegs = (path)=> path.split('/').slice(1).map(decodeURIComponent).map(unesc);
  for(const op of patch||[]){
    const segs = getSegs(op.path||'');
    if(segs.length===0) continue;
    let cur = target;
    for(let i=0;i<segs.length-1;i++){
      const k = segs[i];
      if(!(k in cur) || typeof cur[k] !== 'object' || cur[k]===null){ cur[k] = {}; }
      cur = cur[k];
    }
    const last = segs[segs.length-1];
    if(op.op==='remove'){
      delete cur[last];
    } else if(op.op==='add' || op.op==='replace'){
      cur[last] = op.value;
    }
  }
}catch{}}
['service.connected','service.health','service.test','memory.applied','models.refreshed','tool.ran','chat.message','governor.changed','bus.gap','beliefs.updated','intents.proposed','intents.approved','intents.rejected','actions.applied','actions.hint.applied','world.updated','egress.preview','task.completed','experiment.activated','feedback.updated','catalog.updated'].forEach(k => {
  es.addEventListener(k, (e)=>{ agg.total++; agg.kinds[k]=(agg.kinds[k]||0)+1; renderInsights(); });
});
  // System metrics (low-frequency)
  es.addEventListener('probe.metrics', (e)=>{
    try{ const j=JSON.parse(e.data||'{}'); updateSystemFromMetrics(j); }catch{}
  });
  // Route stats read-model patches
  es.addEventListener('state.read.model.patch', (e)=>{
    try{
      const env = JSON.parse(e.data||'{}');
      const p = env && env.payload ? env.payload : env;
      const patch = Array.isArray(p?.patch) ? p.patch : [];
      window.__routeStatsRM = window.__routeStatsRM || { by_path: {} };
      applyPatchObj(window.__routeStatsRM, patch);
      routesCache = (window.__routeStatsRM && window.__routeStatsRM.by_path) || {};
      renderInsights();
      if (document.getElementById('routesLive')?.checked) routesPanelRender();
    }catch{}
  });
  es.addEventListener('state.read.model.patch', (e)=>{
    try{
      const env = JSON.parse(e.data||'{}');
      const pl = env?.payload || env;
      const p = pl?.payload || pl;
      if(p?.id === 'route_stats'){
        const patch = Array.isArray(p?.patch) ? p.patch : [];
        window.__routeStatsRM = window.__routeStatsRM || { by_path: {} };
        applyPatchObj(window.__routeStatsRM, patch);
        routesCache = (window.__routeStatsRM && window.__routeStatsRM.by_path) || {};
        renderInsights();
        if (document.getElementById('routesLive')?.checked) routesPanelRender();
      }
    }catch{}
  });
  // Self‑model live refresh on related events
  es.addEventListener('tool.ran', ()=>{ try{ const cb=document.getElementById('selfLive'); if(cb && cb.checked){ selfView(); } }catch{} });
  es.addEventListener('self.model.updated', ()=>{ try{ const cb=document.getElementById('selfLive'); if(cb && cb.checked){ selfView(); } }catch{} });
}

// --- System/HW helpers ---
function bytesHuman(n){ if(!n && n!==0) return '–'; const kb=1024, mb=kb*1024, gb=mb*1024, tb=gb*1024; if(n>=tb) return (n/tb).toFixed(2)+' TiB'; if(n>=gb) return (n/gb).toFixed(2)+' GiB'; if(n>=mb) return (n/mb).toFixed(1)+' MiB'; if(n>=kb) return (n/kb).toFixed(1)+' KiB'; return n+' B'; }
function escAttr(s){ try{ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;'); }catch{ return ''; } }
function setMemBadge(used,total){ try{ const el=document.getElementById('memBadge'); if(!el) return; const pct = total>0? (100*used/total) : 0; const txt = `Mem: ${pct.toFixed(1)}% (${bytesHuman(used)}/${bytesHuman(total)})`; el.innerHTML = '<span class="dot"></span> '+txt; el.className = 'badge ' + (pct>=90? 'bad' : pct>=75 ? 'warn' : 'ok'); }catch{} }
function setCpuBadge(pct){ try{ const el=document.getElementById('cpuBadge'); if(!el) return; const p = Number(pct)||0; el.innerHTML = '<span class="dot"></span> CPU: ' + p.toFixed(1) + '%'; el.className = 'badge ' + (p>=90? 'bad' : p>=75 ? 'warn' : 'ok'); }catch{} }
function setGpuBadge(used,total){ try{ const el=document.getElementById('gpuBadge'); if(!el) return; const pct = total>0? (100*used/total) : 0; const txt = `GPU: ${pct.toFixed(1)}% (${bytesHuman(used)}/${bytesHuman(total)})`; el.innerHTML = '<span class="dot"></span> '+txt; el.className = 'badge ' + (pct>=95? 'bad' : pct>=80 ? 'warn' : 'ok'); }catch{} }
function updateSystemFromMetrics(m){ try{
  const cpuAvg = (m?.cpu ?? m?.cpu_avg ?? 0);
  const memUsed = m?.mem?.used ?? m?.mem_used; const memTotal = m?.mem?.total ?? 0;
  const disk = m?.disk || {}; const dAvail = disk.available, dTotal = disk.total;
  const sysCpu = document.getElementById('sysCpu'); if(sysCpu) sysCpu.textContent = (typeof cpuAvg==='number'? cpuAvg.toFixed(1) : String(cpuAvg)) + ' %';
  setCpuBadge(cpuAvg||0);
  const sysMem = document.getElementById('sysMem'); if(sysMem) sysMem.textContent = `${bytesHuman(memUsed)} / ${bytesHuman(memTotal)}`;
  const sysDisk = document.getElementById('sysDisk'); if(sysDisk) sysDisk.textContent = `${bytesHuman(dAvail)} free / ${bytesHuman(dTotal)} total`;
  const sysGpu = document.getElementById('sysGpu'); if(sysGpu) sysGpu.textContent = Array.isArray(m?.gpus)? String(m.gpus.length) : '0';
  const sysNpu = document.getElementById('sysNpu'); if(sysNpu) sysNpu.textContent = Array.isArray(m?.npus)? String(m.npus.length) : '0';
  setMemBadge(memUsed||0, memTotal||0);
  // GPU badge aggregate
  try{
    const arr = Array.isArray(m?.gpus) ? m.gpus : [];
    let total=0, used=0; for(const g of arr){ total += Number(g?.mem_total||0); used += Number(g?.mem_used||0); }
    setGpuBadge(used, total);
  }catch{}
  const out = document.getElementById('sysOut'); if(out){ const merged = { cpu_avg: cpuAvg, mem: m.mem, disk: m.disk, gpus: m.gpus, npus: m.npus }; out.textContent = JSON.stringify(merged, null, 2); }
  // Render GPU adapters list (collapsible)
  try{
    const div = document.getElementById('gpuList'); if (div){
      const arr = Array.isArray(m?.gpus) ? m.gpus : [];
      if (arr.length === 0) { div.innerHTML = '<div class="key">no adapters</div>'; }
      else {
        const rows = arr.map((g)=>{
          const name = escAttr(g?.name || g?.index || 'adapter');
          const ven = escAttr(g?.vendor_id || g?.vendor || '');
          const used = (g?.mem_used!=null) ? bytesHuman(Number(g.mem_used)) : '–';
          const total = (g?.mem_total!=null) ? bytesHuman(Number(g.mem_total)) : '–';
          const busy = (g?.busy_percent!=null) ? String(g.busy_percent)+'%' : '';
          return `<div class="kv"><b>${name}</b><span>${ven}</span><span>${used} / ${total} ${busy}</span></div>`;
        }).join('');
        div.innerHTML = rows;
      }
    }
  }catch{}
}catch{} }
// Toggle GPU list
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('gpuToggle');
  if (btn) btn.addEventListener('click', ()=>{
    const div = document.getElementById('gpuList'); if (!div) return;
    div.style.display = (div.style.display === 'none') ? 'block' : 'none';
  });
});
// --- Models Metrics (read-model) ---
let modelsMetrics = {};
function modelsMetricsRender(){ try{
  const get = (k)=> modelsMetrics && (modelsMetrics[k] ?? modelsMetrics.data?.[k]);
  const setTxt = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = (id==='mmBytes')? bytesHuman(v||0) : String(v??'0'); };
  setTxt('mmStarted', get('started')||0);
  setTxt('mmQueued', get('queued')||0);
  setTxt('mmAdmitted', get('admitted')||0);
  setTxt('mmResumed', get('resumed')||0);
  setTxt('mmCanceled', get('canceled')||0);
  setTxt('mmCompleted', get('completed')||0);
  setTxt('mmCompletedCached', get('completed_cached')||0);
  setTxt('mmErrors', get('errors')||0);
  setTxt('mmBytes', get('bytes_total')||0);
  const ew = get('ewma_mbps'); const el=document.getElementById('mmEwma'); if(el) el.textContent = (typeof ew==='number')? ew.toFixed(2) : (ew==null? '–' : String(ew));
}catch{}}
async function modelsMetricsRefresh(){
  try{
    const r = await fetch(base + '/admin/state/models_metrics', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
    const j = await r.json();
    modelsMetrics = j?.data || j || {};
    modelsMetricsRender();
  }catch{ showToast('models metrics fetch failed'); }
}
function modelsMetricsApplyPatch(patch){ try{
  if(!Array.isArray(patch)) return;
  const ptrKey = (p)=> decodeURIComponent(String(p||'').replace(/^\//,'').replace(/~1/g,'/').replace(/~0/g,'~'));
  for(const op of patch){
    const k = ptrKey(op.path);
    if(!k) continue;
    if(op.op==='remove'){
      delete modelsMetrics[k];
    } else if(op.op==='add' || op.op==='replace'){
      modelsMetrics[k] = op.value;
    }
  }
}catch{}}
document.addEventListener('DOMContentLoaded', ()=>{
  const cb=document.getElementById('mmLive'); if(cb){ cb.addEventListener('change', ()=>{}); }
  modelsMetricsRefresh();
});
// --- Models read-model live rendering ---
function modelsRender(){ try{
  const rm = window.__modelsRM || { items: [], default: null };
  const items = Array.isArray(rm.items) ? rm.items.slice() : [];
  // Stable order: default first, then by id
  items.sort((a,b)=>{
    const da = (a?.id===rm.default)? -1 : 0; const db = (b?.id===rm.default)? -1 : 0; if(da!==db) return da-db; return String(a?.id||'').localeCompare(String(b?.id||''));
  });
  const tbl = document.getElementById('modelsTable'); if(!tbl) return;
  const head = `<div class="mrow mhead">
      <div class="mcell id">id</div>
      <div class="mcell">provider</div>
      <div class="mcell">status</div>
      <div class="mcell">size</div>
      <div class="mcell">file</div>
      <div class="mcell sha">sha256</div>
      <div class="mcell actions">actions</div>
    </div>`;
  const basename = (p)=>{ try{ if(!p) return ''; const i=p.lastIndexOf('/'); return i>=0? p.slice(i+1): p; }catch{ return String(p||''); } };
  const shortSha = (s)=>{ try{ return s? String(s).slice(0,8)+'…' : ''; }catch{ return ''; } };
  const statusBadge = (st)=>{ const s=String(st||'').toLowerCase(); const tone = s==='available'? 'ok' : s==='downloading'? 'warn' : s==='error'? 'bad' : 'warn'; return `<span class="badge ${tone} small">${st||'–'}</span>`; };
  const rows = items.map(m=>{
    const id = m?.id||''; const prov=m?.provider||'local'; const st=m?.status||'available';
    const bytes = typeof m?.bytes==='number'? m.bytes : null; const size = bytes!=null? bytesHuman(bytes) : '–';
    const file = m?.file || basename(m?.path||''); const sha = shortSha(m?.sha256);
    const def = (rm.default && id===rm.default) ? `<span class=\"badge ok small\" title=\"default model\">default</span>` : '';
    const sid = String(id).replace(/[^a-zA-Z0-9_-]/g,'_');
    const btnSetDef = `<button class=\"ghost\" title=\"Set default\" onclick=\"modelsRowSetDefault('${id.replace(/'/g, \"%27\")}')\">Default</button>`;
    const btnDl = `<button class=\"ghost\" title=\"Download model\" onclick=\"modelsRowDownloadInline('${sid}','${id.replace(/'/g, \"%27\")}','${(prov||'').replace(/'/g, '%27')}')\">Download</button>`;
    const btnDel = `<button class=\"ghost\" title=\"Delete model entry\" onclick=\"modelsRowDelete('${id.replace(/'/g, \"%27\")}')\">Delete</button>`;
    const btnCancel = (String(st).toLowerCase()==='downloading') ? `<button class=\"ghost\" title=\"Cancel download\" onclick=\"modelsCancelId('${id.replace(/'/g, \"%27\")}')\">Cancel</button>` : '';
    return `<div class=\"mrow\">\n
      <div class="mcell id">${id} ${def}</div>
      <div class="mcell">${prov||'–'}</div>
      <div class="mcell">${statusBadge(st)}</div>
      <div class="mcell">${size}</div>
      <div class="mcell" title="${file}">${file||'–'}</div>
      <div class=\"mcell sha\" title=\"${m?.sha256||''}\">${sha}</div>
      <div class=\"mcell actions\">\n        <input id=\"mUrl-${sid}\" class=\"mini\" placeholder=\"url\" value=\"${escAttr(m?.url||'')}\">\n        <input id=\"mSha-${sid}\" class=\"mini\" placeholder=\"sha256\" value=\"${escAttr(m?.sha256||'')}\">\n        ${btnSetDef} ${btnDl} ${btnDel} ${btnCancel}\n      </div>\n    </div>`;
  });
  tbl.innerHTML = head + (rows.join('') || '<div class="mrow"><div class="mcell">no models</div></div>');
  const badge = document.getElementById('modelsHdrBadge');
  if(badge){ const n = items.length; badge.className = 'badge ' + (n>0 ? 'ok' : 'warn'); badge.innerHTML = '<span class="dot"></span> ' + n + (rm.default? ' · default: '+rm.default : ''); }
}catch{}}
// Row actions
async function modelsRowSetDefault(id){ try{
  await fetch(base + '/admin/models/default', { method:'POST', headers:{ 'Content-Type':'application/json','X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify({id}) });
  window.__modelsRM = window.__modelsRM || { items: [], default: null }; window.__modelsRM.default = id; modelsRender(); showToast('Default set: ' + id);
}catch{ showToast('Set default failed'); }}
async function modelsRowDelete(id){ try{
  if(!confirm('Delete model entry ' + id + '?')) return;
  await fetch(base + '/admin/models/delete', { method:'POST', headers:{ 'Content-Type':'application/json','X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify({id}) });
  window.__modelsRM = window.__modelsRM || { items: [], default: null };
  if(Array.isArray(window.__modelsRM.items)){
    window.__modelsRM.items = window.__modelsRM.items.filter(m=> (m?.id)!==id);
  }
  modelsRender(); showToast('Deleted: ' + id);
}catch{ showToast('Delete failed'); }}
async function modelsRowDownloadInline(sid, id, prov){ try{
  const url = document.getElementById('mUrl-' + sid)?.value || '';
  const sha = document.getElementById('mSha-' + sid)?.value || '';
  if(!url){ showToast('Missing URL'); return; }
  if(!sha){ showToast('SHA-256 required'); return; }
  const body = { id, url, provider: prov||'local', sha256: sha };
  const r = await fetch(base + '/admin/models/download', { method:'POST', headers:{ 'Content-Type':'application/json','X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) });
  if(!r.ok){ showToast('Download request failed ('+r.status+')'); return; }
  showToast('Downloading ' + id + '…');
}catch{ showToast('Download request failed'); }}
async function modelsRowDownload(id){ try{
  const rm = window.__modelsRM || { items:[], default:null };
  const item = (Array.isArray(rm.items)? rm.items.find(m=> (m?.id)===id) : null) || {};
  const prov = item?.provider || (document.getElementById('mProv')?.value || 'local');
  const defUrl = item?.url || (document.getElementById('mUrl')?.value || '');
  const defSha = item?.sha256 || (document.getElementById('mSha')?.value || '');
  const url = prompt('Download URL for ' + id + ':', defUrl);
  if(!url) return;
  const sha = prompt('SHA-256 (required):', defSha);
  if(!sha){ showToast('SHA-256 required'); return; }
  const body = { id, url, provider: prov, sha256: sha };
  const r = await fetch(base + '/admin/models/download', { method:'POST', headers:{ 'Content-Type':'application/json','X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) });
  if(!r.ok){ showToast('Download request failed ('+r.status+')'); return; }
  showToast('Downloading ' + id + '…');
}catch{ showToast('Download request failed'); }}
// Specific models topic removed; rely on state.read.model.patch (id='models')
// --- Routes panel helpers ---
function msfmt(n){ try{ const v=Number(n||0); return v.toFixed(0)+' ms'; }catch{ return String(n||0);} }
function routesPanelRender(){ try{
  const cont = document.getElementById('routesTable'); if(!cont) return;
  const sortBy = (document.getElementById('routesSort')?.value)||'p95';
  const topN = parseInt(document.getElementById('routesTopN')?.value||'10',10) || 10;
  const entries = Object.entries(routesCache||{}).map(([p,st])=>({p,st}));
  const key = (e)=>{
    switch(sortBy){
      case 'ewma': return e.st.ewma_ms||0;
      case 'hits': return e.st.hits||0;
      case 'errors': return e.st.errors||0;
      default: return e.st.p95_ms||0;
    }
  };
  entries.sort((a,b)=> key(b)-key(a));
  const rows = entries.slice(0, topN).map(({p,st})=>{
    const hits = st.hits||0, errs = st.errors||0, p95=st.p95_ms||0, ew=st.ewma_ms||0, mx=st.max_ms||0;
    const errRate = hits>0 ? ((errs*100/hits).toFixed(1)+'%') : '0%';
    return `<div class="dlrow" style="gap:6px">
      <code style="min-width:220px">${p}</code>
      <span class="key">hits</span><code>${hits}</code>
      <span class="key">errors</span><code>${errs} <span class="key">(${errRate})</span></code>
      <span class="key">p95</span><code>${msfmt(p95)}</code>
      <span class="key">ewma</span><code>${msfmt(ew)}</code>
      <span class="key">max</span><code>${msfmt(mx)}</code>
    </div>`;
  });
  cont.innerHTML = rows.length? rows.join('') : '<div class="key">no data</div>';
}catch{}}
async function routesPanelRefresh(){ try{
  const r = await fetch(base + '/state/route_stats');
  const j = await r.json();
  window.__routeStatsRM = j || { by_path:{} };
  routesCache = (window.__routeStatsRM && window.__routeStatsRM.by_path) || {};
  routesPanelRender();
}catch{ showToast('routes fetch failed'); }}
document.addEventListener('DOMContentLoaded', ()=>{
  const s=document.getElementById('routesSort'); if(s){ s.addEventListener('change', routesPanelRender); }
  const n=document.getElementById('routesTopN'); if(n){ n.addEventListener('change', routesPanelRender); }
  routesPanelRefresh();
});
async function refreshMetrics(){ try{ const r = await fetch(base + '/admin/probe/metrics', { headers: { 'X-ARW-Admin': __adminHeader || '' } }); const j = await r.json(); if(j && j.ok){ updateSystemFromMetrics(j.data); } }catch(e){} }
async function refreshHW(){ try{ const r = await fetch(base + '/admin/probe/hw', { headers: { 'X-ARW-Admin': __adminHeader || '' } }); const j = await r.json(); const out = document.getElementById('sysOut'); if(out){ out.textContent = JSON.stringify(j?.data || j, null, 2); } }catch(e){} }

// --- Goldens/Experiments panel ---
async function goldList(){ try{ const proj = document.getElementById('goldProj').value.trim() || 'default'; const r = await fetch(base + '/admin/goldens/list?proj=' + encodeURIComponent(proj), { headers: { 'X-ARW-Admin': __adminHeader || '' } }); const j = await r.json(); const el = document.getElementById('goldOut'); if(el){ el.textContent = JSON.stringify(j?.data || j, null, 2); } }catch{ showToast('goldens list failed'); } }
async function goldRun(){ try{ const proj = document.getElementById('goldProj').value.trim() || 'default'; const vote_k = parseInt(document.getElementById('goldVoteK').value||'3',10)||3; const body = { proj, vote_k }; const r = await fetch(base + '/admin/goldens/run', { method:'POST', headers:{ 'Content-Type':'application/json','X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) }); const j = await r.json(); const data = j?.data || j; const el = document.getElementById('goldOut'); if(el){ el.textContent = JSON.stringify(data, null, 2); } const total = Number(data.total||0), passed = Number(data.passed||0); const rate = total>0 ? ((passed*100/total).toFixed(1)+'%') : '–'; document.getElementById('goldSolve').textContent = rate; document.getElementById('goldLat').textContent = String(data.avg_latency_ms||0)+' ms'; }catch{ showToast('goldens run failed'); } }
async function expDefine(){ try{ const id = (document.getElementById('expId').value||'exp').trim() || 'exp'; const body = { id, name: id, variants: { "A": { vote_k: 1, retrieval_k: 8, retrieval_div: 0.3 }, "B": { vote_k: 5, retrieval_k: 20, retrieval_div: 0.3 } } }; const r = await fetch(base + '/admin/experiments/define', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) }); if(r.ok){ showToast('Experiment defined'); } else { showToast('Define failed ('+r.status+')'); } }catch{ showToast('define failed'); } }
async function expRun(){ try{ const id = (document.getElementById('expId').value||'exp').trim() || 'exp'; const proj = document.getElementById('goldProj').value.trim() || 'default'; const vars = (document.getElementById('expVar').value||'A,B').split(',').map(s=>s.trim()).filter(Boolean); const body = { id, proj, variants: vars }; const r = await fetch(base + '/admin/experiments/run', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) }); const j = await r.json(); const data = j?.data || j; const el = document.getElementById('goldOut'); if(el){ el.textContent = JSON.stringify(data, null, 2); } }catch{ showToast('run failed'); } }
async function expActivate(){ try{ const id = (document.getElementById('expId').value||'exp').trim() || 'exp'; const varStr = (document.getElementById('expVar').value||'A').split(',')[0].trim() || 'A'; const body = { id, variant: varStr }; const r = await fetch(base + '/admin/experiments/activate', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) }); if(r.ok){ showToast('Activated '+id+'/'+varStr); } else { showToast('activate failed ('+r.status+')'); } }catch{ showToast('activate failed'); } }

// --- Self-tests (unchanged from last patch; reuses global SSE) ---
function clearTests(){ document.getElementById('tests').textContent = 'Ready.'; }
function logT(msg, cls){
  const el = document.getElementById('tests');
  if(el.textContent === 'Ready.') el.textContent = '';
  const line = document.createElement('div');
  line.textContent = msg; if(cls) line.className = cls;
  el.appendChild(line);
}
async function jget(path){
  const headers = {};
  if (__adminHeader) headers['X-ARW-Admin'] = __adminHeader;
  const r = await fetch(base+path,{ headers });
  if(!r.ok) throw new Error(r.status);
  return r.json();
}
async function jpost(path, body){
  const headers = { 'Content-Type': 'application/json' };
  if (__adminHeader) headers['X-ARW-Admin'] = __adminHeader;
  const r = await fetch(base+path,{method:'POST',headers,body:JSON.stringify(body||{})});
  if(!r.ok) throw new Error(r.status);
  return r.json();
}
function extractTestId(obj){
  try{
    if (obj?.payload?.payload?.value?.test_id) return obj.payload.payload.value.test_id;
    if (obj?.payload?.value?.test_id) return obj.payload.value.test_id;
    if (obj?.value?.test_id) return obj.value.test_id;
    if (obj?.test_id) return obj.test_id;
  }catch{}
  return undefined;
}
function waitForMemoryApplied(target, timeoutMs){
  return new Promise(resolve => {
    let settled = false;
    const done = ok => { if(!settled){ settled=true; clearTimeout(timer); es.removeEventListener('memory.applied', onNamed); es.removeEventListener('message', onMsg); resolve(ok); } };
    function maybeResolve(dataText){
      try{
        const obj = JSON.parse(dataText || '{}');
        const kind = obj?.kind;
        if (kind && kind !== 'memory.applied') return;
        const tid = extractTestId(obj);
        if (tid && target && tid !== target) return;
        done(true);
      }catch{}
    }
    const onNamed = (e)=> maybeResolve(e.data);
    const onMsg   = (e)=> maybeResolve(e.data);
    es.addEventListener('memory.applied', onNamed);
    es.addEventListener('message',       onMsg);
    const timer = setTimeout(()=> done(false), timeoutMs || 3500);
  });
}
async function runSelfTests(){
  clearTests();
  const pass = m => logT('✔ ' + m, 'pass');
  const fail = (m,e) => logT('✘ ' + m + ' — ' + (e && e.message ? e.message : e), 'fail');

  try { const v = await jget('/version'); if(v.service && v.version){ pass('/version'); } else { fail('/version','missing keys'); } } catch(e){ fail('/version',e); }
  try { const a = await jget('/about'); if(Array.isArray(a.endpoints)){ pass('/about'); } else { fail('/about','missing endpoints'); } } catch(e){ fail('/about',e); }
  try { const t = await jget('/introspect/tools'); if(Array.isArray(t) && t.length>=2){ pass('/introspect/tools'); } else { fail('/introspect/tools','unexpected'); } } catch(e){ fail('/introspect/tools',e); }

  try { await jpost('/admin/memory/apply',{lane:'ephemeral',value:{ from:'selftest', t: Date.now() }}); const m = await jget('/admin/memory?limit=5'); if(m && (m.items||m.data?.items)){ pass('POST /admin/memory/apply + GET /admin/memory'); } else { fail('memory','unexpected'); } } catch(e){ fail('memory',e); }

  try {
    const target = 'ui_selftest_' + Date.now();
    const waiter = waitForMemoryApplied(target, 3500);
    await jpost('/admin/memory/apply',{lane:'ephemeral',value:{ test:'selftest', test_id: target, t: Date.now() }});
    const ok = await waiter;
    if(ok){ pass('SSE memory.applied'); } else { fail('SSE memory.applied','timeout'); }
  } catch(e){ fail('SSE memory.applied',e); }

  logT('Done.');
}
// Self-learning fns
async function fbState(){ await req('GET','/feedback/state',null,'fbOut','rt-orch'); }
async function fbAnalyze(){ await req('POST','/feedback/analyze',{},'fbOut','rt-orch'); }
async function fbSignal(){
  const kind=document.getElementById('sigKind').value;
  const target=document.getElementById('sigTarget').value||'';
  const confidence=parseFloat(document.getElementById('sigConf').value||'0.7');
  const severity=parseInt(document.getElementById('sigSev').value||'2',10);
  const note=document.getElementById('sigNote').value||undefined;
  await req('POST','/feedback/signal',{kind,target,confidence,severity,note},'fbOut','rt-orch');
}
async function fbAuto(){ const enabled=document.getElementById('autoApply').checked; await req('POST','/feedback/auto',{enabled},'fbOut','rt-orch'); }
async function fbReset(){ await req('POST','/feedback/reset',{},'fbOut','rt-orch'); }
async function fbApply(){ const id=(document.getElementById('fbApplyId').value||'').trim(); if(!id){ showToast('Enter suggestion id'); return; } await req('POST','/feedback/apply',{id},'fbOut','rt-orch'); }
async function fbFetchSuggestions(){ const txt = await req('GET','/feedback/suggestions',null,'fbLiveOut','rt-orch'); try{ const j=JSON.parse(txt); fbRenderList(j); __fbVersion = (j && j.version) || 0; }catch{} }
async function fbFetchSuggestions(){ await req('GET','/feedback/suggestions',null,'fbLiveOut','rt-orch'); }
function fbRenderList(j){
  const el = document.getElementById('fbList'); if(!el) return;
  const list = (j && j.suggestions) || [];
  const vb = document.getElementById('fbVerBadge'); if(vb){ const v=(j&&j.version)||0; vb.className='badge ' + (v>0?'ok':'warn'); vb.innerHTML='<span class="dot"></span> v'+v; }
  if(!Array.isArray(list) || list.length===0){ el.innerHTML = '<div class="key">no suggestions</div>'; return; }
  const cls = (c)=> c>=0.8? 'ok' : (c>=0.5? 'warn' : 'bad');
  const rows = list.map(s => {
    const id = s.id || '(unknown)';
    const action = s.action || '?';
    const cnum = (typeof s.confidence==='number') ? s.confidence : 0.0;
    const conf = cnum.toFixed(2);
    const rationale = s.rationale || '';
    const params = JSON.stringify(s.params||{}, null, 0);
    return `<div style="display:flex; gap:8px; align-items:center; margin:4px 0">
      <code style="min-width:120px">${action}</code>
      <span class="key">id</span><code>${id}</code>
      <span class="badge ${cls(cnum)}" title="confidence">${conf}</span>
      <button class="iconbtn" onclick="fbApplyId('${id}')">Apply</button>
      <span class="key">params</span><code>${params}</code>
      ${rationale ? `<span class="key">why</span><code>${rationale}</code>` : ''}
    </div>`;
  });
  el.innerHTML = rows.join('');
}
async function fbApplyId(id){
  if(!id) return;
  try{
    const resp = await fetch(base + '/feedback/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id}) });
    const txt = await resp.text();
    try{
      const j = JSON.parse(txt);
      if(j && j.ok){ showToast('Applied'); }
      else { showToast('Apply failed: ' + (j && j.reason || 'unknown')); }
      document.getElementById('fbOut').textContent = JSON.stringify(j,null,2);
    }catch{
      showToast('Apply error');
    }
  }catch{ showToast('Network error'); }
}
async function fbFetchPolicy(){
  try{ const r = await fetch(base + '/feedback/policy'); const j = await r.json(); const el=document.getElementById('fbBounds'); if(el){ el.textContent = `caps: ${j.apply_per_hour||3}/h · http_timeout ${j.http_timeout_min||5}..${j.http_timeout_max||300}s · mem_limit ${j.mem_limit_min||50}..${j.mem_limit_max||2000}`; } }catch{}
}
let __fbVersion = 0;
let __fbTimer = null;
async function fbLiveTick(){
  try{
    const r = await fetch(base + '/feedback/updates?since=' + (__fbVersion||0));
    if(r.status === 200){ const j = await r.json(); __fbVersion = j.version || 0; fbRenderList(j); const out=document.getElementById('fbLiveOut'); if(out){ out.textContent = JSON.stringify(j,null,2);} }
  }catch{}
}
function fbLiveSet(on){ if(__fbTimer){ clearInterval(__fbTimer); __fbTimer = null; } if(on){ fbLiveTick(); __fbTimer = setInterval(fbLiveTick, 3000); } }
// Docs wiring
let docsBase = null;
function docPath(key){
  switch(key){
    case 'memory': return '/memory_and_training/';
    case 'events': return '/guide/quickstart/';
    case 'tools': return '/api_and_schema/';
    case 'orchestrator': return '/guide/quickstart/';
    case 'chat': return '/guide/chat_backends/';
    case 'models': return '/guide/models_download/';
    case 'security': return '/guide/security_hardening/';
    case 'deployment': return '/deployment/';
    case 'playbook': return '/guide/performance_reasoning_playbook/';
    default: return '/';
  }
}
function positionTip(anchor, el){
  const r = anchor.getBoundingClientRect();
  el.style.left = Math.round(r.left + window.scrollX + 22) + 'px';
  el.style.top  = Math.round(r.top  + window.scrollY - 6) + 'px';
}
function showTip(anchor, text, key){
  const tip = document.createElement('div');
  tip.className = 'tip';
  const more = docsBase ? `<a class="t-more" target="_blank" href="${docsBase}${docPath(key)}">Read more →</a>` : '';
  tip.innerHTML = `<div class="t-title">${key.charAt(0).toUpperCase()+key.slice(1)}</div><div>${text}</div><div style="margin-top:6px">${more}</div>`;
  document.body.appendChild(tip);
  positionTip(anchor, tip);
  const close = () => { tip.remove(); document.removeEventListener('click', onClickAway); window.removeEventListener('resize', onResize); };
  const onClickAway = (e) => { if(!tip.contains(e.target) && e.target !== anchor) close(); };
  const onResize = () => positionTip(anchor, tip);
  setTimeout(()=> document.addEventListener('click', onClickAway), 0);
  window.addEventListener('resize', onResize);
}
async function initDocs(){
  try{
    const r = await fetch(base + '/about');
    const a = await r.json();
    const port = location.port || '8091';
    document.getElementById('port').textContent = port;
    if (a && a.docs_url){
      docsBase = (a.docs_url || '').replace(/\/$/, '');
      const link = document.getElementById('docsLink');
      link.href = docsBase + '/';
      link.style.display = 'inline-block';
      link.title = 'Open docs';
    }
  }catch{}
  // Bind help icons
  document.querySelectorAll('a.help[data-doc]').forEach(a => {
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const key = a.getAttribute('data-doc');
      const tip = a.getAttribute('data-tip') || '';
      showTip(a, tip, key);
    });
  });
}
document.addEventListener('DOMContentLoaded', initDocs);
// Metrics link
document.addEventListener('DOMContentLoaded', ()=>{
  const a=document.getElementById('metricsLink'); if(!a) return; a.href = base + '/metrics'; a.target='_blank'; a.title='Open Prometheus metrics';
  const cm=document.getElementById('copyMetrics'); if(cm){ cm.addEventListener('click', async ()=>{ try{ const r=await fetch(base + '/metrics'); const t=await r.text(); await navigator.clipboard.writeText(t); showToast('Metrics copied'); }catch{ showToast('Copy failed'); } }); }
  // Catalog link + health badge
  const cl=document.getElementById('catalogLink'); if(cl){ cl.href = base + '/catalog/index'; cl.target='_blank'; cl.title='Open Interface Catalog'; }
  (async()=>{ try{
    const r = await fetch(base + '/catalog/health');
    if(r.ok){ const j = await r.json(); const cb=document.getElementById('catalogBadge'); if(cb){ cb.className = 'badge ' + (j.ok? 'ok':'warn'); cb.innerHTML = '<span class="dot"></span> Catalog: ' + (j.ok? 'ok':'warn'); } }
  }catch{} })();
});
function setAdmin(on){ __adminOk = !!on; const b=document.getElementById('adminBadge'); if(!b) return; b.className = 'badge ' + (on ? 'ok' : 'warn'); b.innerHTML = '<span class="dot"></span> Admin: ' + (on ? 'on' : 'off'); }
function setSSE(on){ const b=document.getElementById('sseBadge'); if(!b) return; b.className = 'badge ' + (on ? 'ok' : 'bad'); b.innerHTML = '<span class="dot"></span> SSE: ' + (on ? 'live' : 'off'); }
function setChat(name, ok){ const b=document.getElementById('chatBadge'); if(!b) return; const cls = ok ? (name==='synthetic'?'warn':'ok') : 'bad'; b.className = 'badge ' + cls; b.innerHTML = '<span class="dot"></span> Chat: ' + name; }
async function chatProbe(){ try{ const r=await fetch(base + '/chat/status?probe=1'); const j=await r.json(); setChat(j.backend||'synthetic', !!j.ok); showToast('Chat ' + (j.backend||'synthetic') + ': ' + (j.ok?'ok':'fail') + (j.latency_ms?(' · '+j.latency_ms+' ms') : '')); }catch{ setChat('synthetic', false); showToast('Chat probe failed'); } }
async function chatInit(){ try{ const r=await fetch(base + '/chat/status'); const j=await r.json(); setChat(j.backend||'synthetic', !!j.ok); }catch{ setChat('synthetic', false); } }
function adminHeaders(json){ const h = {}; if(__adminHeader){ h['X-ARW-Admin'] = __adminHeader; } if(json){ h['Content-Type'] = 'application/json'; } return h; }
function chatRender(history){ try{ const out = document.getElementById('chatOut'); if(out){ out.textContent = JSON.stringify(history||[], null, 2); } }catch(e){} }
async function chatFetch(){ try{ const r = await fetch(base + '/admin/chat', { headers: adminHeaders(false) }); if(!r.ok) return; const j = await r.json(); chatRender(j?.items || j?.data || []); }catch(e){ console.warn('chat fetch failed', e); } }
async function chatSend(){ try{
  const input = document.getElementById('chatInput'); if(!input) return; const prompt = input.value.trim();
  const body = { prompt };
  const r = await fetch(base + '/admin/chat/send', { method:'POST', headers: adminHeaders(true), body: JSON.stringify(body) });
  if(!r.ok){ showToast('chat send failed ('+r.status+')'); return; }
  const j = await r.json();
  chatRender(j?.history || j?.data || []);
  input.value = '';
}catch(e){ console.error(e); showToast('chat send failed'); }}
async function chatClear(){ try{
  const r = await fetch(base + '/admin/chat/clear', { method:'POST', headers: adminHeaders(true) });
  if(r.ok){ chatRender([]); showToast('chat cleared'); }
  else { showToast('chat clear failed ('+r.status+')'); }
}catch(e){ console.error(e); showToast('chat clear failed'); }}
function stagingRender(items){
  const host = document.getElementById('stagingList');
  if(!host) return;
  if(!items || !items.length){ host.innerHTML = '<div class="hint">No pending actions.</div>'; return; }
  const rows = items.map(it=>{
    const id = it.id || '-';
    const kind = it.action_kind || '-';
    const proj = it.project || 'local';
    const by = it.requested_by || 'system';
    const status = it.status || '-';
    const created = it.created ? new Date(it.created).toISOString() : '–';
    return `<div class="mrow">
      <div class="mcell id">${id}</div>
      <div class="mcell">${kind}</div>
      <div class="mcell">${proj}</div>
      <div class="mcell">${by}</div>
      <div class="mcell">${status}</div>
      <div class="mcell">${created}</div>
      <div class="mcell actions"><button class="iconbtn" onclick="stagingAct('${id}','approve')">Approve</button><button class="iconbtn" onclick="stagingAct('${id}','deny')">Deny</button></div>
    </div>`;
  }).join('');
  host.innerHTML = `<div class="mrow mhead"><div class="mcell id">id</div><div class="mcell">kind</div><div class="mcell">project</div><div class="mcell">requested</div><div class="mcell">status</div><div class="mcell">created</div><div class="mcell actions">actions</div></div>${rows}`;
}
async function stagingFetch(){ try{
  const r = await fetch(base + '/state/staging/actions?status=pending&limit=100', { headers: adminHeaders(false) });
  if(!r.ok){ if(r.status===401) showToast('set admin token for staging'); return; }
  const j = await r.json();
  stagingRender(j?.items || j?.data || []);
}catch(e){ console.error(e); showToast('staging fetch failed'); }}
async function stagingAct(id, action){
  if(!id) return;
  const target = `${base}/staging/actions/${encodeURIComponent(id)}/${action}`;
  try{
    const r = await fetch(target, { method:'POST', headers: adminHeaders(true) });
    if(r.ok){ showToast(`staging ${action}`); stagingFetch(); }
    else { showToast(`staging ${action} failed (${r.status})`); }
  }catch(e){ console.error(e); showToast(`staging ${action} failed`); }
}
function rwRender(data){
  const host = document.getElementById('rwPending');
  if(host){
    const pending = (data && data.pending) || [];
    if(!pending.length){ host.innerHTML = '<div class="hint">No pending research items.</div>'; }
    else {
      host.innerHTML = pending.map(it => {
        const title = it.title || it.source_id || it.id || 'Untitled';
        const source = it.source || 'feed';
        const summary = it.summary || (it.payload ? JSON.stringify(it.payload).slice(0, 280) : '');
        const url = it.url ? `<a href="${it.url}" target="_blank">open</a>` : '';
        const project = it.project || 'library';
        return `<div style="border:1px solid var(--line);border-radius:8px;padding:8px;background:#fff;">
          <div style="font-weight:600;margin-bottom:4px">${title}</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:6px">${source} · ${project}</div>
          <div style="font-size:13px;margin-bottom:8px">${summary || '(no summary)'}${url ? ' · ' + url : ''}</div>
          <div class="row" style="margin:0">
            <button class="iconbtn" onclick="rwAct('${it.id}','approve')">Approve</button>
            <button class="iconbtn" onclick="rwAct('${it.id}','archive')">Archive</button>
          </div>
        </div>`;
      }).join('');
    }
  }
  const recent = document.getElementById('rwRecent');
  if(recent){
    const approved = ((data && data.approved_recent) || []).slice(0,5).map(it=>it.title||it.id).join(', ');
    const archived = ((data && data.archived_recent) || []).slice(0,5).map(it=>it.title||it.id).join(', ');
    recent.innerHTML = `<div><strong>Approved:</strong> ${approved || '–'}</div><div><strong>Archived:</strong> ${archived || '–'}</div>`;
  }
}
async function rwFetch(){ try{
  const r = await fetch(base + '/state/research_watcher', { headers: adminHeaders(false) });
  if(!r.ok){ if(r.status===401){ const host=document.getElementById('rwPending'); if(host){ host.innerHTML = '<div class="hint">Set admin token to inspect research items.</div>'; } } return; }
  const j = await r.json();
  rwRender(j?.data || j);
}catch(e){ console.error(e); showToast('research watcher fetch failed'); }}
async function rwAct(id, action){
  if(!id) return;
  let note = '';
  try{ note = prompt(`${action} note?`, '') || ''; }catch{}
  try{
    const r = await fetch(`${base}/research_watcher/${encodeURIComponent(id)}/${action}`, { method:'POST', headers: adminHeaders(true), body: JSON.stringify({ note }) });
    if(r.ok){ showToast(`research ${action}`); rwFetch(); }
    else { showToast(`research ${action} failed (${r.status})`); }
  }catch(e){ console.error(e); showToast(`research ${action} failed`); }
}
async function trainingFetch(){ try{
  const r = await fetch(base + '/state/training/telemetry', { headers: adminHeaders(false) });
  if(!r.ok){ return; }
  const j = await r.json();
  const out = document.getElementById('trainingOut');
  if(out){ out.textContent = JSON.stringify(j?.data || j, null, 2); }
}catch(e){ console.error(e); showToast('training fetch failed'); }}
async function probeAdmin(){ try{ const r = await fetch(base + '/introspect/tools'); setAdmin(r.ok); }catch{ setAdmin(false); } }
document.addEventListener('DOMContentLoaded', probeAdmin);
document.addEventListener('DOMContentLoaded', ()=>{ var b=document.getElementById('chatTestBtn'); if(b){ b.addEventListener('click', chatProbe); } chatInit(); chatFetch(); });
document.addEventListener('DOMContentLoaded', stagingFetch);
document.addEventListener('DOMContentLoaded', rwFetch);
document.addEventListener('DOMContentLoaded', trainingFetch);
document.addEventListener('DOMContentLoaded', ()=>{ try{ initBadges(); }catch(e){} });
document.addEventListener('DOMContentLoaded', ()=>{ try{ updateModelsCount(); }catch(e){} });
document.addEventListener('DOMContentLoaded', ()=>{ try{ renderDownloads(); }catch(e){} });
document.addEventListener('DOMContentLoaded', ()=>{ try{ modelsMaybeShowHint(false); }catch(e){} });
document.addEventListener('DOMContentLoaded', ()=>{ try{ const b=document.getElementById('copyDownloadsBtn'); if(b){ b.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(JSON.stringify(downloads||{}, null, 2)); showToast('Copied'); }catch{} }); } }catch(e){} });
// Trust (RPU) wiring
async function rpuRefresh(){ try{
  const r = await fetch(base + '/admin/rpu/trust', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
  if(!r.ok) return;
  const j = await r.json();
  const count = (j && (j.count||j.data?.count)) || 0;
  const last = (j && (j.last_reload_ms||j.data?.last_reload_ms)) || 0;
  const elC = document.getElementById('rpuCount'); if (elC) elC.textContent = String(count);
  const elL = document.getElementById('rpuLast'); if (elL) elL.textContent = last? (new Date(last).toISOString()) : '–';
  const elOut = document.getElementById('rpuOut'); if (elOut) elOut.textContent = JSON.stringify(j, null, 2);
}catch(e){ console.error(e); }}
async function rpuReload(){ try{
  const r = await fetch(base + '/admin/rpu/reload', { method: 'POST', headers: { 'X-ARW-Admin': __adminHeader || '' } });
  if(r.ok){ showToast('Trust reloaded'); await rpuRefresh(); } else { showToast('Reload failed'); }
}catch(e){ console.error(e); showToast('Reload failed'); }}
document.addEventListener('DOMContentLoaded', ()=>{
  const rb=document.getElementById('rpuRefreshBtn'); if(rb){ rb.addEventListener('click', rpuRefresh); }
  const rl=document.getElementById('rpuReloadBtn'); if(rl){ rl.addEventListener('click', rpuReload); }
  const re=document.getElementById('rpuEventsBtn'); if(re){ re.href = base + '/events?prefix=' + encodeURIComponent('rpu.'); re.title='Open Events (rpu.*)'; }
  rpuRefresh();
});
// Pull policy bounds for display
document.addEventListener('DOMContentLoaded', fbFetchPolicy);
// Start live suggestions if enabled
document.addEventListener('DOMContentLoaded', ()=>{ const cb=document.getElementById('fbLive'); if(cb){ fbLiveSet(cb.checked); cb.addEventListener('change', ()=> fbLiveSet(cb.checked)); } });
// SSE presets
document.addEventListener('DOMContentLoaded', ()=>{
  const b1=document.getElementById('sseReplay50'); if(b1){ b1.addEventListener('click', ()=>{ startSSE(50, []); showToast('Replaying last 50'); }); }
  const b2=document.getElementById('sseOnlyModels'); if(b2){ b2.addEventListener('click', ()=>{ startSSE(0, ['models.']); showToast('Filtering to models.*'); }); }
  const b3=document.getElementById('sseOnlyRpu'); if(b3){ b3.addEventListener('click', ()=>{ startSSE(0, ['rpu.']); showToast('Filtering to rpu.*'); }); }
});

// --- Persist common inputs ---
function prefKey(k){ return 'arw.' + k; }
function savePref(k,v){ try{ localStorage.setItem(prefKey(k), JSON.stringify(v)); }catch{} }
function loadPref(k,def){ try{ const v = localStorage.getItem(prefKey(k)); return v ? JSON.parse(v) : def; }catch{ return def; } }
function bindPersist(id, key, isCheckbox){ const el=document.getElementById(id); if(!el) return; const val = loadPref(key, isCheckbox ? false : ''); if(val !== undefined && val !== null){ if(isCheckbox) el.checked = !!val; else if(val !== '') el.value = val; }
  el.addEventListener('change', ()=>{ const v = isCheckbox ? !!el.checked : el.value; savePref(key, v); }); }
document.addEventListener('DOMContentLoaded', ()=>{
  [['chatModel',false],['memKind',false],['profileSel',false],['hintConc',false],['hintBuf',false],['hintTimeout',false],['hintRetrK',false],['hintDiv',false],['hintLambda',false],['hintCompr',false],['hintVoteK',false],['hintCtxBudget',false],['hintCtxPer',false],['hintCtxFmt',false],['hintProv',true],['hintCtxHeader',false],['hintCtxFooter',false],['hintCtxTpl',false],['hintJoiner',false],['autoApply',true],['fbLive',true],['memBody',false],['toolBody',false],['mId',false],['mProv',false],['mUrl',false],['mSha',false],['goldProj',false],['expId',false],['expVar',false]].forEach(([id,isCb])=> bindPersist(id, id, isCb));
  bindPersist('asmOverride', true, true);
  const remember = loadPref('admin.remember', false); const tok = loadPref('admin.token', '');
  const cb=document.getElementById('rememberTok'); const t=document.getElementById('adminToken'); if(cb) cb.checked = !!remember; if(t && remember && tok){ t.value = tok; __adminHeader = tok; setAdmin(true); }
});
document.addEventListener('DOMContentLoaded', ()=>{
  const btn=document.getElementById('useTok'); if(!btn) return; btn.addEventListener('click', ()=>{
    const t=document.getElementById('adminToken').value.trim(); __adminHeader = t; setAdmin(!!t);
    const remember = document.getElementById('rememberTok').checked; savePref('admin.remember', !!remember); if(remember){ savePref('admin.token', t); } else { try{ localStorage.removeItem(prefKey('admin.token')); }catch{} }
  });
});
document.addEventListener('DOMContentLoaded', ()=>{
  const sel=document.getElementById('hdrProfile'); if(sel){ sel.addEventListener('change', async ()=>{ try{ await fetch(base+'/governor/profile',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({name: sel.value})}); const b=document.getElementById('govBadge'); if(b){ b.className='badge ok'; b.innerHTML='<span class=\"dot\"></span> Gov: '+sel.value; } showToast('Profile set to '+sel.value); }catch{ showToast('Profile change failed'); } }); }
});
// Mode/SLO header wiring
document.addEventListener('DOMContentLoaded', ()=>{
  // Persist + initialize
  bindPersist('hdrMode','hdrMode',false);
  bindPersist('hdrSlo','hdrSlo',false);
  const modeSel = document.getElementById('hdrMode');
  const sloInp = document.getElementById('hdrSlo');
  const modeBadge = document.getElementById('modeBadge');
  const sloBadge = document.getElementById('sloBadge');
  const applyBtn = document.getElementById('applyModeSlo');
  const updateBadges = ()=>{
    const m = (modeSel && modeSel.value) || 'balanced';
    const s = (sloInp && sloInp.value) || '1500';
    if(modeBadge){ modeBadge.className='badge ok'; modeBadge.innerHTML = '<span class="dot"></span> Mode: ' + m; }
    if(sloBadge){ sloBadge.className='badge ' + (parseInt(s,10)<=1500? 'ok':'warn'); sloBadge.innerHTML = '<span class="dot"></span> SLO: ' + s + ' ms'; }
  };
  if(modeSel){ modeSel.addEventListener('change', ()=>{ savePref('hdrMode', modeSel.value); updateBadges(); }); }
  if(applyBtn){ applyBtn.addEventListener('click', async ()=>{
    try{
      const mode = (modeSel && modeSel.value) || 'balanced';
      const sloMs = parseInt((sloInp && sloInp.value) || '1500', 10);
      if(sloInp){ savePref('hdrSlo', String(sloMs)); }
      // Derive http_timeout_secs from SLO (ceil seconds, min 1)
      const http_timeout_secs = Math.max(1, Math.ceil(sloMs/1000));
      const body = { mode, slo_ms: sloMs, http_timeout_secs };
      const resp = await fetch(base + '/admin/governor/hints', { method:'POST', headers: { 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify(body) });
      if(resp.ok){ updateBadges(); showToast('Applied mode/SLO'); }
      else { showToast('Apply failed ('+resp.status+')'); }
    }catch{ showToast('Apply error'); }
  }); }
  updateBadges();
  const clr=document.getElementById('egClear'); if(clr){ clr.addEventListener('click', ()=>{ const out=document.getElementById('egOut'); if(out){ out.innerHTML=''; } }); }
});

// Initialize header badges on load
function initBadges(){
  try{
    const prof = document.getElementById('hdrProfile')?.value || 'balanced';
    const gb = document.getElementById('govBadge'); if(gb){ gb.className='badge ok'; gb.innerHTML='<span class="dot"></span> Gov: '+prof; }
    const modeSel = document.getElementById('hdrMode'); const m = (modeSel && modeSel.value) || 'balanced'; const mb=document.getElementById('modeBadge'); if(mb){ mb.className='badge ok'; mb.innerHTML='<span class="dot"></span> Mode: '+m; }
    const s = document.getElementById('hdrSlo')?.value || '1500'; const sb=document.getElementById('sloBadge'); if(sb){ sb.className='badge ' + (parseInt(s,10)<=1500? 'ok':'warn'); sb.innerHTML='<span class="dot"></span> SLO: '+s+' ms'; }
  }catch{}
}

// --- Command palette ---
function ensurePalette(){
  if(document.getElementById('pal')) return;
  const wrap=document.createElement('div'); wrap.className='palette'; wrap.id='pal';
  wrap.innerHTML = `<div class="pal-box"><input id="palQuery" placeholder="Type a command... (Esc to close)"><div id="palList" class="pal-list"></div></div>`;
  document.body.appendChild(wrap);
}
const palette = {
  open(){ ensurePalette(); const el=document.getElementById('pal'); el.style.display='flex'; this.render(''); const inp=document.getElementById('palQuery'); inp.value=''; inp.focus(); this.sel=0; },
  close(){ const el=document.getElementById('pal'); if(el) el.style.display='none'; },
  list:[
    {t:'Open /version', h:'GET', f:()=>hit('/version')},
    {t:'Open /about', h:'GET', f:()=>hit('/about')},
    {t:'List tools', h:'GET', f:()=>hit('/introspect/tools')},
    {t:'Probe now', h:'Action', f:()=>orProbe()},
    {t:'Refresh models', h:'Action', f:()=>orRefreshModels()},
    {t:'Run self-tests', h:'Action', f:()=>runSelfTests()},
    {t:'Toggle insights', h:'UI', f:()=>document.getElementById('toggleInsights').click()},
    {t:'Copy stats JSON', h:'UI', f:()=>copyStatsNow()},
    {t:'Open docs', h:'UI', f:()=>{ const l=document.getElementById('docsLink'); if(l && l.href) window.open(l.href,'_blank'); }},
    {t:'Shutdown service', h:'Danger', f:()=>orShutdown()},
  ],
  items:[], sel:0,
  render(q){ const list=document.getElementById('palList'); const qq=(q||'').toLowerCase(); this.items = this.list.filter(x=> x.t.toLowerCase().includes(qq)); if(this.items.length===0){ list.innerHTML = '<div class="pal-item"><span>No matches</span></div>'; return; }
    list.innerHTML = this.items.map((x,i)=> `<div class="pal-item ${i===0?'sel':''}" data-idx="${i}"><span>${x.t}</span><span class="hint">${x.h}</span></div>`).join(''); this.sel=0; },
  move(d){ if(!this.items.length) return; const list=document.getElementById('palList'); const max=this.items.length; const prev=this.sel; this.sel = (this.sel + d + max) % max; const rows=list.querySelectorAll('.pal-item'); if(rows[prev]) rows[prev].classList.remove('sel'); if(rows[this.sel]) rows[this.sel].classList.add('sel'); rows[this.sel]?.scrollIntoView({block:'nearest'}); },
  run(){ if(!this.items.length) return; const x=this.items[this.sel]; this.close(); try{ x.f(); }catch(e){ showToast('Command error'); } }
};
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('openPalette')?.addEventListener('click', ()=> palette.open());
  document.addEventListener('input', (e)=>{ if(e.target && e.target.id==='palQuery'){ palette.render(e.target.value||''); }});
  document.addEventListener('click', (e)=>{ const pal=document.getElementById('pal'); if(!pal || pal.style.display==='none') return; if(!pal.contains(e.target)){ /* click outside */ } });
});

// --- Shortcuts manager (centralized bindings + global toggle) ---
const Shortcuts = {
  enabled: true,
  binds: [],
  normalize(e){
    const parts = [];
    if (e.ctrlKey || e.metaKey) parts.push('Ctrl');
    if (e.altKey) parts.push('Alt');
    if (e.shiftKey && !['?',':'].includes(e.key)) parts.push('Shift');
    let k = e.key;
    if (k.length === 1) { k = k.toUpperCase(); }
    return parts.concat([k]).join('+');
  },
  inEditable(e){
    const t = e.target;
    if (!t) return false;
    const el = t.closest ? t.closest('input,textarea,select,[contenteditable="true"]') : null;
    return !!el;
  },
  register(seq, desc, fn, opts){ this.binds.push({ seq, desc, fn, when: (opts && opts.when) || (()=>true), inInputs: !!(opts && opts.captureInInputs) }); },
  setEnabled(on){ this.enabled = !!on; savePref('shortcuts.enabled', this.enabled); const cb=document.getElementById('shortcutsToggle'); if(cb) cb.checked = this.enabled; },
  list(){ return this.binds.map(b => ({ seq: b.seq, desc: b.desc })).filter((v,i,a)=> a.findIndex(x=> x.seq===v.seq && x.desc===v.desc)===i); },
  ensureHelp(){ if(document.getElementById('scut')) return; const wrap=document.createElement('div'); wrap.className='palette'; wrap.id='scut';
    wrap.innerHTML = `<div class="pal-box"><div style="padding:10px 12px;display:flex;align-items:center;gap:8px"><b>Shortcuts</b><span class="key" style="margin-left:auto">enable</span><input type="checkbox" id="shortcutsToggle2"></div><div id="scutList" class="pal-list"></div></div>`; document.body.appendChild(wrap);
    document.getElementById('shortcutsToggle2').addEventListener('change', (e)=> this.setEnabled(e.target.checked));
  },
  showHelp(){ this.ensureHelp(); const el=document.getElementById('scut'); const list=document.getElementById('scutList'); const rows=this.list().map(x=> `<div class="pal-item"><span>${x.desc}</span><span class="hint">${x.seq}</span></div>`).join(''); list.innerHTML = rows || '<div class="pal-item"><span>No shortcuts</span></div>'; el.style.display='flex'; document.getElementById('shortcutsToggle2').checked = this.enabled; },
  hideHelp(){ const el=document.getElementById('scut'); if(el) el.style.display='none'; },
  hookOnce(){ if (this._hooked) return; this._hooked=true; document.addEventListener('keydown', (e)=>{
      if(!this.enabled) return;
      const seq = this.normalize(e);
      const inEdit = this.inEditable(e);
      for(const b of this.binds){ if (b.seq === seq && b.when() && (b.inInputs || !inEdit)) { e.preventDefault(); try{ b.fn(e); }catch{} return; } }
      // Special case: Esc closes overlays
      if (e.key === 'Escape'){ const pal=document.getElementById('pal'); const sc=document.getElementById('scut'); if(pal && pal.style.display!=='none'){ palette.close(); e.preventDefault(); return; } if(sc && sc.style.display!=='none'){ this.hideHelp(); e.preventDefault(); return; } }
    }); }
};
document.addEventListener('DOMContentLoaded', ()=>{
  Shortcuts.setEnabled(loadPref('shortcuts.enabled', true));
  Shortcuts.hookOnce();
  const cb=document.getElementById('shortcutsToggle'); if(cb){ cb.checked = Shortcuts.enabled; cb.addEventListener('change', ()=> Shortcuts.setEnabled(cb.checked)); }
  document.getElementById('openShortcuts')?.addEventListener('click', ()=> Shortcuts.showHelp());
});

// Register default shortcuts
function paletteOpen(){ palette.open(); }
function insightsToggle(){ const el = document.getElementById('insights'); const on = (el.style.display==='none' || !el.style.display); el.style.display = on ? 'block' : 'none'; if(on){ if(window.__insightsTimer) clearInterval(window.__insightsTimer); const pull=async()=>{ try{ const r=await fetch(base+'/introspect/stats'); const j=await r.json(); routesCache = (j && j.routes && j.routes.by_path) || {}; renderInsights(); }catch{} }; pull(); window.__insightsTimer=setInterval(pull,3000); } else { if(window.__insightsTimer) clearInterval(window.__insightsTimer); } }
function paletteVisible(){ const el=document.getElementById('pal'); return !!el && el.style.display!=='none'; }
Shortcuts.register('Ctrl+K', 'Open palette', paletteOpen, { when: ()=> true });
Shortcuts.register('Ctrl+/', 'Show shortcuts', ()=> Shortcuts.showHelp(), { when: ()=> true });
Shortcuts.register('Ctrl+I', 'Toggle insights', insightsToggle, { when: ()=> true });
Shortcuts.register('ArrowDown', 'Palette: next', ()=> palette.move(1), { when: paletteVisible, captureInInputs: true });
Shortcuts.register('ArrowUp', 'Palette: prev', ()=> palette.move(-1), { when: paletteVisible, captureInInputs: true });
Shortcuts.register('Enter', 'Palette: run', ()=> palette.run(), { when: paletteVisible, captureInInputs: true });

// helper to copy stats
async function copyStatsNow(){ try{ const r=await fetch(base + '/introspect/stats'); const t=await r.text(); await navigator.clipboard.writeText(t); showToast('Stats copied'); }catch{ showToast('Stats copy failed'); } }
</script>
<div id="toast" class="toast"></div>
<script>
function showToast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=>{ t.style.display='none'; }, 2500); }
async function pullState(kind){ try{ const r=await fetch(base + '/admin/state/' + kind, { headers: { 'X-ARW-Admin': __adminHeader || '' } }); const j=await r.json(); document.getElementById('stateOut').textContent = JSON.stringify(j,null,2); }catch(e){ showToast('state fetch failed'); } }
async function worldSelect(){
  try {
    const q = encodeURIComponent(document.getElementById('worldQ').value||'');
    const k = encodeURIComponent(document.getElementById('worldK').value||'8');
    const r = await fetch(base + '/admin/state/world/select?q=' + q + '&k=' + k, { headers: { 'X-ARW-Admin': __adminHeader || '' } });
    const j = await r.json();
    document.getElementById('stateOut').textContent = JSON.stringify(j,null,2);
  } catch(e){ showToast('world select failed'); }
}
async function worldMapRefresh(){
  try {
    const r = await fetch(base + '/admin/state/world', { headers: { 'X-ARW-Admin': __adminHeader || '' } });
    const j = await r.json();
    const data = j?.data || j;
    const el = document.getElementById('worldMap'); if(!el) return;
    const cov = data?.coverage || {};
    const hdr = `<div class='kv'><b>Version</b><span>${data?.version ?? '–'}</span></div>`+
                `<div class='kv'><b>Entities</b><span>${cov.entities ?? 0}</span></div>`+
                `<div class='kv'><b>Claims</b><span>${cov.claims ?? 0}</span></div>`+
                `<div class='kv'><b>Contradictions</b><span>${data?.contradictions ?? 0}</span></div>`+
                `<div class='kv'><b>Stale</b><span>${data?.stale ?? 0}</span></div>`;
    // Top claims (by confidence)
    const claims = (data?.claims || []).slice(0, 5);
    const claimLines = claims.map(c => {
      const conf = (c?.confidence ?? 0).toFixed ? (c.confidence).toFixed(2) : (c?.confidence ?? 0);
      const id = (c?.id || '').toString().slice(0, 80);
      return `<div class='kv'><span>${id}</span><span>conf: ${conf}</span></div>`;
    }).join('');
    el.innerHTML = [`<h4>Summary</h4>`, hdr, `<h4>Top Claims</h4>`, claimLines || '<em>none</em>'].join('');
  } catch(e){ showToast('world map refresh failed'); }
}
async function contextAssemble(){
  try {
    const q = encodeURIComponent(document.getElementById('worldQ').value||'');
    const k = encodeURIComponent(document.getElementById('worldK').value||'8');
    let url = base + '/admin/context/assemble?q=' + q + '&k=' + k;
    // Apply per-call overrides when toggled (reuses hints inputs)
    try{
      const on = !!document.getElementById('asmOverride')?.checked;
      if (on){
        const fmt=document.getElementById('hintCtxFmt')?.value||''; if(fmt) url += '&context_format=' + encodeURIComponent(fmt);
        const prov=document.getElementById('hintProv')?.checked; if(prov) url += '&include_provenance=true';
        const cb=document.getElementById('hintCtxBudget')?.value||''; if(cb) url += '&context_budget_tokens=' + encodeURIComponent(cb);
        const pi=document.getElementById('hintCtxPer')?.value||''; if(pi) url += '&context_item_budget_tokens=' + encodeURIComponent(pi);
        const hdr=document.getElementById('hintCtxHeader')?.value||''; if(hdr) url += '&context_header=' + encodeURIComponent(hdr);
        const ftr=document.getElementById('hintCtxFooter')?.value||''; if(ftr) url += '&context_footer=' + encodeURIComponent(ftr);
        const tpl=document.getElementById('hintCtxTpl')?.value||''; if(tpl) url += '&context_item_template=' + encodeURIComponent(tpl);
        const jn=document.getElementById('hintJoiner')?.value||''; if(jn) url += '&joiner=' + encodeURIComponent(jn);
      }
    }catch{}
    const r = await fetch(url, { headers: { 'X-ARW-Admin': __adminHeader || '' } });
    const j = await r.json();
    const data = j?.data || j;
    document.getElementById('stateOut').textContent = JSON.stringify(data,null,2);
    // Render context preview if present
    try{
      const prev = data?.context_preview || '';
      const el = document.getElementById('ctxPreview'); if(el){ el.textContent = prev || '(no preview)'; }
    }catch{}
    // Quick KPIs
    try{
      const el = document.getElementById('ctxKpis');
      const aux = (data && data.aux && data.aux.context) || {};
      const ret = aux.retrieval || {};
      const parts = [];
      const ib = aux.items_before, ia = aux.items_after, idr = aux.items_dropped;
      const tb = aux.before_tokens, ta = aux.after_tokens, bud = aux.budget_tokens, per = aux.per_item_cap_tokens;
      const k = (ret.k!=null) ? ret.k : (data?.policy?.planner?.retrieval?.k);
      const lam = (ret.lambda!=null) ? ret.lambda : (data?.policy?.planner?.retrieval?.lambda || data?.policy?.planner?.retrieval?.div);
      const compr = aux.compression_aggr;
      if (k!=null) parts.push(`<span class="key">k</span><code>${k}</code>`);
      if (lam!=null) parts.push(`<span class="key">λ</span><code>${Number(lam).toFixed ? Number(lam).toFixed(2) : lam}</code>`);
      if (compr!=null) parts.push(`<span class="key">compr</span><code>${Number(compr).toFixed ? Number(compr).toFixed(2) : compr}</code>`);
      if (ib!=null) parts.push(`<span class="key">items</span><code>${ib}→${ia??ib}</code>`);
      if (idr!=null) parts.push(`<span class="key">drop</span><code>${idr}</code>`);
      if (tb!=null) parts.push(`<span class="key">tokens</span><code>${tb}→${ta??tb}</code>`);
      if (bud!=null) parts.push(`<span class="key">budget</span><code>${bud}</code>`);
      if (per!=null) parts.push(`<span class="key">per</span><code>${per}</code>`);
      if (el){ el.innerHTML = parts.join(' '); el.style.display = parts.length? 'flex':'none'; }
    }catch{}
    try {
      const planner = (data && data.policy && data.policy.planner) || null;
      const row = document.getElementById('plannerMeta');
      if (planner && row){
        const mode = planner.mode || 'balanced';
        const verify = planner.verify_pass ? '<span class="badge ok"><span class="dot"></span> verify</span>' : '<span class="badge warn"><span class="dot"></span> verify off</span>';
        const vote = (planner.consistency && planner.consistency.vote_k!=null) ? planner.consistency.vote_k : '–';
        const k2 = (planner.retrieval && planner.retrieval.k!=null) ? planner.retrieval.k : '–';
        const div = (planner.retrieval && planner.retrieval.div!=null) ? planner.retrieval.div : '–';
        row.innerHTML = `<span class="key">planner</span> <code>mode=${mode}</code> ${verify} <span class="key">vote_k</span> <code>${vote}</code> <span class="key">k</span> <code>${k2}</code> <span class="key">div</span> <code>${div}</code>`;
        row.style.display = 'flex';
      } else if (row){ row.style.display='none'; row.innerHTML=''; }
    }catch{}
  } catch(e){ showToast('assemble failed'); }
}
// Episodes UI
let __epTimer = null;
function episodesRender(j){ try{
  const el = document.getElementById('epList'); if(!el) return;
  const items = (j && j.items) || [];
  const errOnly = !!document.getElementById('epErrOnly')?.checked;
  const filt = (document.getElementById('epFilter')?.value||'').toLowerCase();
  const matches = (ep)=>{
    if (errOnly && !(ep.errors>0)) return false;
    if (!filt) return true;
    const id = (ep.id||'').toLowerCase();
    if (id.includes(filt)) return true;
    const arr = ep.items||[];
    for (let i=0;i<arr.length;i++){ const k = (arr[i].kind||'').toLowerCase(); if(k.includes(filt)) return true; try{ const p = JSON.stringify(arr[i].payload||{}).toLowerCase(); if(p.includes(filt)) return true; }catch{} }
    return false;
  };
  const list = items.filter(matches);
  if(list.length === 0){ el.innerHTML = '<div class="evt">(no episodes)</div>'; return; }
  const html = list.slice().reverse().map((ep,idx)=>{
    const count = (ep.items||[]).length;
    const last = ep.last || '';
    const dur = ep.duration_ms!=null ? ` · ${ep.duration_ms} ms` : '';
    const errs = ep.errors||0;
    const badge = errs>0 ? `<span class="badge bad" style="margin-left:6px"><span class="dot"></span> ${errs} err</span>` : `<span class="badge ok" style="margin-left:6px"><span class="dot"></span> OK</span>`;
    const eid = `epd-${(ep.id||String(idx)).replace(/[^a-zA-Z0-9_-]/g,'_')}`;
    const head = `<div style="font-weight:600;display:flex;justify-content:space-between;align-items:center"><span>${ep.id} <span style="color:var(--muted);font-weight:400"> · ${count} events${dur} · ${last}</span>${badge}</span><button class="iconbtn" onclick="const d=document.getElementById('${eid}'); d.style.display = (d.style.display==='none'||!d.style.display)?'block':'none';">Details</button></div>`;
    const bodyAll = (ep.items||[]).map(ev=>{
      const k = ev.kind || '';
      const t = ev.time || '';
      const p = ev.payload ? JSON.stringify(ev.payload) : '{}';
      // Inline apply button when suggestion id present
      let applyBtn = '';
      try{ const sid = ev?.payload?.suggestion?.id; if (sid){ applyBtn = ` <button class="iconbtn" onclick="epApply('${sid}')">Apply</button>`; } }catch{}
      return `<div class="evt">[${t}] ${k}: ${p}${applyBtn}</div>`;
    }).join('');
    return `<div class="card" style="border:1px dashed #e5e7eb;margin:6px 0;padding:6px">${head}<div id="${eid}" style="display:none">${bodyAll}</div></div>`;
  }).join('');
  el.innerHTML = html;
}catch{}}
async function episodesRefresh(){ try{ const r=await fetch(base + '/state/episodes'); const j=await r.json(); episodesRender(j); }catch(e){ showToast('episodes fetch failed'); } }
document.addEventListener('DOMContentLoaded', ()=>{
  const cb = document.getElementById('epLive'); if(!cb) return;
  const tick = async ()=>{ await episodesRefresh(); };
  cb.addEventListener('change', ()=>{
    if(cb.checked){ tick(); __epTimer = setInterval(tick, 3000); }
    else { if(__epTimer) { clearInterval(__epTimer); __epTimer=null; } }
  });
});
// ---- Self‑Model panel ----
async function selfRefreshList(){
  try{
    const r = await fetch(base + '/state/self');
    const j = await r.json();
    const items = (j && j.data && j.data.items) || [];
    const sel = document.getElementById('selfAgentSel');
    if(sel){ sel.innerHTML = ''; items.forEach(it => { const o=document.createElement('option'); o.value = it.agent || ''; o.textContent = it.agent || '(unnamed)'; sel.appendChild(o); }); }
    const badge = document.getElementById('selfHdrBadge');
    if (badge){ badge.className = 'badge ' + (items.length ? 'ok' : 'warn'); badge.innerHTML = '<span class="dot"></span> ' + items.length; }
  }catch(e){ showToast('self list failed'); }
}
function _fmtPct(x){ if(typeof x !== 'number' || !isFinite(x)) return '–'; return Math.round(x*1000)/10 + '%'; }
function _kv(k,v){ return `<div><span class="key">${k}</span> <code>${v}</code></div>`; }
function selfRenderSummary(m){
  const el = document.getElementById('selfSummary'); if(!el) return;
  if(!m || typeof m !== 'object'){ el.innerHTML = ''; return; }
  const id = m.identity || {};
  const cap = m.capability_map || {};
  const calib = m.calibration || {};
  const comp = m.competence_map || {};
  const fm = Array.isArray(m.failure_modes) ? m.failure_modes : [];
  const lu = Array.isArray(id.logic_units) ? id.logic_units.length : 0;
  const leases = Array.isArray(id.leases) ? id.leases.length : 0;
  const tools = Array.isArray(cap.tools) ? cap.tools.length : 0;
  const modalities = Array.isArray(cap.modalities) ? cap.modalities.length : 0;
  const compRows = Object.entries(comp).map(([k,v])=>({k, n: (v && v.count) || 0, s: (v && v.success_rate) || 0})).sort((a,b)=>b.n-a.n).slice(0,3).map(x=> `${x.k}:${_fmtPct(x.s)}(${x.n})`).join('  ');
  const rows = [ _kv('family', id.model_family || '–'), _kv('hash', id.model_hash || '–'), _kv('units', lu), _kv('leases', leases), _kv('tools', tools), _kv('modal', modalities), _kv('ECE', (typeof calib.ece === 'number') ? (Math.round(calib.ece*1000)/1000) : '–'), _kv('Brier', (typeof calib.brier === 'number') ? (Math.round(calib.brier*1000)/1000) : '–'), _kv('competence', compRows || '–'), _kv('fail modes', fm.length) ];
  el.innerHTML = `<div class="row">${rows.join('')}</div>`;
}
async function selfView(){
  let id = (document.getElementById('selfAgentSel')?.value || '').trim();
  const typed = (document.getElementById('selfAgentId')?.value || '').trim();
  if(!id && typed) id = typed;
  if(!id){ showToast('Choose or type an agent id'); return; }
  try{
    const r = await fetch(base + '/state/self/' + encodeURIComponent(id));
    const j = await r.json();
    const model = (j && j.data) || j || {};
    const out = document.getElementById('selfOut'); if(out) out.textContent = JSON.stringify(model, null, 2);
    selfRenderSummary(model);
  }catch(e){ showToast('self fetch failed'); }
}
async function selfPropose(){
  const agentSel = document.getElementById('selfAgentSel');
  const agentInp = document.getElementById('selfAgentId');
  const agent = (agentSel?.value || agentInp?.value || '').trim();
  if(!agent){ showToast('Agent id required'); return; }
  let patchTxt = (document.getElementById('selfPatch')?.value || '{}');
  let patch; try{ patch = JSON.parse(patchTxt); }catch{ showToast('Invalid patch JSON'); return; }
  const rationale = (document.getElementById('selfWhy')?.value || '').trim();
  try{
    const resp = await fetch(base + '/admin/self_model/propose', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify({ agent, patch, rationale }) });
    const txt = await resp.text();
    const out = document.getElementById('selfAdminOut'); if(out) out.textContent = txt;
    if(resp.ok){ showToast('Proposal created'); try{ const j = JSON.parse(txt); document.getElementById('selfApplyId').value = j?.data?.id || j?.id || ''; }catch{} }
    else if(resp.status === 403){ showToast('403 Forbidden — admin token required'); }
  }catch{ showToast('Network error'); }
}
async function selfApply(){
  const proposal_id = (document.getElementById('selfApplyId')?.value || '').trim();
  if(!proposal_id){ showToast('proposal id required'); return; }
  try{
    const resp = await fetch(base + '/admin/self_model/apply', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-ARW-Admin': __adminHeader || '' }, body: JSON.stringify({ proposal_id }) });
    const txt = await resp.text();
    const out = document.getElementById('selfAdminOut'); if(out) out.textContent = txt;
    if(resp.ok){ showToast('Applied'); }
    else if(resp.status === 403){ showToast('403 Forbidden — admin token required'); }
  }catch{ showToast('Network error'); }
}
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('copyJsonSelf');
  if(btn){ btn.addEventListener('click', async ()=>{ try{ const s = document.getElementById('selfOut').textContent; await navigator.clipboard.writeText(s); showToast('Copied'); }catch{} }); }
  selfRefreshList();
});
async function epApply(id){ try{ const r=await fetch(base + '/feedback/apply', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})}); if(r.ok){ showToast('Applied '+id); } else { showToast('Apply failed ('+r.status+')'); } }catch{ showToast('Apply failed'); } }
// Bind copy buttons and insights toggle after DOM ready
document.addEventListener('DOMContentLoaded', ()=>{
  const copyMain=document.getElementById('copyJsonMain'); if(copyMain){ copyMain.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(document.getElementById('out').textContent||''); }catch{} }); }
  const copyMem=document.getElementById('copyJsonMem'); if(copyMem){ copyMem.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(document.getElementById('memOut').textContent||''); }catch{} }); }
  const copyTool=document.getElementById('copyJsonTool'); if(copyTool){ copyTool.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(document.getElementById('toolOut').textContent||''); }catch{} }); }
  const tgl=document.getElementById('toggleInsights'); if (tgl){ tgl.addEventListener('click', insightsToggle); }
  const copyStats=document.getElementById('copyStatsBtn'); if(copyStats){ copyStats.addEventListener('click', async ()=>{ try{ const r=await fetch(base + '/introspect/stats'); const t=await r.text(); await navigator.clipboard.writeText(t); showToast('Stats copied'); }catch{ showToast('Stats copy failed'); } }); }
});

// Models helpers (extended)
async function modelsGc(){
  const ttl = parseInt(document.getElementById('gcTtl')?.value||'7',10) || 7;
  try{
    const r = await fetch(base + '/admin/models/cas_gc', { method:'POST', headers:{'Content-Type':'application/json','X-ARW-Admin': __adminHeader||''}, body: JSON.stringify({ ttl_days: ttl }) });
    const t = await r.text();
    try{ JSON.parse(t); }catch{}
    showToast(r.ok ? 'GC started' : 'GC failed');
  }catch{ showToast('GC error'); }
}
</script>
  <div id="insights" style="display:none"></div>
  <script>
    // Collapsible sections persisted by heading
    (function(){
      try{
        document.querySelectorAll('.box>h3').forEach(h => {
          const key = 'dbg_collapse_' + (h.textContent||'').trim().toLowerCase().replace(/\s+/g,'_');
          const box = h.parentElement;
          const saved = localStorage.getItem(key);
          if (saved === '1') box.setAttribute('data-collapsed','1');
          else if (saved === '0') box.removeAttribute('data-collapsed');
          h.addEventListener('click', () => {
            const collapsed = box.getAttribute('data-collapsed') === '1';
            if (collapsed) { box.removeAttribute('data-collapsed'); localStorage.setItem(key,'0'); }
            else { box.setAttribute('data-collapsed','1'); localStorage.setItem(key,'1'); }
          });
        });
        // Expand / Collapse all
        const exp = document.getElementById('btnExpandAll');
        const col = document.getElementById('btnCollapseAll');
        if (exp) exp.addEventListener('click', ()=>{
          document.querySelectorAll('.box').forEach(b => {
            b.removeAttribute('data-collapsed');
            const h = b.querySelector('h3');
            if (h) localStorage.setItem('dbg_collapse_' + (h.textContent||'').trim().toLowerCase().replace(/\s+/g,'_'), '0');
          });
        });
        if (col) col.addEventListener('click', ()=>{
          document.querySelectorAll('.box').forEach(b => {
            b.setAttribute('data-collapsed','1');
            const h = b.querySelector('h3');
            if (h) localStorage.setItem('dbg_collapse_' + (h.textContent||'').trim().toLowerCase().replace(/\s+/g,'_'), '1');
          });
        });
        // Density toggle
        const dens = document.getElementById('btnDensity');
        const setDensity = mode => { document.body.classList.toggle('density-compact', mode==='compact'); localStorage.setItem('dbg_density', mode); };
        const savedD = localStorage.getItem('dbg_density');
        if (savedD === 'compact') document.body.classList.add('density-compact');
        if (dens) dens.addEventListener('click', ()=>{ const compact = document.body.classList.contains('density-compact'); setDensity(compact? 'comfortable' : 'compact'); });
      }catch{}
    })();
  </script>
</body>
</html>
// Experiment activated (applied variant)
es.addEventListener('experiment.activated', (e)=>{ pushEvt('experiment.activated', e.data); });
