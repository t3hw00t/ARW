<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ARW Flows (Logic Units)</title>
    <link rel="stylesheet" href="/admin/ui/assets/tokens.css" />
    <link rel="stylesheet" href="/admin/ui/assets/ui-kit.css" />
    <link rel="stylesheet" href="/admin/ui/assets/pages.css" />
    <link rel="stylesheet" href="/admin/ui/assets/flows.css" />
  </head>
  <body>
    <header>
      <h1>Flows (Logic Units)</h1>
      <span class="badge" title="POST /admin/logic-units/apply">Logic Units API</span>
    </header>
    <div class="card">
      <div class="row">
        <div class="flow-col">
          <label class="flow-label" for="unit">Unit ID</label>
          <input id="unit" class="flow-input" type="text" placeholder="my.flow.unit@local" />
        </div>
        <div class="flow-col">
          <label class="flow-label" for="scope">Scope (optional)</label>
          <input id="scope" class="flow-input" type="text" placeholder="project:demo" />
        </div>
      </div>
      <div class="flow-field">
        <label class="flow-label" for="patches">Patches (JSON array)</label>
        <textarea id="patches" class="flow-textarea" spellcheck="false">[
  {
    "target": "governor.hints",
    "op": "merge",
    "value": { "mode": "verified", "retrieval_k": 20, "mmr_lambda": 0.3, "vote_k": 3, "include_provenance": true }
  }
]</textarea>
      </div>
      <div class="flow-actions">
        <button id="dry" class="btn ghost">Dry Run</button>
        <button id="apply" class="btn">Apply</button>
        <span id="status" class="badge">idle</span>
      </div>
    </div>
    <div class="card">
      <label class="flow-label" for="out">Result</label>
      <div id="out" class="flow-output" aria-live="polite"></div>
    </div>
    <script>
      async function call(path, body) {
        const resp = await fetch(path, { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(body) });
        const txt = await resp.text();
        try { return { ok: resp.ok, json: JSON.parse(txt) }; } catch { return { ok: resp.ok, text: txt }; }
      }
      function readPatches() {
        const t = document.getElementById('patches').value;
        try { const v = JSON.parse(t); if (!Array.isArray(v)) throw new Error('not array'); return v; } catch(e) { throw new Error('patches must be a JSON array'); }
      }
      function show(v) {
        const out = document.getElementById('out');
        out.textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2);
      }
      async function run(dry) {
        const unit = document.getElementById('unit').value.trim() || null;
        const scope = document.getElementById('scope').value.trim() || null;
        let patches; try { patches = readPatches(); } catch(e) { show(String(e)); return; }
        const body = { unit_id: unit, scope, patches };
        const path = dry ? '/admin/logic-units/apply' : '/admin/logic-units/apply';
        if (dry) body.dry_run = true;
        document.getElementById('status').textContent = dry ? 'dry-run' : 'applying';
        const res = await call(path, body);
        document.getElementById('status').textContent = res.ok ? 'ok' : 'error';
        show(res.json ?? res.text);
      }
      document.getElementById('dry').addEventListener('click', ()=> run(true));
      document.getElementById('apply').addEventListener('click', ()=> run(false));
    </script>
  </body>
  </html>
