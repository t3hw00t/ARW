{
  "__inputs": [],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.0.0" },
    { "type": "panel", "id": "stat", "name": "Stat", "version": "9.0.0" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "9.0.0" },
    { "type": "panel", "id": "table", "name": "Table", "version": "9.0.0" }
  ],
  "title": "ARW Stability",
  "timezone": "browser",
  "editable": true,
  "panels": [
    {
      "type": "stat",
      "title": "Safe Mode Active",
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
      "targets": [ { "expr": "arw_safe_mode_active", "refId": "A" } ],
      "options": { "reduceOptions": { "calcs": ["last"], "fields": "", "values": false }, "colorMode": "value" }
    },
    {
      "type": "stat",
      "title": "Minutes Since Last Crash",
      "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
      "targets": [ { "expr": "(time() * 1000 - arw_last_crash_ms) / 60000", "refId": "A" } ],
      "options": { "reduceOptions": { "calcs": ["last"], "fields": "", "values": false } }
    },
    {
      "type": "table",
      "title": "Task Restarts (Window)",
      "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
      "targets": [ { "expr": "arw_task_restarts_window", "refId": "A", "format": "table" } ],
      "transformations": [ { "id": "seriesToColumns", "options": {"byField": "task"} } ]
    },
    {
      "type": "table",
      "title": "Route p95 (ms)",
      "gridPos": { "x": 0, "y": 4, "w": 12, "h": 8 },
      "targets": [ { "expr": "arw_route_p95_ms", "refId": "A", "format": "table" } ],
      "transformations": [ { "id": "labelsToFields", "options": {"mode": "columns"} } ]
    },
    {
      "type": "timeseries",
      "title": "Event Publish Rate",
      "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
      "targets": [ { "expr": "rate(arw_bus_published_total[5m])", "refId": "A" } ]
    },
    {
      "type": "timeseries",
      "title": "Bus Lagged Events",
      "gridPos": { "x": 12, "y": 12, "w": 12, "h": 8 },
      "targets": [ { "expr": "increase(arw_bus_lagged_total[5m])", "refId": "A" } ]
    },
    {
      "type": "table",
      "title": "Persona Signal Strength (Avg)",
      "gridPos": { "x": 0, "y": 20, "w": 24, "h": 8 },
      "targets": [
        {
          "expr": "arw_persona_signal_strength_avg{persona=~\"$persona\",signal=~\"$signal\"}",
          "refId": "A",
          "format": "table"
        }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": { "mode": "columns" } },
        { "id": "organize", "options": { "indexByName": { "Value": 2, "persona": 0, "signal": 1 } } }
      ]
    },
    {
      "type": "stat",
      "title": "Persona Avg Strength (All Signals)",
      "gridPos": { "x": 0, "y": 28, "w": 12, "h": 4 },
      "targets": [
        {
          "expr": "avg(arw_persona_signal_strength_avg{persona=~\"$persona\",signal=~\"$signal\"})",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"], "fields": "", "values": false },
        "colorMode": "value",
        "orientation": "horizontal"
      }
    },
    {
      "type": "stat",
      "title": "Persona Feedback Samples",
      "gridPos": { "x": 12, "y": 28, "w": 12, "h": 4 },
      "targets": [
        {
          "expr": "sum(arw_persona_feedback_total{persona=~\"$persona\"})",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"], "fields": "", "values": false },
        "colorMode": "value",
        "orientation": "horizontal"
      }
    },
    {
      "type": "timeseries",
      "title": "Persona Signal Strength Trend",
      "gridPos": { "x": 0, "y": 32, "w": 24, "h": 8 },
      "targets": [
        {
          "expr": "arw_persona_signal_strength_avg{persona=~\"$persona\",signal=~\"$signal\"}",
          "refId": "A",
          "legendFormat": "{{persona}} · {{signal}}"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    },
    {
      "type": "timeseries",
      "title": "Lane Priorities",
      "gridPos": { "x": 0, "y": 40, "w": 24, "h": 8 },
      "targets": [
        {
          "expr": "arw_persona_lane_priority{persona=~\"$persona\"}",
          "refId": "A",
          "legendFormat": "{{persona}} · {{lane}}"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    },
    {
      "type": "timeseries",
      "title": "Slot Overrides",
      "gridPos": { "x": 0, "y": 48, "w": 24, "h": 8 },
      "targets": [
        {
          "expr": "arw_persona_slot_override{persona=~\"$persona\"}",
          "refId": "A",
          "legendFormat": "{{persona}} · {{slot}}"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    }
  ],
  "templating": {
    "list": [
      {
        "name": "persona",
        "label": "Persona",
        "type": "query",
        "datasource": null,
        "definition": "label_values(arw_persona_signal_strength_avg, persona)",
        "refresh": 2,
        "hide": 0,
        "multi": true,
        "includeAll": true,
        "allValue": ".*",
        "options": [],
        "current": { "text": "All", "value": ".*", "selected": false }
      },
      {
        "name": "signal",
        "label": "Signal",
        "type": "query",
        "datasource": null,
        "definition": "label_values(arw_persona_signal_strength_avg{persona=~\"$persona\"}, signal)",
        "refresh": 2,
        "hide": 0,
        "multi": true,
        "includeAll": true,
        "allValue": ".*",
        "options": [],
        "current": { "text": "All", "value": ".*", "selected": false }
      }
    ]
  },
  "version": 1,
  "schemaVersion": 37
}
